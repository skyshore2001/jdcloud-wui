
jdModule("jdcloud.common",JdcloudCommon);function JdcloudCommon()
{var self=this;self.assert=assert;function assert(cond,dscr)
{if(!cond){var msg="!!! assert fail!";if(dscr)
msg+=" - "+dscr;throw(msg);}}
self.parseQuery=parseQuery;function parseQuery(s)
{var ret={};if(s!="")
{var a=s.split('&')
for(i=0;i<a.length;++i){var a1=a[i].split("=");var val=a1[1];if(val===undefined)
val=1;else if(/^-?[0-9]+$/.test(val)){val=parseInt(val);}
else if(/^-?[0-9.]+$/.test(val)){val=parseFloat(val);}
else{val=decodeURIComponent(val);}
ret[a1[0]]=val;}}
return ret;}
self.tobool=tobool;function tobool(v)
{if(typeof v==="string")
return v!==""&&v!=="0"&&v.toLowerCase()!=="false"&&v.toLowerCase()!=="off";return!!v;}
self.reloadSite=reloadSite;function reloadSite()
{var href=location.href.replace(/#.+/,'#');location.href=href;location.reload();throw"abort";}
function setWidth_2(number)
{return number<10?("0"+number):(""+number);}
Date.prototype.format=function(fmt)
{if(fmt==null)
fmt="L";switch(fmt){case"L":fmt="yyyy-mm-dd HH:MM:SS";break;case"D":fmt="yyyy-mm-dd";break;case"T":fmt="HH:MM:SS";break;}
var year=this.getFullYear();return fmt.replace("yyyy",year).replace("yy",(""+year).substring(2)).replace("mm",setWidth_2(this.getMonth()+1)).replace("dd",setWidth_2(this.getDate())).replace("HH",setWidth_2(this.getHours())).replace("MM",setWidth_2(this.getMinutes())).replace("SS",setWidth_2(this.getSeconds()));}
Date.prototype.addDay=function(iDay)
{this.setDate(this.getDate()+iDay);return this;}
Date.prototype.addHours=function(iHours)
{this.setHours(this.getHours()+iHours);return this;}
Date.prototype.addMin=function(iMin)
{this.setMinutes(this.getMinutes()+iMin);return this;}
Date.prototype.addMonth=function(iMonth)
{this.setMonth(this.getMonth()+iMonth);return this;}
self.parseTime=parseTime;function parseTime(s)
{var a=s.split(":");var dt=new Date(0,0,1,a[0],a[1]||0,a[2]||0);if(isNaN(dt.getYear()))
return null;return dt;}
self.parseDate=parseDate;function parseDate(str)
{if(str==null)
return null;if(str instanceof Date)
return str;if(/Z$/.test(str)){return new Date(str);}
var ms=str.match(/^(\d+)(?:[-\/.](\d+)(?:[-\/.](\d+))?)?/);if(ms==null)
return null;var y,m,d;var now=new Date();if(ms[3]!==undefined){y=parseInt(ms[1]);m=parseInt(ms[2])-1;d=parseInt(ms[3]);if(y<100)
y+=2000;}
else if(ms[2]!==undefined){y=now.getFullYear();m=parseInt(ms[1])-1;d=parseInt(ms[2]);}
else{y=now.getFullYear();m=now.getMonth();d=parseInt(ms[1]);}
var h,n,s;h=0;n=0;s=0;ms=str.match(/(\d+):(\d+)(?::(\d+))?/);if(ms!=null){h=parseInt(ms[1]);n=parseInt(ms[2]);if(ms[3]!==undefined)
s=parseInt(ms[3]);}
var dt=new Date(y,m,d,h,n,s);if(isNaN(dt.getYear()))
return null;ms=str.match(/([+-])(\d{1,4})$/);if(ms!=null){var sign=(ms[1]=="-"?-1:1);var cnt=ms[2].length;var n=parseInt(ms[2].replace(/^0+/,''));if(isNaN(n))
n=0;else if(cnt>2)
n=Math.floor(n/100);var tzOffset=sign*n*60+dt.getTimezoneOffset();if(tzOffset)
dt.addMin(-tzOffset);}
return dt;}
Date.prototype.add=function(sInterval,n)
{switch(sInterval){case'd':this.setDate(this.getDate()+n);break;case'm':this.setMonth(this.getMonth()+n);break;case'y':this.setYear(this.getYear()+n);break;case'h':this.setHours(this.getHours()+n);break;case'n':this.setMinutes(this.getMinutes()+n);break;case's':this.setSeconds(this.getSeconds()+n);break;}
return this;}
Date.prototype.diff=function(sInterval,dtEnd)
{var dtStart=this;switch(sInterval)
{case'd':return Math.round((dtEnd-dtStart)/86400000);case'm':return dtEnd.getMonth()-dtStart.getMonth()+(dtEnd.getFullYear()-dtStart.getFullYear())*12;case'y':return dtEnd.getFullYear()-dtStart.getFullYear();case's':return Math.round((dtEnd-dtStart)/1000);case'n':return Math.round((dtEnd-dtStart)/60000);case'h':return Math.round((dtEnd-dtStart)/3600000);}}
self.getTimeDiffDscr=getTimeDiffDscr;function getTimeDiffDscr(tm,tm1)
{if(!tm||!tm1)
return"";if(!(tm instanceof Date)){tm=parseDate(tm);}
if(!(tm1 instanceof Date)){tm1=parseDate(tm1);}
var diff=(tm1-tm)/1000;if(diff<60){return"刚刚";}
diff/=60;if(diff<60){return Math.floor(diff)+"分钟前";}
diff/=60;if(diff<48){return Math.floor(diff)+"小时前";}
diff/=24;if(diff<365*2)
return Math.floor(diff)+"天前";diff/=365;if(diff<10)
return Math.floor(diff)+"年前";return"很久前";}
self.setCookie=setCookie;function setCookie(name,value,days)
{if(days===undefined)
days=30;if(value==null)
{days=-1;value="";}
var exp=new Date();exp.setTime(exp.getTime()+days*24*60*60*1000);document.cookie=name+"="+escape(value)+";expires="+exp.toGMTString();}
self.getCookie=getCookie;function getCookie(name)
{var m=document.cookie.match(new RegExp("(^| )"+name+"=([^;]*)(;|$)"));if(m!=null){return(unescape(m[2]));}else{return null;}}
self.delCookie=delCookie;function delCookie(name)
{if(getCookie(name)!=null){setCookie(name,null,-1);}}
self.setStorage=setStorage;function setStorage(name,value,useSession)
{assert(typeof value!="object","value must be scalar!");if(window.localStorage==null)
{setCookie(name,value);return;}
if(useSession)
sessionStorage.setItem(name,value);else
localStorage.setItem(name,value);}
self.getStorage=getStorage;function getStorage(name,useSession)
{if(window.localStorage==null)
{getCookie(name);return;}
var rv;if(useSession)
rv=sessionStorage.getItem(name);else
rv=localStorage.getItem(name);if(rv==null)
return getCookie(name);return rv;}
self.delStorage=delStorage;function delStorage(name,useSession)
{if(window.localStorage==null)
{delCookie(name);return;}
if(useSession)
sessionStorage.removeItem(name);else
localStorage.removeItem(name);delCookie(name);}
self.rs2Array=rs2Array;function rs2Array(rs)
{var ret=[];var colCnt=rs.h.length;for(var i=0;i<rs.d.length;++i){var obj={};var row=rs.d[i];for(var j=0;j<colCnt;++j){obj[rs.h[j]]=row[j];}
ret.push(obj);}
return ret;}
self.rs2Hash=rs2Hash;function rs2Hash(rs,key)
{var ret={};var colCnt=rs.h.length;for(var i=0;i<rs.d.length;++i){var obj={};var row=rs.d[i];for(var j=0;j<colCnt;++j){obj[rs.h[j]]=row[j];}
ret[obj[key]]=obj;}
return ret;}
self.rs2MultiHash=rs2MultiHash;function rs2MultiHash(rs,key)
{var ret={};var colCnt=rs.h.length;for(var i=0;i<rs.d.length;++i){var obj={};var row=rs.d[i];for(var j=0;j<colCnt;++j){obj[rs.h[j]]=row[j];}
if(ret[obj[key]]===undefined)
ret[obj[key]]=[];ret[obj[key]].push(obj);}
return ret;}
self.intSort=intSort;function intSort(a,b)
{return parseInt(a)-parseInt(b);}
self.numberSort=numberSort;function numberSort(a,b)
{return parseFloat(a)-parseFloat(b);}
self.getAncestor=getAncestor;function getAncestor(o,fn)
{while(o){if(fn(o))
return o;o=o.parentElement;}
return o;}
self.appendParam=appendParam;function appendParam(url,param)
{if(param==null)
return url;return url+(url.indexOf('?')>0?"&":"?")+param;}
self.isWeixin=isWeixin;function isWeixin()
{return/micromessenger/i.test(navigator.userAgent);}
self.isIOS=isIOS;function isIOS()
{return/iPhone|iPad/i.test(navigator.userAgent);}
self.isAndroid=isAndroid;function isAndroid()
{return/Android/i.test(navigator.userAgent);}
self.parseValue=parseValue;function parseValue(str)
{if(str==null)
return str;var val=str;if(/^-?[0-9]+$/.test(str)){val=parseInt(str);}
if(/^-?[0-9.]+$/.test(str)){val=parseFloat(str);}
return val;}
self.applyTpl=applyTpl;function applyTpl(tpl,data)
{return tpl.replace(/{(\w+)}/g,function(m0,m1){return data[m1];});}
self.delayDo=delayDo;function delayDo(fn,delayCnt)
{if(delayCnt==null)
delayCnt=3;doIt();function doIt()
{if(delayCnt==0)
{fn();return;}
--delayCnt;setTimeout(doIt);}}
function initModule()
{if(String.prototype.startsWith==null){String.prototype.startsWith=function(s){return this.substr(0,s.length)==s;}}
if(window.console===undefined){window.console={log:function(){}}}}
initModule();}
function jdModule(name,fn,overrideCtor)
{if(!window.jdModuleMap){window.jdModuleMap={};}
if(name==null){return window.jdModuleMap;}
var ret;if(fn instanceof Function){if(window.jdModuleMap[name]){fn.call(window.jdModuleMap[name]);}
else{window.jdModuleMap[name]=new fn();}
ret=window.jdModuleMap[name];if(overrideCtor)
ret.constructor=fn;}
else{ret=window.jdModuleMap[name];if(!ret){throw"load module fails: "+name;}}
return ret;}
jdModule("jdcloud.common",JdcloudCommonJq);function JdcloudCommonJq()
{var self=this;self.assert(window.jQuery,"require jquery lib.");self.getFormData=getFormData;function getFormData(jo)
{var data={};var orgData=jo.data("origin_")||{};jo.find("[name]:not([disabled])").each(function(){var ji=$(this);var name=ji.attr("name");var content;if(ji.is(":input"))
content=ji.val();else
content=ji.html();var orgContent=orgData[name];if(orgContent==null)
orgContent="";if(content==null)
content="";if(content!==String(orgContent))
data[name]=content;});return data;}
self.setFormData=setFormData;function setFormData(jo,data,opt)
{var opt1=$.extend({setOrigin:false},opt);if(data==null)
data={};var jo1=jo.filter("[name]:not([noReset])");jo.find("[name]:not([noReset])").add(jo1).each(function(){var ji=$(this);var name=ji.attr("name");var content=data[name];var isInput=ji.is(":input");if(content===undefined){if(isInput){if(ji[0].tagName==="TEXTAREA")
content=ji.html();else
content=ji.attr("value");if(content===undefined)
content="";}
else{content="";}}
if(ji.is(":input")){ji.val(content);}
else{ji.html(content);}});jo.data("origin_",opt1.setOrigin?data:null);}
self.loadScript=loadScript;function loadScript(url,fnOK,options)
{if($.isPlainObject(fnOK)){options=fnOK;fnOK=null;}
if(options){var ajaxOpt=$.extend({dataType:"script",cache:true,success:fnOK,url:url,error:function(xhr,textStatus,err){console.log("*** loadScript fails for "+url);console.log(err);}},options);return jQuery.ajax(ajaxOpt);}
var dfd_=$.Deferred();var script=document.createElement('script');script.type='text/javascript';script.src=url;script.onload=function(){if(fnOK)
fnOK();dfd_.resolve();}
script.onerror=function(){dfd_.reject();console.log("*** loadScript fails for "+url);}
document.head.appendChild(script);return dfd_;}
self.setDateBox=setDateBox;function setDateBox(jo,defDateFn)
{jo.blur(function(){var dt=self.parseDate(this.value);if(dt==null){if(defDateFn)
dt=defDateFn();else
dt=new Date();}
this.value=dt.format("D");});}
self.setTimeBox=setTimeBox;function setTimeBox(jo,defTimeFn)
{jo.blur(function(){var dt=self.parseTime(this.value);if(dt==null){if(defTimeFn)
dt=defTimeFn();else
dt=new Date();}
this.value=dt.format("HH:MM");});}
self.waitFor=waitFor;function waitFor(dfd)
{if(waitFor.caller==null)
throw"waitFor MUST be called in function!";if(dfd.state()=="resolved")
return false;if(!dfd.isset_)
{var caller=waitFor.caller;var args=caller.arguments;dfd.isset_=true;dfd.then(function(){caller.apply(this,args);});}
return true;}
$.fn.jdata=function(val){if(val!=null){this.data("jdata",val);return val;}
var jd=this.data("jdata");if(jd==null)
jd=this.jdata({});return jd;}}
function JdcloudApp()
{var self=this;self.ctx=self.ctx||{};window.E_AUTHFAIL=-1;window.E_NOAUTH=2;window.E_ABORT=-100;self.evalAttr=evalAttr;function evalAttr(jo,name,ctx)
{var val=jo.attr(name);if(val){if(val[0]!='{'&&val.indexOf(":")>0){val1="({"+val+"})";}
else{val1="("+val+")";}
try{val=eval(val1);}
catch(ex){self.app_alert("属性`"+name+"'格式错误: "+val,"e");val=null;}}
return val;}
self.ctx.fixPageCss=fixPageCss;function fixPageCss(css,selector)
{var prefix=selector+" ";var level=1;var css1=css.replace(/\/\*(.|\s)*?\*\//g,'').replace(/([^{}]*)([{}])/g,function(ms,text,brace){if(brace=='}'){--level;return ms;}
if(brace=='{'&&level++!=1)
return ms;return ms.replace(/((?:^|,)\s*)([^,{}]+)/g,function(ms,ms1,sel){if(sel.startsWith(prefix)||sel[0]=='@')
return ms;return ms1+prefix+sel;});});return css1;}
self.app_abort=app_abort;function app_abort()
{throw new DirectReturn();}
window.DirectReturn=function(){}
self.setOnError=setOnError;function setOnError()
{var fn=window.onerror;window.onerror=function(msg,script,line,col,errObj){if(fn&&fn.apply(this,arguments)===true)
return true;if(errObj instanceof DirectReturn||/abort$/.test(msg)||(!script&&!line))
return true;debugger;var content=msg+" ("+script+":"+line+":"+col+")";if(errObj&&errObj.stack)
content+="\n"+errObj.stack.toString();if(self.syslog)
self.syslog("fw","ERR",content);}}
setOnError();}
function JdcloudCall()
{var self=this;var mCommon=jdModule("jdcloud.common");self.lastError=null;var m_tmBusy;var m_manualBusy=0;var m_jLoader;var m_appVer;self.disableBatch=false;var m_curBatch=null;self.m_curBatch=m_curBatch;self.mockData={};var ajaxOpt={beforeSend:function(xhr){this.xhr_=xhr;},dataFilter:function(data,type){if(this.jdFilter!==false&&(type=="json"||type=="text")){rv=defDataProc.call(this,data);if(rv!=null)
return rv;--$.active;self.app_abort();}
return data;},converters:{"text json":true},error:defAjaxErrProc};if(location.protocol=="file:"){ajaxOpt.xhrFields={withCredentials:true};}
$.ajaxSetup(ajaxOpt);self.enterWaiting=enterWaiting;function enterWaiting(ctx)
{if(self.isBusy==0){m_tmBusy=new Date();}
self.isBusy=1;if(ctx==null||ctx.isMock)
++m_manualBusy;if(!(ctx&&ctx.noLoadingImg))
{setTimeout(function(){if(self.isBusy)
self.showLoading();},200);}}
self.leaveWaiting=leaveWaiting;function leaveWaiting(ctx)
{if(ctx==null||ctx.isMock)
{if(--m_manualBusy<0)
m_manualBusy=0;}
mCommon.delayDo(function(){if(self.options.logAction&&ctx&&ctx.ac&&ctx.tv){var tv2=(new Date()-ctx.tm)-ctx.tv;ctx.tv2=tv2;console.log(ctx);}
if($.active==0&&self.isBusy&&m_manualBusy==0){self.isBusy=0;var tv=new Date()-m_tmBusy;m_tmBusy=0;console.log("idle after "+tv+"ms");self.hideLoading();}});}
function defAjaxErrProc(xhr,textStatus,e)
{var ctx=this.ctx_||{};ctx.status=xhr.status;ctx.statusText=xhr.statusText;if(xhr.status==0){self.app_alert("连不上服务器了，是不是网络连接不给力？","e");}
else if(this.handleHttpError){var data=xhr.responseText;var rv=defDataProc.call(this,data);if(rv!=null)
this.success&&this.success(rv);return;}
else{self.app_alert("操作失败: 服务器错误. status="+xhr.status+"-"+xhr.statusText,"e");}
leaveWaiting(ctx);}
self.defDataProc=defDataProc;function defDataProc(rv)
{var ctx=this.ctx_||{};var ext=ctx.ext;if(this.xhr_&&ext==null){var val=this.xhr_.getResponseHeader("X-Daca-Server-Rev");if(val&&g_data.serverRev!=val){if(g_data.serverRev){mCommon.reloadSite();}
console.log("Server Revision: "+val);g_data.serverRev=val;}
val=mCommon.parseValue(this.xhr_.getResponseHeader("X-Daca-Test-Mode"));if(g_data.testMode!=val){g_data.testMode=val;if(g_data.testMode)
alert("测试模式!");}
val=mCommon.parseValue(this.xhr_.getResponseHeader("X-Daca-Mock-Mode"));if(g_data.mockMode!=val){g_data.mockMode=val;if(g_data.mockMode)
alert("模拟模式!");}}
try{if(rv!==""&&typeof(rv)=="string")
rv=$.parseJSON(rv);}
catch(e)
{leaveWaiting(ctx);self.app_alert("服务器数据错误。");return;}
if(ctx.tm){ctx.tv=new Date()-ctx.tm;}
ctx.ret=rv;leaveWaiting(ctx);if(ext){var filter=self.callSvrExt[ext]&&self.callSvrExt[ext].dataFilter;if(filter){var ret=filter.call(this,rv);if(ret==null||ret===false)
self.lastError=ctx;return ret;}}
if(rv&&$.isArray(rv)&&rv.length>=2&&typeof rv[0]=="number"){if(rv[0]==0)
return rv[1];if(this.noex)
{this.lastError=rv;self.lastError=ctx;return false;}
if(rv[0]==E_NOAUTH){if(self.tryAutoLogin()){$.ajax(this);}
return;}
else if(rv[0]==E_AUTHFAIL){self.app_alert("验证失败，请检查输入是否正确!","e");return;}
else if(rv[0]==E_ABORT){console.log("!!! abort call");return;}
logError();self.app_alert("操作失败："+rv[1],"e");}
else{logError();self.app_alert("服务器通讯协议异常!","e");}
function logError()
{self.lastError=ctx;console.log("failed call");console.log(ctx);}}
self.getBaseUrl=getBaseUrl;function getBaseUrl()
{return self.options.serverUrl.replace(/\/[^\/]+$/,'/');}
self.makeUrl=makeUrl;function makeUrl(action,params)
{var ext;if($.isArray(action)){if(window.MUI){ext=action[1];action=action[0];}
else{ext="default";action=action[0]+"."+action[1];}}
else{var m=action.match(/^(\w+):(\w.*)/);if(m){ext=m[1];action=m[2];}
else{ext="default";}}
if(action.makeUrl||/^http/.test(action)){if(params==null)
return action;var url=mCommon.appendParam(action,$.param(params));return makeUrlObj(url);}
if(params==null)
params={};var url;var fnMakeUrl=self.callSvrExt[ext]&&self.callSvrExt[ext].makeUrl;if(fnMakeUrl){url=fnMakeUrl(action,params);}
else if(action.indexOf(".php")<0)
{var opt=self.options;var usePathInfo=!opt.serverUrlAc;if(usePathInfo){if(opt.serverUrl.slice(-1)=='/')
url=opt.serverUrl+action;else
url=opt.serverUrl+"/"+action;}
else{url=opt.serverUrl;params[opt.serverUrlAc]=action;}}
else{if(location.protocol=="file:"){url=getBaseUrl()+action;}
else
url=action;}
if(window.g_cordova){if(m_appVer===undefined)
{var platform="n";if(isAndroid()){platform="a";}
else if(isIOS()){platform="i";}
m_appVer=platform+"/"+g_cordova;}
params._ver=m_appVer;}
if(self.options.appName)
params._app=self.options.appName;if(g_args._debug)
params._debug=g_args._debug;var ret=mCommon.appendParam(url,$.param(params));return makeUrlObj(ret);function makeUrlObj(url)
{var o=new String(url);o.makeUrl=true;if(action.makeUrl){o.action=action.action;o.params=$.extend({},action.params,params);}
else{o.action=action;o.params=params;}
return o;}}
self.callSvr=callSvr;self.callSvrExt={};function callSvr(ac,params,fn,postParams,userOptions)
{if(params instanceof Function){userOptions=postParams;postParams=fn;fn=params;params=null;}
mCommon.assert(ac!=null,"*** bad param `ac`");var ext=null;var ac0=ac.action||ac;var m;if($.isArray(ac)){mCommon.assert(ac.length==2,"*** bad ac format, require [ac, ext]");ext=ac[1];if(ext!='default')
ac0=ext+':'+ac[0];else
ac0=ac[0];}
else if(m=ac.match(/^(\w+):(\w.*)/)){ext=m[1];}
else if(self.callSvrExt['default']){ext='default';}
var isSyncCall=(userOptions&&userOptions.async==false);if(m_curBatch&&!isSyncCall)
{return m_curBatch.addCall({ac:ac,get:params,post:postParams},fn,userOptions);}
var url=makeUrl(ac,params);var ctx={ac:ac0,tm:new Date()};if(userOptions&&userOptions.noLoadingImg)
ctx.noLoadingImg=1;if(ext){ctx.ext=ext;}
if(self.mockData&&self.mockData[ac0]){ctx.isMock=true;ctx.getMockData=function(){var d=self.mockData[ac0];var param1=$.extend({},url.params);var postParam1=$.extend({},postParams);if($.isFunction(d)){d=d(param1,postParam1);}
if(self.options.logAction)
console.log({ac:ac0,ret:d,params:param1,postParams:postParam1,userOptions:userOptions});return d;}}
enterWaiting(ctx);var callType="call";if(isSyncCall)
callType+="-sync";if(ctx.isMock)
callType+="-mock";var method=(postParams==null?'GET':'POST');var opt={dataType:'text',url:url,data:postParams,type:method,success:fn,ctx_:ctx};if(ext){opt.xhrFields={withCredentials:true};}
if(window.FormData&&postParams instanceof FormData){opt.processData=false;opt.contentType=false;}
$.extend(opt,userOptions);if(ext&&self.callSvrExt[ext].beforeSend){self.callSvrExt[ext].beforeSend(opt);}
console.log(callType+": "+opt.type+" "+ac0);if(ctx.isMock)
return callSvrMock(opt,isSyncCall);return $.ajax(opt);}
function callSvrMock(opt,isSyncCall)
{var dfd_=$.Deferred();var opt_=opt;if(isSyncCall){callSvrMock1();}
else{setTimeout(callSvrMock1,self.options.mockDelay);}
return dfd_;function callSvrMock1()
{var data=opt_.ctx_.getMockData();if(typeof(data)!="string")
data=JSON.stringify(data);var rv=defDataProc.call(opt_,data);if(rv!=null)
{opt_.success&&opt_.success(rv);dfd_.resolve(rv);return;}
self.app_abort();}}
self.callSvrSync=callSvrSync;function callSvrSync(ac,params,fn,postParams,userOptions)
{var ret;if(params instanceof Function){userOptions=postParams;postParams=fn;fn=params;params=null;}
userOptions=$.extend({async:false},userOptions);var dfd=callSvr(ac,params,fn,postParams,userOptions);dfd.then(function(data){ret=data;});return ret;}
self.setupCallSvrViaForm=setupCallSvrViaForm;function setupCallSvrViaForm($form,$iframe,url,fn,callOpt)
{$form.attr("action",url);$iframe.on("load",function(){var data=this.contentDocument.body.innerText;if(data=="")
return;var rv=defDataProc.call(callOpt,data);if(rv==null)
self.app_abort();fn(rv);});}
self.batchCall=batchCall;function batchCall(opt)
{mCommon.assert(m_curBatch==null,"*** multiple batch call!");this.opt_=opt;this.calls_=[];this.callOpts_=[];if(!self.disableBatch)
m_curBatch=this;}
batchCall.prototype={addCall:function(call0,fn,opt0){var call=$.extend({},call0);var opt=$.extend({},opt0);if(opt.ref){call.ref=opt.ref;}
this.calls_.push(call);var callOpt={fn:fn,opt:opt,dfd:$.Deferred()};this.callOpts_.push(callOpt);return callOpt.dfd;},deferred:function(){return this.dfd_;},commit:function(){if(m_curBatch==null)
return;m_curBatch=null;if(this.calls_.length<=1){console.log("!!! warning: batch has "+this.calls_.length+" calls!");}
var batch_=this;var postData=JSON.stringify(this.calls_);callSvr("batch",this.opt_,api_batch,postData,{contentType:"application/json"});function api_batch(data)
{var ajaxCtx_=this;$.each(data,function(i,e){var callOpt=batch_.callOpts_[i];var extendCtx=false;if(callOpt.opt&&!$.isEmptyObject(callOpt.opt)){extendCtx=true;$.extend(ajaxCtx_,callOpt.opt);}
var data1=defDataProc.call(ajaxCtx_,e);if(data1!=null){if(callOpt.fn){callOpt.fn.call(ajaxCtx_,data1);}
callOpt.dfd.resolve(data1);}
if(extendCtx){$.each(Object.keys(callOpt.opt),function(){ajaxCtx_[this]=null;});}});}},cancel:function(){m_curBatch=null;}}
self.useBatchCall=useBatchCall;function useBatchCall(opt,tv)
{if(self.disableBatch)
return;if(m_curBatch!=null)
return;tv=tv||0;var batch=new MUI.batchCall(opt);setTimeout(function(){batch.commit();},tv);}}
function JdcloudPage()
{var self=this;self.ctx=self.ctx||{};var mCommon=jdModule("jdcloud.common");mCommon.assert($.fn.combobox,"require jquery-easyui lib.");function add_(o)
{var ret={};for(var k in o){if(k.indexOf("__")<0)
ret[k]=o[k];}
return ret;}
function getRow(jtbl)
{var row=jtbl.datagrid('getSelected');if(!row)
{self.app_alert("请先选择一行。","w");return null;}
return row;}
self.reload=reload;function reload(jtbl,url,queryParams)
{if(url!=null||queryParams!=null){var opt=jtbl.datagrid("options");if(url!=null){opt.url=url;}
if(queryParams!=null){opt.queryParams=queryParams;}}
if(jtbl.is(":hidden")){var opage=mCommon.getAncestor(jtbl[0],istab);if(opage&&opage.title)
$(opage).closest(".easyui-tabs").tabs("select",opage.title);}
resetPageNumber(jtbl);jtbl.datagrid('reload');jtbl.datagrid('clearSelections');}
self.reloadTmp=reloadTmp;function reloadTmp(jtbl,url,queryParams)
{var opt=jtbl.datagrid("options");var url_bak=opt.url;var param_bak=opt.queryParams;reload(jtbl,url,queryParams);opt.url=url_bak;opt.queryParams=param_bak;}
function jdListToDgList(data)
{var ret=data;if($.isArray(data)){ret={total:data.length,rows:data};}
else if($.isArray(data.list)){ret={total:data.total||data.list.length,rows:data.list};}
else if(data.h!==undefined)
{var arr=mCommon.rs2Array(data);ret={total:data.total||arr.length,rows:arr};}
return ret;}
function jdListToArray(data)
{var ret=data;if($.isArray(data)){ret=data;}
else if($.isArray(data.list)){ret=data.list;}
else if(data.h!==undefined)
{ret=mCommon.rs2Array(data);}
return ret;}
self.reloadRow=reloadRow;function reloadRow(jtbl,rowData)
{jtbl.datagrid("loading");var opt=jtbl.datagrid("options");self.callSvr(opt.url,api_queryOne,{cond:"id="+rowData.id});function api_queryOne(data)
{jtbl.datagrid("loaded");var idx=jtbl.datagrid("getRowIndex",rowData);var objArr=jdListToArray(data);if(idx!=-1&&objArr.length==1){for(var k in rowData)
delete rowData[k];$.extend(rowData,objArr[0]);jtbl.datagrid("refreshRow",idx);}}}
function appendRow(jtbl,id)
{jtbl.datagrid("loading");var opt=jtbl.datagrid("options");self.callSvr(opt.url,api_queryOne,{cond:"id="+id});function api_queryOne(data)
{jtbl.datagrid("loaded");var objArr=jdListToArray(data);if(objArr.length!=1)
return;var row=objArr[0];if(opt.sortOrder=="desc")
jtbl.datagrid("insertRow",{index:0,row:row});else
jtbl.datagrid("appendRow",row);}}
function tabid(title)
{return"pg_"+title.replace(/[ ()\[\]]/g,"_");}
function istab(o)
{var id=o.getAttribute("id");return id&&id.substr(0,3)=="pg_";}
function callInitfn(jo,paramArr)
{if(jo.jdata().init)
return;var attr=jo.attr("my-initfn");if(attr==null)
return;try{initfn=eval(attr);}
catch(e){self.app_alert("bad initfn: "+attr,"e");}
if(initfn)
{initfn.apply(jo,paramArr||[]);}
jo.jdata().init=true;}
function getModulePath(file)
{return self.options.pageFolder+"/"+file;}
self.showPage=showPage;function showPage(pageName,title,paramArr)
{var sel="#my-pages > div."+pageName;var jpage=$(sel);if(jpage.length>0){initPage();}
else{var pageFile=getModulePath(pageName+".html");$.ajax(pageFile).then(function(html){loadPage(html,pageName,pageFile);}).fail(function(){});}
function initPage()
{if(title==null)
title=$(sel).attr("title")||"无标题";var tt=self.tabMain;if(tt.tabs('exists',title)){tt.tabs('select',title);return;}
var id=tabid(title);var content="<div id='"+id+"' title='"+title+"' />";var closable=(pageName!=self.options.pageHome);tt.tabs('add',{title:title,closable:closable,fit:true,content:content});var jtab=$("#"+id);var jpageNew=jpage.clone().appendTo(jtab);jpageNew.addClass('wui-page');jpageNew.attr("wui-pageName",pageName);callInitfn(jpageNew,paramArr);jpageNew.trigger('pagecreate');jpageNew.trigger('pageshow');}
function loadPage(html,pageClass,pageFile)
{var jcontainer=$("#my-pages");jpage=$(html).filter("div");if(jpage.size()>1||jpage.size()==0){console.log("!!! Warning: bad format for page '"+pageClass+"'. Element count = "+jpage.size());jpage=jpage.filter(":first");}
jpage.find("style").each(function(){$(this).html(self.ctx.fixPageCss($(this).html(),"."+pageClass));});jpage.find("style").attr("wui-origin",pageClass).appendTo(document.head);jpage.attr("wui-pageFile",pageFile);jpage.addClass(pageClass).appendTo(jcontainer);var val=jpage.attr("wui-script");if(val!=null){var path=getModulePath(val);var dfd=mCommon.loadScript(path,initPage);dfd.fail(function(){self.app_alert("加载失败: "+val);self.leaveWaiting();});}
else{initPage();}}}
self.closeDlg=closeDlg;function closeDlg(jdlg)
{jdlg.dialog("close");}
function openDlg(jdlg)
{jdlg.dialog("open");}
function focusDlg(jdlg)
{var jo;jdlg.find(":input[type!=hidden]").each(function(i,o){var jo1=$(o);if(!jo1.prop("disabled")&&!jo1.prop("readonly")){jo=jo1;return false;}});if(jo==null)
jo=jdlg.find("a button");if(jo)
setTimeout(function(){jo.focus()},50);}
$.fn.okCancel=function(fnOk,fnCancel){this.unbind("keydown").keydown(function(e){if(e.keyCode==13&&e.target.tagName!="TEXTAREA"&&fnOk){fnOk();return false;}
else if(e.keyCode==27&&fnCancel){fnCancel();return false;}
else if(e.ctrlKey&&e.which==70)
{showObjDlg($(this),FormMode.forFind,null);return false;}});}
self.showDlg=showDlg;function showDlg(jdlg,opt)
{if(jdlg.constructor!=jQuery)
jdlg=$(jdlg);if(loadDialog(jdlg,onLoad))
return;function onLoad(){showDlg(jdlg,opt);}
opt=$.extend({okLabel:"确定",cancelLabel:"取消",noCancel:false,modal:true,reset:true,validate:true},opt);var btns=[{text:opt.okLabel,iconCls:'icon-ok',handler:fnOk}];if(!opt.noCancel)
btns.push({text:opt.cancelLabel,iconCls:'icon-cancel',handler:fnCancel})
if($.isArray(opt.buttons))
btns.push.apply(btns,opt.buttons);jdlg.addClass('wui-dialog');callInitfn(jdlg);var jfrm=jdlg.find("Form");var formMode=jdlg.jdata().mode;jfrm.trigger("beforeshow",[formMode]);var dlgOpt={maximizable:true,collapsible:true,resizable:true,left:null,top:null,closable:!opt.noCancel,modal:opt.modal,buttons:btns};if(jdlg.is(":visible")){dlgOpt0=jdlg.dialog("options");$.extend(dlgOpt,{left:dlgOpt0.left,top:dlgOpt0.top});}
jdlg.dialog(dlgOpt);jdlg.find(".my-combobox").mycombobox();jdlg.okCancel(fnOk,opt.noCancel?undefined:fnCancel);if(opt.reset)
{jfrm.form("reset");jfrm.find("[type=hidden]:not([noReset])").val("");jfrm.find(".my-reset").empty();}
if(opt.data)
{jfrm.trigger("initdata",[opt.data,formMode]);jfrm.form("load",opt.data);jfrm.trigger("loaddata",[opt.data,formMode]);}
focusDlg(jdlg);jfrm.trigger("show",[formMode]);function fnCancel(){closeDlg(jdlg)}
function fnOk()
{if(opt.url){submitForm();opt.onAfterSubmit&&opt.onAfterSubmit(jfrm);function submitForm()
{var ret=opt.validate?jfrm.form("validate"):true;if(!ret)
return false;var ev=$.Event("savedata");jfrm.trigger(ev,[formMode,opt.data]);if(ev.isDefaultPrevented())
return false;if(opt.onSubmit&&opt.onSubmit(jfrm)===false)
return false;var data=mCommon.getFormData(jfrm);self.callSvr(opt.url,success,data);}
function success(data)
{if(data!=null&&opt.onOk){opt.onOk.call(jdlg,data);jfrm.trigger('retdata',[data,formMode]);}}}
else
opt.onOk&&opt.onOk.call(jdlg);}}
self.getTopDialog=getTopDialog;function getTopDialog()
{var val=0;var jo=$();$(".window:visible").each(function(i,e){var z=parseInt(this.style.zIndex);if(z>val){val=z;jo=$(this).find(".wui-dialog");}});return jo;}
self.unloadPage=unloadPage;function unloadPage(pageName)
{if(pageName==null){pageName=self.getActivePage().attr("wui-pageName");if(pageName==null)
return;self.tabClose();}
var jo=$("."+pageName);if(jo.attr("wui-pageFile")==null)
return;jo.remove();$("style[wui-origin="+pageName+"]").remove();}
self.reloadPage=reloadPage;function reloadPage()
{var pageName=self.getActivePage().attr("wui-pageName");self.unloadPage();self.showPage(pageName);}
self.unloadDialog=unloadDialog;self.reloadDialog=unloadDialog;function unloadDialog()
{var jdlg=getTopDialog();if(jdlg.size()==0)
return;closeDlg(jdlg);if(jdlg.attr("wui-pageFile")==null)
return;var dlgId=jdlg.attr("id");jdlg.dialog("destroy");$("style[wui-origin="+dlgId+"]").remove();}
var BTN_TEXT=["添加","保存","保存","查找","删除"];function getop(v)
{if(typeof(v)=="number")
return"="+v;var op="=";var is_like=false;if(v.match(/^(<>|>=?|<=?)/)){op=RegExp.$1;v=v.substr(op.length);}
else if(v.indexOf("*")>=0||v.indexOf("%")>=0){v=v.replace(/[*]/g,"%");op=" like ";}
v=$.trim(v);if(v==="null")
{if(op=="<>")
return" is not null";return" is null";}
if(v==="empty")
v="";if(v.length==0||v.match(/\D/)||v[0]=='0'){v=v.replace(/'/g,"\\'");return op+"'"+v+"'";}
return op+v;}
self.getQueryCond=getQueryCond;function getQueryCond(kvList)
{var condArr=[];if($.isPlainObject(kvList)){$.each(kvList,handleOne);}
else if($.isArray(kvList)){$.each(kvList,function(i,e){handleOne(e[0],e[1]);});}
function handleOne(k,v){if(v==null||v==="")
return;var arr=v.split(/\s+(and|or)\s+/i);var str='';var bracket=false;$.each(arr,function(i,v1){if((i%2)==1){str+=' '+v1.toUpperCase()+' ';bracket=true;return;}
str+=k+getop(v1);});if(bracket)
str='('+str+')';condArr.push(str);}
return condArr.join(' AND ');}
self.getQueryParam=getQueryParam;function getQueryParam(kvList)
{return{cond:getQueryCond(kvList)};}
function getFindData(jfrm)
{var kvList={};var kvList2={};jfrm.find(":input[name]").each(function(i,e){if($(e).attr("notForFind"))
return;var v=$(e).val();if(v==null||v==="")
return;if($(e).attr("my-cond"))
kvList2[e.name]=v;else
kvList[e.name]=v;})
var cond=getQueryParam(kvList);if(kvList2)
$.extend(cond,kvList2);return cond;}
function saveFormFields(jfrm,data)
{jfrm.jdata().init_data=$.extend(true,{},data);}
function checkFormFields(jfrm)
{var jd=jfrm.jdata();jd.no_submit=[];jfrm.find(":input[name]").each(function(i,o){var jo=$(o);var initval=jd.init_data[o.name];if(initval===undefined||initval===null)
initval="";if(jo.prop("disabled")||jo.val()!==String(initval))
return;jo.prop("disabled",true);jd.no_submit.push(jo);});}
function restoreFormFields(jfrm)
{var jd=jfrm.jdata();if(jd.no_submit==null)
return;$.each(jd.no_submit,function(i,jo){jo.prop("disabled",false);})
delete jd.no_submit;}
function loadDialog(jdlg,onLoad)
{if(jdlg.size()>0&&jdlg[0].parentElement!=null&&jdlg[0].parentElement.parentElement!=null)
return;var jo=$(jdlg.selector);if(jo.size()>0){fixJdlg(jo);return;}
function fixJdlg(jo)
{jdlg.splice(0,jdlg.size(),jo[0]);}
var dlgId=jdlg.selector.substr(1);var pageFile="page/"+dlgId+".html";$.ajax(pageFile).then(function(html){var jcontainer=$("#my-pages");var jo=$(html).filter("div");if(jo.size()>1||jo.size()==0){console.log("!!! Warning: bad format for dialog '"+selector+"'. Element count = "+jo.size());jo=jo.filter(":first");}
fixJdlg(jo);jdlg.find("style").each(function(){$(this).html(self.ctx.fixPageCss($(this).html(),selector));});jdlg.find("style").attr("wui-origin",dlgId).appendTo(document.head);jdlg.attr("id",dlgId).appendTo(jcontainer);jdlg.attr("wui-pageFile",pageFile);var val=jdlg.attr("wui-script");if(val!=null){var path=getModulePath(val);var dfd=mCommon.loadScript(path,onLoad);dfd.fail(function(){self.app_alert("加载失败: "+val);});}
else{onLoad();}}).fail(function(){});return true;}
self.showObjDlg=showObjDlg;function showObjDlg(jdlg,mode,opt)
{opt=opt||{};if(jdlg.constructor!=jQuery)
jdlg=$(jdlg);if(loadDialog(jdlg,onLoad))
return;function onLoad(){showObjDlg(jdlg,mode,opt);}
if(opt.jtbl){jdlg.jdata().jtbl=opt.jtbl;}
var id=opt.id;var obj=jdlg.attr("my-obj");mCommon.assert(obj);var jd=jdlg.jdata();var jd2=jd.jtbl&&jd.jtbl.jdata();var rowData;if(id==null){mCommon.assert(mode!=FormMode.forLink);if(mode==FormMode.forSet||mode==FormMode.forDel)
{mCommon.assert(jd.jtbl);rowData=getRow(jd.jtbl);if(rowData==null)
return;id=rowData.id;}}
var url;if(mode==FormMode.forAdd){url=self.makeUrl([obj,"add"],jd.url_param);if(jd.jtbl)
jd.jtbl.datagrid("clearSelections");}
else if(mode==FormMode.forSet||mode==FormMode.forLink){url=self.makeUrl([obj,"set"],{id:id});}
else if(mode==FormMode.forDel){self.app_confirm("确定要删除一条记录?",function(b){if(!b)
return;var ac=obj+".del";self.callSvr(ac,{id:id},function(data){if(jd.jtbl)
reload(jd.jtbl);self.app_show('删除成功!');});});return;}
callInitfn(jdlg);var jfrm=jdlg.find("Form");var doReset=!(jd.mode==FormMode.forFind&&mode==FormMode.forFind)
if(mode==FormMode.forFind&&jd.mode!=FormMode.forFind){jfrm.find(":input[name]").each(function(i,e){var je=$(e);je.jdata().bak={bgcolor:je.css("backgroundColor"),disabled:je.prop("disabled")}
if(je.attr("notforFind")){je.prop("disabled",true);je.css("backgroundColor","");}
else{je.prop("disabled",false);je.css("backgroundColor","#ffff00");}})}
else if(jd.mode==FormMode.forFind&&mode!=FormMode.forFind){jfrm.find(":input[name]").each(function(i,e){var je=$(e);var bak=je.jdata().bak;je.prop("disabled",bak.disabled);je.css("backgroundColor",bak.bgcolor);})}
jd.mode=mode;var load_data;if(mode==FormMode.forAdd){var init_data=jd.init_data||(jd2&&jd2.init_data);if(init_data)
load_data=add_(init_data);else
load_data={};}
else if(mode==FormMode.forSet&&rowData){load_data=add_(rowData);saveFormFields(jfrm,load_data);}
else if(mode==FormMode.forLink||mode==FormMode.forSet){var load_url=self.makeUrl([obj,'get'],{id:id});var data=self.callSvrSync(load_url);if(data==null)
return;load_data=add_(data);saveFormFields(jfrm,load_data);}
showDlg(jdlg,{url:url,okLabel:BTN_TEXT[mode],validate:mode!=FormMode.forFind,modal:false,reset:doReset,data:load_data,onOk:onOk,onSubmit:(mode==FormMode.forSet||mode==FormMode.forLink)&&checkFormFields,onAfterSubmit:(mode==FormMode.forSet||mode==FormMode.forLink)&&restoreFormFields});if(mode==FormMode.forSet||mode==FormMode.forLink)
jfrm.form("validate");function onOk(retData){if(mode==FormMode.forFind){var param=getFindData(jfrm);if(!$.isEmptyObject(param)){mCommon.assert(jd.jtbl);reload(jd.jtbl,undefined,param);}
else{self.app_alert("请输入查询条件!","w");}
return;}
if(mode!=FormMode.forLink&&jd.jtbl){if(mode==FormMode.forSet&&rowData)
reloadRow(jd.jtbl,rowData);else if(mode==FormMode.forAdd){appendRow(jd.jtbl,retData);}
else
reload(jd.jtbl);}
if(mode==FormMode.forAdd)
{showObjDlg(jdlg,mode);}
else
{closeDlg(jdlg);}
self.app_show('操作成功!');}}
self.dg_toolbar=dg_toolbar;function dg_toolbar(jtbl,jdlg)
{var toolbar=jtbl.jdata().toolbar||"rfasd";var btns=[];var tb={r:{text:'刷新',iconCls:'icon-reload',handler:function(){reload(jtbl);}},f:{text:'查询',iconCls:'icon-search',handler:function(){showObjDlg(jdlg,FormMode.forFind,{jtbl:jtbl});}},a:{text:'新增',iconCls:'icon-add',handler:function(){showObjDlg(jdlg,FormMode.forAdd,{jtbl:jtbl});}},s:{text:'修改',iconCls:'icon-edit',handler:function(){showObjDlg(jdlg,FormMode.forSet,{jtbl:jtbl});}},d:{text:'删除',iconCls:'icon-remove',handler:function(){showObjDlg(jdlg,FormMode.forDel,{jtbl:jtbl});}}};$.each(toolbar.split(""),function(i,e){if(tb[e]){btns.push(tb[e]);btns.push("-");}});for(var i=2;i<arguments.length;++i)
btns.push(arguments[i]);return btns;}
self.dg_dblclick=function(jtbl,jdlg)
{return function(idx,data){jtbl.datagrid("selectRow",idx);showObjDlg(jdlg,FormMode.forSet,{jtbl:jtbl});}}
function link_onclick()
{var href=$(this).attr("href");if(href.search(/^#(page\w+)$/)>=0){var pageName=RegExp.$1;WUI.showPage.call(this,pageName);return false;}
else if(href.search(/^\?(\w+)$/)>=0){var fn=RegExp.$1;fn=eval(fn);if(fn)
fn.call(this);return false;}
return true;}
$.extend($.fn.combobox.defaults,{valueField:'val',textField:'text'});function dgLoader(param,success,error)
{var jo=$(this);var opts=jo.datagrid("options");if(opts.data){return defaultDgLoader.apply(this,arguments);}
var param1={};for(var k in param){if(k==="sort"){param1.orderby=param.sort+" "+param.order;}
else if(k==="order"){}
else{param1[k]=param[k];}}
self.callSvr(opts.url,param1,success);}
function dgLoadFilter(data)
{var ret=jdListToDgList(data);var isOnePage=(ret.total==ret.rows.length);$(this).datagrid("getPager").toggle(!(isOnePage&&ret.total<=5));$(this).datagrid("options").remoteSort=(!isOnePage);return ret;}
function resetPageNumber(jtbl)
{var opt=jtbl.datagrid('options');if(opt.pagination&&opt.pageNumber)
{opt.pageNumber=1;var jpager=jtbl.datagrid("getPager");jpager.pagination("refresh",{pageNumber:opt.pageNumber});}}
var defaultDgLoader=$.fn.datagrid.defaults.loader;$.extend($.fn.datagrid.defaults,{rownumbers:true,singleSelect:true,pagination:true,pageSize:20,pageList:[20,30,50],loadFilter:dgLoadFilter,loader:dgLoader,onLoadError:self.ctx.defAjaxErrProc,onBeforeSortColumn:function(sort,order){var jtbl=$(this);resetPageNumber(jtbl);},onLoadSuccess:function(data){$(this).datagrid("fitColumns");}});var DefaultValidateRules={number:{validator:function(v){return v.length==0||/^[0-9.-]+$/.test(v);},message:'必须为数字!'},uname:{validator:function(v){return v.length==0||(v.length>=4&&v.length<=16&&/^[a-z]\w+$/i.test(v));},message:"4-16位英文字母或数字，以字母开头，不能出现符号."},pwd:{validator:function(v){return v.length==0||(v.length>=4&&v.length<=16)||v.length==32;},message:"4-16位字母、数字或符号."},equalTo:{validator:function(v,param){return v.length==0||v==$(param[0]).val();},message:"两次输入不一致."},cellphone:{validator:function(v){return v.length==0||(v.length==11&&!/\D/.test(v));},message:"手机号为11位数字"},datetime:{validator:function(v){return v.length==0||/\d{4}-\d{1,2}-\d{1,2}( \d{1,2}:\d{1,2}(:\d{1,2})?)?/.test(v);},message:"格式为\"年-月-日 时:分:秒\"，时间部分可忽略"},usercode:{validator:function(v){return v.length==0||/^[a-zA-Z]/.test(v)||(v.length==11&&!/\D/.test(v));},message:"11位手机号或客户代码"}};$.extend($.fn.validatebox.defaults.rules,DefaultValidateRules);$(function(){$('.easyui-linkbutton').click(link_onclick);$('[data-type="easyui-linkbutton"]').click(link_onclick);});}
jdModule("jdcloud.wui",JdcloudWui);function JdcloudWui()
{var self=this;var mCommon=jdModule("jdcloud.common");JdcloudApp.call(self);JdcloudCall.call(self);JdcloudPage.call(self);self.isBusy=false;window.g_args={};window.g_data={};window.BASE_URL="../";window.FormMode={forAdd:0,forSet:1,forLink:2,forFind:3,forDel:4};self.options={title:"客户端",appName:"user",onShowLogin:function(){throw"NotImplemented";},pageHome:"pageHome",pageFolder:"page",serverUrl:"./",logAction:false,PAGE_SZ:20,manualSplash:false,mockDelay:50};function parseArgs()
{if(location.search){g_args=mCommon.parseQuery(location.search.substr(1));if(g_args.test||g_args._test){g_args._test=1;alert("测试模式!");}}}
parseArgs();self.app_alert=app_alert;function app_alert(msg,type,fn)
{type=type||"i";var icon={i:"info",w:"warning",e:"error"}[type];var s={i:"提示",w:"警告",e:"出错"}[type];var s1="<b>["+s+"]</b>";$.messager.alert(self.options.title+" - "+s,s1+" "+msg,icon,fn);setTimeout(function(){$(".l-btn").focus();},50);}
self.app_confirm=app_confirm;function app_confirm(msg,fn)
{var s="<div style='font-size:10pt'>"+msg.replace(/\n/g,"<br/>")+"</div>";$.messager.confirm(self.options.title+" - "+"确认",s,fn);}
self.app_show=app_show;function app_show(msg)
{$.messager.show({title:self.options.title,msg:msg});}
self.makeLinkTo=makeLinkTo;function makeLinkTo(dlg,id,text)
{if(text==null)
text=id;return"<a href=\""+dlg+"\" onclick='WUI.showObjDlg(\""+dlg+"\",FormMode.forLink,{id:"+id+"});return false'>"+text+"</a>";}
function tokenName()
{var name="token";if(self.options.appName)
name+="_"+self.options.appName;if(g_args._test)
name+="_test";return name;}
function saveLoginToken(data)
{if(data._token)
{mCommon.setStorage(tokenName(),data._token);}}
function loadLoginToken()
{return mCommon.getStorage(tokenName());}
function deleteLoginToken()
{mCommon.delStorage(tokenName());}
self.tryAutoLogin=tryAutoLogin;function tryAutoLogin(onHandleLogin,reuseCmd)
{var ok=false;var ajaxOpt={async:false,noex:true};function handleAutoLogin(data)
{if(data===false)
return;if(onHandleLogin)
onHandleLogin.call(this,data);ok=true;}
if(reuseCmd!=null){self.callSvr(reuseCmd,handleAutoLogin,null,ajaxOpt);}
if(ok)
return ok;var token=loadLoginToken();if(token!=null)
{var postData={token:token};self.callSvr("login",handleAutoLogin,postData,ajaxOpt);}
if(ok)
return ok;self.options.onShowLogin();return ok;}
self.handleLogin=handleLogin;function handleLogin(data)
{g_data.userInfo=data;if(g_args.autoLogin||/android|ipad|iphone/i.test(navigator.userAgent))
saveLoginToken(data);self.showPage(self.options.pageHome);}
self.initClient=initClient;var plugins_={};function initClient()
{self.callSvrSync('initClient',function(data){plugins_=data.plugins||{};$.each(plugins_,function(k,e){if(e.js){var js=BASE_URL+'plugin/'+k+'/'+e.js;mCommon.loadScript(js,null,true);}});});}
window.Plugins={exists:function(pname){return plugins_[pname]!==undefined;},list:function(){return plugins_;}};self.setApp=setApp;function setApp(app)
{$.extend(self.options,app);}
self.logout=logout;function logout(dontReload)
{deleteLoginToken();g_data.userInfo=null;self.callSvr("logout",function(data){if(!dontReload)
mCommon.reloadSite();});}
self.tabClose=tabClose;function tabClose(idx)
{if(idx==null){var jtab=self.tabMain.tabs("getSelected");idx=self.tabMain.tabs("getTabIndex",jtab);}
self.tabMain.tabs("close",idx);}
self.getActivePage=getActivePage;function getActivePage()
{var pp=self.tabMain.tabs('getSelected');var jpage=pp.find(".wui-page");return jpage;}
self.showLoading=showLoading;function showLoading()
{$('#block').css({width:$(document).width(),height:$(document).height(),'z-index':999999}).show();}
self.hideLoading=hideLoading;function hideLoading()
{$('#block').hide();}
function mainInit()
{self.tabMain=$('#my-tabMain');mCommon.assert(self.tabMain.size()==1,"require #my-tabMain as container");var opt=self.tabMain.tabs('options');$.extend(opt,{onSelect:function(title){var jpage=getActivePage();if(jpage.size()==0)
return;jpage.trigger('pageshow');},onBeforeClose:function(title){var jpage=getActivePage();if(jpage.size()==0)
return;jpage.trigger('pagedestroy');}});}
$(mainInit);}
jdModule("jdcloud.wui.name",JdcloudWuiName);function JdcloudWuiName()
{var self=this;var mCommon=jdModule("jdcloud.common");window.WUI=jdModule("jdcloud.wui");$.extend(WUI,mCommon);$.each(["intSort","numberSort","callSvr","callSvrSync","app_alert","app_confirm","app_show",],function(){window[this]=WUI[this];});}
var m_dataCache={};$.fn.mycombobox=function(force)
{this.each(initCombobox);function initCombobox(i,o)
{var jo=$(o);if(!force&&jo.prop("inited_"))
return;jo.prop("inited_",true);var opts={};var optStr=jo.data("options");try{if(optStr!=null)
{if(optStr.indexOf(":")>0){opts=eval("({"+optStr+"})");}
else{opts=eval("("+optStr+")");}}}catch(e){alert("bad options for mycombobox: "+optStr);}
if(opts.url){loadOptions();function loadOptions()
{jo.empty();if(jo.attr("name"))
$("<option value=''></option>").appendTo(jo);if(m_dataCache[opts.url]===undefined){self.callSvrSync(opts.url,applyData);}
else{applyData(m_dataCache[opts.url]);}
function applyData(data)
{m_dataCache[opts.url]=data;function getText(row)
{if(opts.formatter){return opts.formatter(row);}
else if(opts.textField){return row[opts.textField];}
return row.id;}
if(opts.loadFilter){data=opts.loadFilter.call(this,data);}
$.each(data,function(i,row){var jopt=$("<option></option>").attr("value",row[opts.valueField]).text(getText(row)).appendTo(jo);});}}
if(!jo.attr("ondblclick"))
{jo.off("dblclick").dblclick(function(){if(!confirm("刷新数据?"))
return false;var val=jo.val();loadOptions();jo.val(val);});}}}};