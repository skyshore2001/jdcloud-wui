// jdcloud-wui version 1.1

jdModule("jdcloud.common",JdcloudCommon);function JdcloudCommon()
{var self=this;self.assert=assert;function assert(cond,dscr)
{if(!cond){var msg="!!! assert fail!";if(dscr)
msg+=" - "+dscr;throw new Error(msg);}}
self.randInt=randInt;function randInt(from,to)
{return Math.floor(Math.random()*(to-from+1))+from;}
self.randChr=randChr;function randChr(cnt)
{var charCodeArr=[];var code_O='O'.charCodeAt(0)-'A'.charCodeAt(0)+10;for(var i=0;i<cnt;){var ch=randInt(0,35);if(ch==0||ch==code_O){continue;}
if(ch<10){charCodeArr.push(0x30+ch);}
else{charCodeArr.push(0x41+ch-10);}
i++;}
return String.fromCharCode.apply(this,charCodeArr);}
self.parseQuery=parseQuery;function parseQuery(s)
{var ret={};if(s!="")
{var a=s.split('&')
for(i=0;i<a.length;++i){var a1=a[i].split("=");var val=a1[1];if(val===undefined)
val=1;else if(/^-?[0-9]+$/.test(val)){val=parseInt(val);}
else if(/^-?[0-9.]+$/.test(val)){val=parseFloat(val);}
else{val=decodeURIComponent(val);}
ret[a1[0]]=val;}}
return ret;}
self.tobool=tobool;function tobool(v)
{if(typeof v==="string")
return v!==""&&v!=="0"&&v.toLowerCase()!=="false"&&v.toLowerCase()!=="off";return!!v;}
self.reloadSite=reloadSite;function reloadSite()
{var href=location.href.replace(/#.+/,'#');history.replaceState(null,null,href);location.reload();throw"abort";}
function setWidth_2(number)
{return number<10?("0"+number):(""+number);}
Date.prototype.format=function(fmt)
{if(fmt==null)
fmt="L";switch(fmt){case"L":fmt="yyyy-mm-dd HH:MM:SS";break;case"D":fmt="yyyy-mm-dd";break;case"T":fmt="HH:MM:SS";break;}
var year=this.getFullYear();return fmt.replace("yyyy",year).replace("yy",(""+year).substring(2)).replace("mm",setWidth_2(this.getMonth()+1)).replace("dd",setWidth_2(this.getDate())).replace("HH",setWidth_2(this.getHours())).replace("MM",setWidth_2(this.getMinutes())).replace("SS",setWidth_2(this.getSeconds()));}
Date.prototype.addDay=function(iDay)
{this.setDate(this.getDate()+iDay);return this;}
Date.prototype.addHours=function(iHours)
{this.setHours(this.getHours()+iHours);return this;}
Date.prototype.addMin=function(iMin)
{this.setMinutes(this.getMinutes()+iMin);return this;}
Date.prototype.addMonth=function(iMonth)
{this.setMonth(this.getMonth()+iMonth);return this;}
self.parseTime=parseTime;function parseTime(s)
{var a=s.split(":");var dt=new Date(0,0,1,a[0],a[1]||0,a[2]||0);if(isNaN(dt.getYear()))
return null;return dt;}
self.parseDate=parseDate;function parseDate(str)
{if(str==null)
return null;if(str instanceof Date)
return str;if(/Z$/.test(str)){return new Date(str);}
var ms=str.match(/^(\d+)(?:[-\/.](\d+)(?:[-\/.](\d+))?)?/);if(ms==null)
return null;var y,m,d;var now=new Date();if(ms[3]!==undefined){y=parseInt(ms[1]);m=parseInt(ms[2])-1;d=parseInt(ms[3]);if(y<100)
y+=2000;}
else if(ms[2]!==undefined){y=now.getFullYear();m=parseInt(ms[1])-1;d=parseInt(ms[2]);}
else{y=now.getFullYear();m=now.getMonth();d=parseInt(ms[1]);}
var h,n,s;h=0;n=0;s=0;ms=str.match(/(\d+):(\d+)(?::(\d+))?/);if(ms!=null){h=parseInt(ms[1]);n=parseInt(ms[2]);if(ms[3]!==undefined)
s=parseInt(ms[3]);}
var dt=new Date(y,m,d,h,n,s);if(isNaN(dt.getYear()))
return null;ms=str.match(/:[0-9.T]+([+-])(\d{1,4})$/);if(ms!=null){var sign=(ms[1]=="-"?-1:1);var cnt=ms[2].length;var n=parseInt(ms[2].replace(/^0+/,''));if(isNaN(n))
n=0;else if(cnt>2)
n=Math.floor(n/100);var tzOffset=sign*n*60+dt.getTimezoneOffset();if(tzOffset)
dt.addMin(-tzOffset);}
return dt;}
Date.prototype.add=function(sInterval,n)
{switch(sInterval){case'd':this.setDate(this.getDate()+n);break;case'm':this.setMonth(this.getMonth()+n);break;case'y':this.setFullYear(this.getFullYear()+n);break;case'h':this.setHours(this.getHours()+n);break;case'n':this.setMinutes(this.getMinutes()+n);break;case's':this.setSeconds(this.getSeconds()+n);break;}
return this;}
Date.prototype.diff=function(sInterval,dtEnd)
{var dtStart=this;switch(sInterval)
{case'd':{var d1=(dtStart.getTime()-dtStart.getTimezoneOffset()*60000)/86400000;var d2=(dtEnd.getTime()-dtEnd.getTimezoneOffset()*60000)/86400000;return Math.floor(d2)-Math.floor(d1);}
case'm':return dtEnd.getMonth()-dtStart.getMonth()+(dtEnd.getFullYear()-dtStart.getFullYear())*12;case'y':return dtEnd.getFullYear()-dtStart.getFullYear();case's':return Math.round((dtEnd-dtStart)/1000);case'n':return Math.round((dtEnd-dtStart)/60000);case'h':return Math.round((dtEnd-dtStart)/3600000);}}
self.getTimeDiffDscr=getTimeDiffDscr;function getTimeDiffDscr(tm,tm1)
{if(!tm||!tm1)
return"";if(!(tm instanceof Date)){tm=parseDate(tm);}
if(!(tm1 instanceof Date)){tm1=parseDate(tm1);}
var diff=(tm1-tm)/1000;if(diff<60){return"刚刚";}
diff/=60;if(diff<60){return Math.floor(diff)+"分钟前";}
diff/=60;if(diff<48){return Math.floor(diff)+"小时前";}
diff/=24;if(diff<365*2)
return Math.floor(diff)+"天前";diff/=365;if(diff<10)
return Math.floor(diff)+"年前";return"很久前";}
self.getTmRange=getTmRange;function getTmRange(dscr,now)
{if(!now)
now=new Date();else if(!(now instanceof Date)){now=WUI.parseDate(now);}
else{now=new Date(now);}
var rv=getTmRangeSimple(dscr,now);if(rv)
return rv;dscr=dscr.replace(/本|今/,"前0");dscr=dscr.replace(/上|昨/,"前");var re=/(近|前)(\d*).*?(小时|日|天|月|周|年)/;var m=dscr.match(re);if(!m)
return;var dt1,dt2,dt;var type=m[1];var n=parseInt(m[2]||'1');var u=m[3];var fmt_d="yyyy-mm-dd";var fmt_h="yyyy-mm-dd HH:00";var fmt_m="yyyy-mm-01";var fmt_y="yyyy-01-01";if(u=="小时"){if(n==0){now.add("h",1);n=1;}
if(type=="近"){now.add("h",1);}
dt2=now.format(fmt_h);dt1=now.add("h",-n).format(fmt_h);}
else if(u=="日"||u=="天"){if(n==0||type=="近"){now.addDay(1);++n;}
dt2=now.format(fmt_d);dt1=now.add("d",-n).format(fmt_d);}
else if(u=="月"){if(n==0){now.addMonth(1);n=1;}
if(type=="近"){now.addDay(1);var d2=now.getDate();dt2=now.format(fmt_d);now.add("m",-n);do{var d1=now.getDate();if(d1==d2||d1>10)
break;now.addDay(-1);}while(true);dt1=now.format(fmt_d);}
else if(type=="前"){dt2=now.format(fmt_m);dt1=WUI.parseDate(dt2).add("m",-n).format(fmt_m);}}
else if(u=="周"){if(n==0){now.addDay(7);n=1;}
if(type=="近"){now.addDay(1);dt2=now.format(fmt_d);dt1=now.add("d",-n*7).format(fmt_d);}
else if(type=="前"){dt2=now.add("d",-now.getDay()+1).format(fmt_d);dt1=now.add("d",-7*n).format(fmt_d);}}
else if(u=="年"){if(n==0){now.add("y",1);n=1;}
if(type=="近"){now.addDay(1);dt2=now.format(fmt_d);dt1=now.add("y",-n).format(fmt_d);}
else if(type=="前"){dt2=now.format(fmt_y);dt1=WUI.parseDate(dt2).add("y",-n).format(fmt_y);}}
else{return;}
return[dt1,dt2];}
function getTmRangeSimple(dscr,now)
{var fmt_d="yyyy-mm-dd";var fmt_m="yyyy-mm-01";var fmt_y="yyyy-01-01";if(dscr=="本月"){var dt1=now.format(fmt_m);var y=now.getFullYear();var m=now.getMonth()+2;if(m==12){++y;m=1;}
var dt2=y+"-"+setWidth_2(m)+"-01";}
else if(dscr=="上月"){var dt2=now.format(fmt_m);var y=now.getFullYear();var m=now.getMonth();now.addMonth(-1);if(m==0){--y;m=12;}
var dt1=y+"-"+setWidth_2(m)+"-01";}
else if(dscr=="本周"){var dt1=now.add("d",-(now.getDay()||7)+1).format(fmt_d);now.addDay(7);var dt2=now.format(fmt_d);}
else if(dscr=="上周"){var dt2=now.add("d",-(now.getDay()||7)+1).format(fmt_d);now.addDay(-7);var dt1=now.format(fmt_d);}
else if(dscr=="今年"){var dt1=now.format(fmt_y);now.addMonth(12);var dt2=now.format(fmt_y);}
else if(dscr=="去年"||dscr=="上年"){var dt2=now.format(fmt_y);now.addMonth(-12);var dt1=now.format(fmt_y);}
else if(dscr=="本季度"){var m=Math.floor(now.getMonth()/3)*3+1;var dt1=now.getFullYear()+"-"+setWidth_2(m)+"-01";var dt2=now.getFullYear()+"-"+setWidth_2(m+3)+"-01";}
else if(dscr=="上季度"){var m=Math.floor(now.getMonth()/3)*3;if(m>0){var dt1=now.getFullYear()+"-"+setWidth_2(m-3)+"-01";var dt2=now.getFullYear()+"-"+setWidth_2(m)+"-01";}
else{var y=now.getFullYear();var dt1=(y-1)+"-10-01";var dt2=y+"-01-01";}}
else if(dscr=="上半年"){var y=now.getFullYear();var dt1=y+"-01-01";var dt2=y+"-07-01";}
else if(dscr=="下半年"){var y=now.getFullYear();var dt1=y+"-07-01";var dt2=(y+1)+"-01-01";}
else{return;}
return[dt1,dt2];}
self.setCookie=setCookie;function setCookie(name,value,days)
{if(days===undefined)
days=30;if(value==null)
{days=-1;value="";}
var exp=new Date();exp.setTime(exp.getTime()+days*24*60*60*1000);document.cookie=name+"="+escape(value)+";expires="+exp.toGMTString();}
self.getCookie=getCookie;function getCookie(name)
{var m=document.cookie.match(new RegExp("(^| )"+name+"=([^;]*)(;|$)"));if(m!=null){return(unescape(m[2]));}else{return null;}}
self.delCookie=delCookie;function delCookie(name)
{if(getCookie(name)!=null){setCookie(name,null,-1);}}
self.setStorage=setStorage;function setStorage(name,value,useSession)
{if($.isPlainObject(value)||$.isArray(value)){value=JSON.stringify(value);}
assert(typeof value!="object","value must be scalar!");if(window.STORAGE_PREFIX)
name=window.STORAGE_PREFIX+name;if(useSession)
sessionStorage.setItem(name,value);else
localStorage.setItem(name,value);}
self.getStorage=getStorage;function getStorage(name,useSession)
{if(window.STORAGE_PREFIX)
name=window.STORAGE_PREFIX+name;var value;if(useSession)
value=sessionStorage.getItem(name);else
value=localStorage.getItem(name);if(typeof(value)=="string"&&(value[0]=='{'||value[0]=='['))
value=JSON.parse(value);return value;}
self.delStorage=delStorage;function delStorage(name,useSession)
{if(window.STORAGE_PREFIX)
name=window.STORAGE_PREFIX+name;if(useSession)
sessionStorage.removeItem(name);else
localStorage.removeItem(name);}
self.rs2Array=rs2Array;function rs2Array(rs)
{var ret=[];var colCnt=rs.h.length;for(var i=0;i<rs.d.length;++i){var obj={};var row=rs.d[i];for(var j=0;j<colCnt;++j){obj[rs.h[j]]=row[j];}
ret.push(obj);}
return ret;}
self.rs2Hash=rs2Hash;function rs2Hash(rs,key)
{var ret={};var colCnt=rs.h.length;var keyfn;if(typeof(key)=="function")
keyfn=key;for(var i=0;i<rs.d.length;++i){var obj={};var row=rs.d[i];for(var j=0;j<colCnt;++j){obj[rs.h[j]]=row[j];}
var k=keyfn?keyfn(obj):obj[key];if(Array.isArray(k)&&k.length==2)
ret[k[0]]=k[1];else
ret[k]=obj;}
return ret;}
self.rs2MultiHash=rs2MultiHash;function rs2MultiHash(rs,key)
{var ret={};var colCnt=rs.h.length;var keyfn;if(typeof(key)=="function")
keyfn=key;for(var i=0;i<rs.d.length;++i){var obj={};var row=rs.d[i];for(var j=0;j<colCnt;++j){obj[rs.h[j]]=row[j];}
var k=keyfn?keyfn(obj):obj[key];if(Array.isArray(k)&&k.length==2){obj=k[1];k=k[0];}
if(ret[k]===undefined)
ret[k]=[obj];else
ret[k].push(obj);}
return ret;}
self.list2varr=list2varr;function list2varr(ls,sep,sep2)
{if(sep==null)
sep=':';if(sep2==null)
sep2=',';var ret=[];$.each(ls.split(sep2),function(){if(this.length==0)
return;ret.push(this.split(sep));});return ret;}
self.objarr2list=objarr2list;function objarr2list(objarr,fields,sep,sep2)
{sep=sep||':';sep2=sep2||',';var fn=$.isFunction(fields)?fields:function(e,i){var row='';$.each(fields,function(j,e1){if(row.length>0)
row+=sep;row+=e[e1];});return row;};return $.map(objarr,fn).join(sep2);}
self.intSort=intSort;function intSort(a,b)
{return(parseInt(a)||0)-(parseInt(b)||0);}
self.numberSort=numberSort;function numberSort(a,b)
{return(parseFloat(a)||0)-(parseFloat(b)||0);}
self.getAncestor=getAncestor;function getAncestor(o,fn)
{while(o){if(fn(o))
return o;o=o.parentElement;}
return o;}
self.appendParam=appendParam;function appendParam(url,param)
{if(param==null)
return url;var ret;var a=url.split("#");ret=a[0]+(url.indexOf('?')>=0?"&":"?")+param;if(a.length>1){ret+="#"+a[1];}
return ret;}
self.deleteParam=deleteParam;function deleteParam(url,paramName)
{var ret=url.replace(new RegExp('&?\\b'+paramName+"\\b(=[^&#]+)?"),'');ret=ret.replace(/\?&/,'?');return ret;}
self.isWeixin=isWeixin;function isWeixin()
{return/micromessenger/i.test(navigator.userAgent);}
self.isIOS=isIOS;function isIOS()
{return/iPhone|iPad/i.test(navigator.userAgent);}
self.isAndroid=isAndroid;function isAndroid()
{return/Android/i.test(navigator.userAgent);}
self.parseValue=parseValue;function parseValue(str)
{if(str==null)
return str;var val=str;if(/^-?[0-9]+$/.test(str)){val=parseInt(str);}
if(/^-?[0-9.]+$/.test(str)){val=parseFloat(str);}
return val;}
self.applyTpl=applyTpl;function applyTpl(tpl,data)
{return tpl.replace(/{([^{}:,.]+)}/g,function(m0,m1){return data[m1];});}
self.delayDo=delayDo;function delayDo(fn,delayCnt)
{if(delayCnt==null)
delayCnt=3;doIt();function doIt()
{if(delayCnt==0)
{fn();return;}
--delayCnt;setTimeout(doIt);}}
self.kvList2Str=kvList2Str;function kvList2Str(kv,sep,sep2)
{var ret='';$.each(kv,function(k,v){if(typeof(v)!="function"){if(ret)
ret+=sep;ret+=k+sep2+v;}});return ret;}
self.parseKvList=parseKvList;function parseKvList(str,sep,sep2,doReverse)
{var map={};$.each(str.split(sep),function(i,e){var kv=e.split(sep2,2);if(kv.length<2){kv[1]=kv[0];}
if(!doReverse)
map[kv[0]]=kv[1];else
map[kv[1]]=kv[0];});return map;}
window.Q=self.Q=Q;function Q(str,q)
{if(str==null)
return"null";if(typeof str=="number")
return str;if(q==null)
q="'";return q+str.toString().replaceAll(q,"\\"+q)+q;}
function initModule()
{if(String.prototype.startsWith==null){String.prototype.startsWith=function(s){return this.substr(0,s.length)==s;}}
if(window.console===undefined){window.console={log:function(){}}}}
initModule();self.text2html=text2html;function text2html(s,pics)
{var ret="";if(s){ret=s.replace(/^(?:([#-]+)\s+)?(.*)$/mg,function(m,begin,text){if(begin){if(begin[0]=='#'){n=begin.length;return"<h"+n+">"+text+"</h"+n+">";}
if(begin[0]=='-'){return"<li>"+text+"</li>";}}
if(text){text=text.replace(" ","&nbsp;");}
else{text="&nbsp;";}
return"<p>"+text+"</p>";})+"\n";}
if(pics){var arr=pics.split(/\s*,\s*/);arr.forEach(function(e){var url="../api.php/att?thumbId="+e;ret+="<img src=\""+url+"\">\n";});}
return ret;}
self.extendNoOverride=extendNoOverride;function extendNoOverride(target)
{if(!target)
return target;$.each(arguments,function(i,e){if(i==0||!$.isPlainObject(e))
return;$.each(e,function(k,v){if(target[k]===undefined)
target[k]=v;});});return target;}}
function jdModule(name,fn,overrideCtor)
{if(!window.jdModuleMap){window.jdModuleMap={};}
if(name==null){return window.jdModuleMap;}
var ret;if(typeof(fn)==="function"){if(window.jdModuleMap[name]){fn.call(window.jdModuleMap[name]);}
else{window.jdModuleMap[name]=new fn();}
ret=window.jdModuleMap[name];if(overrideCtor)
ret.constructor=fn;}
else{ret=window.jdModuleMap[name];if(!ret){throw"load module fails: "+name;}}
return ret;}
function jdPush(app,handleMsg,opt){opt=Object.assign({user:window.g_data&&g_data.userInfo&&g_data.userInfo.id||("jduser-"+Math.round(Math.random()*10000)),url:"/jdserver",dataType:"json",keepAliveInterval:60},opt);if(!opt.user){throw"jdPush: require param `user`";}
var ws;var tmr,tmrAlive;var url=opt.url;var doClose=false;if(!/^wss?:/.test(url)){var proto=(location.protocol=="https:"?"wss:":"ws:");if(url.substr(0,2)=='//'){url=proto+url;}
else if(url[0]=='/'){var path=(location.host||"localhost");var m=location.pathname.match(/^\/@[^\/]+/);if(m){path+=m[0];}
url=proto+'//'+path+url;}
else{console.error("jdPush: 连接websocket服务器，请使用//或/开头的绝对地址!");return;}}
connect();var proxy={close:function(){if(tmr)
clearTimeout(tmr);ws.close();doClose=true;},send:function(s){if(typeof(s)!="string")
s=JSON.stringify(s);ws.send(s);}}
return proxy;function connect(){ws=new WebSocket(url);console.log('connect to ',url);ws.onopen=function(ev){var req={ac:'init',app:app,user:opt.user};ws.send(JSON.stringify(req));if(opt.keepAliveInterval)
tmrAlive=setInterval(alive,opt.keepAliveInterval*1000);};ws.onerror=function(ev){};ws.onclose=function(ev){if(!doClose&&ev.code!=1000&&ev.code!=1005){console.warn('websocket close. will reconnect.');reconnect();return;}
if(tmrAlive)
clearTimeout(tmrAlive);console.log('websocket close');};ws.onmessage=function(ev){if(!handleMsg){console.log(ev.data);return;}
if(opt.dataType=='json'){if(ev.data[0]=='{')
handleMsg(JSON.parse(ev.data),ws);else
console.log(ev.data);return;}
handleMsg(ev.data,ws);};}
function reconnect(){tmr=setTimeout(connect,5000);}
function alive(){var req={ac:"alive"};ws.send(JSON.stringify(req));}}
if(!String.prototype.replaceAll){String.prototype.replaceAll=function(from,to){return this.replace(new RegExp(from,"g"),to);}}
jdModule("jdcloud.common",JdcloudCommonJq);function JdcloudCommonJq()
{var self=this;self.assert(window.jQuery,"require jquery lib.");var mCommon=jdModule("jdcloud.common");$.isFunction=function(o){return typeof(o)=='function';};self.getFormData=getFormData;function getFormData(jo,doGetAll)
{var data={};var isFormData=false;var enctype=jo.attr("enctype");if((enctype&&enctype.toLowerCase()=="multipart/form-data")||jo.has("[name]:file").size()>0){isFormData=true;data=new FormData();}
var orgData=jo.data("origin_")||{};formItems(jo,function(ji,name,it){if(doGetAll!="all"&&it.getDisabled())
return;var orgContent=orgData[name];if(orgContent==null)
orgContent="";var content=it.getValue();if(content==null)
content="";if(doGetAll||content!==String(orgContent))
{if(!isFormData){if(name.substr(-2)=="[]"){name=name.substr(0,name.length-2);if(!data[name]){data[name]=[];}
data[name].push(content);}
else{data[name]=content;}}
else{if(ji.is(":file")){$.each(ji.prop("files"),function(i,e){data.append(name,e);});}
else{data.append(name,content);}}}});return data;}
self.getFormData_vf=getFormData_vf;function getFormData_vf(jo)
{var data={};formItems(jo,function(ji,name,it){var vname=WUI.getOptions(ji).jd_vField;if(!vname)
return;data[vname]=it.getValue_vf();});return data;}
self.formItems=formItems;self.getFormItemExt={};self.getFormItem=getFormItem;function getFormItem(ji)
{var ret;$.each(self.getFormItemExt,function(k,ext){var rv=ext(ji);if(rv!==undefined){ret=rv;return false;}});return ret||new FormItem(ji);}
self.FormItem=FormItem;function FormItem(ji){this.ji=ji;}
FormItem.prototype={getName:function(){var jo=this.ji;return jo.attr("name")||jo.prop("name");},getJo:function(){return this.ji;},getDisabled:function(){var jo=this.ji;var val=jo.prop("disabled");if(val===undefined)
val=jo.attr("disabled");var o=jo[0];if(!val&&o.tagName=="INPUT"){if(o.type=="radio"&&!o.checked)
return true;}
return val;},setDisabled:function(val){var jo=this.ji;if(jo.hasClass("easyui-validatebox")){jo.validatebox({disabled:!!val});return;}
jo.prop("disabled",!!val);if(val)
jo.attr("disabled","disabled");else
jo.removeAttr("disabled");},getReadonly:function(){var jo=this.ji;var val=jo.prop("readonly");if(val===undefined)
val=jo.attr("readonly");return val;},setReadonly:function(val){var jo=this.ji;jo.prop("readonly",!!val);if(val)
jo.attr("readonly","readonly");else
jo.removeAttr("readonly");},setValue:function(val){var jo=this.ji;var isInput=jo.is(":input");if(val===undefined){if(isInput){var o=jo[0];if(o.tagName==="TEXTAREA")
val=jo.html();else if(!(o.tagName=="INPUT")&&(o.type=="hidden"))
val=jo.attr("value");if(val===undefined)
val="";}
else{val="";}}
if($.isArray(val)||$.isPlainObject(val)){val=JSON.stringify(val);}
if(jo.is(":checkbox")){jo.prop("checked",mCommon.tobool(val));}
else if(isInput){jo.val(val);}
else{jo.html(val);}},getValue:function(jo){var jo=this.ji;var val;if(jo.is(":checkbox")){val=jo.prop("checked")?jo.val():jo.attr("value-off");if(val==="on")
val=1;}
else if(jo.is(":input")){val=jo.val();if(val)
val=val.trim();}
else{val=jo.html();}
return val;},getShowbox:function(){return this.ji;},getValue_vf:function(){var jo=this.ji;var o=jo[0];if(o.tagName=="SELECT")
return o.selectedIndex>=0?o.options[o.selectedIndex].innerText:'';return this.getValue(jo);},getTitle:function(){return this.ji.closest("td").prev("td").html();},setTitle:function(val){this.ji.closest("td").prev("td").html(val);},setFocus:function(){var j1=this.getShowbox();if(j1.is(":hidden")){selectTab(j1);}
j1.focus();},val:function(v){if(v===undefined)
return this.getValue();this.setValue(v);return this;},disabled:function(v){if(v===undefined)
return this.getDisabled();this.setDisabled(v);return this;},readonly:function(v){if(v===undefined)
return this.getReadonly();this.setReadonly(v);return this;},visible:function(v){var jp=this.ji.closest("tr,.wui-field");if(v===undefined){return this.getShowbox().css("display")!="none"&&jp.css("display")!="none";}
jp.toggle(!!v);return this;},setOption:function(v){if(!$.isPlainObject(v))
return;this.getJo().trigger("setOption",v);return this;}};function selectTab(jo)
{var jtabs=jo.closest(".easyui-tabs");if(jtabs.size()==0)
return;var idx=-1;jtabs.find(">.tabs-panels>.panel").each(function(idx1){if(jo.closest(this).size()>0){idx=idx1;return true;}});if(idx<0)
return;jtabs.tabs("select",idx);}
jQuery.fn.gn=function(name){var ji=name?this.find("[name="+name+"],.wui-subobj-"+name):this;return WUI.getFormItem(ji);}
function formItems(jo,cb,sel)
{if(sel==null)
sel="[name]";var jiList=jo.filter(sel).add(jo.find(sel));jiList.each(function(){var it=getFormItem($(this));var name=it.getName();if(!name)
return;var ji=it.getJo();if(cb(ji,name,it)===false){return false;}});}
self.setFormData=setFormData;function setFormData(jo,data,opt)
{var opt1=$.extend({setOrigin:false},opt);if(data==null)
data={};formItems(jo,function(ji,name,it){if(ji.attr("noReset"))
return;var content=data[name];if(opt1.setOnlyDefined&&content===undefined)
return;it.setValue(content);});jo.data("origin_",opt1.setOrigin?data:null);}
self.loadScript=loadScript;function loadScript(url,fnOK,options)
{if($.isPlainObject(fnOK)){options=fnOK;fnOK=null;}
if(options){var ajaxOpt=$.extend({dataType:"script",cache:true,success:fnOK,url:url,error:function(xhr,textStatus,err){console.error("*** loadScript fails for "+url);console.error(err);}},options);return jQuery.ajax(ajaxOpt);}
var dfd_=$.Deferred();var script=document.createElement('script');script.type='text/javascript';script.src=url;script.async=false;script.onload=function(){if(fnOK)
fnOK();dfd_.resolve();}
script.onerror=function(){dfd_.reject();console.error("*** loadScript fails for "+url);}
document.head.appendChild(script);return dfd_;}
self.evalOptions=evalOptions;function evalOptions(_source,ctx,onError)
{if(/^\w+:/.test(_source)){_source="({"+_source+"})";}
else if(/^(\s*\/\/[^\n]*\n)*\s*\{/.test(_source)){_source="("+_source+")";}
if(_source.indexOf("\n")>0)
return eval(_source);try{return eval(_source);}
catch(ex){console.error(ex);if(onError){onError(ex);}
else{app_alert("代码错误: "+ex,"e");}}}
self.loadJson=loadJson;function loadJson(url,fnOK,options)
{var ajaxOpt=$.extend({dataType:"text",jdFilter:false,success:function(data){val=self.evalOptions(data,null,function(ex){app_alert("文件"+url+"出错: "+ex,"e");});fnOK.call(this,val);}},options);return $.ajax(url,ajaxOpt);}
self.loadCss=loadCss;function loadCss(url)
{var jo=$('<link type="text/css" rel="stylesheet" />').attr("href",url);jo.appendTo($("head"));}
self.setDateBox=setDateBox;function setDateBox(jo,defDateFn)
{jo.blur(function(){var dt=self.parseDate(this.value);if(dt==null){if(defDateFn)
dt=defDateFn();else
dt=new Date();}
this.value=dt.format("D");});}
self.setTimeBox=setTimeBox;function setTimeBox(jo,defTimeFn)
{jo.blur(function(){var dt=self.parseTime(this.value);if(dt==null){if(defTimeFn)
dt=defTimeFn();else
dt=new Date();}
this.value=dt.format("HH:MM");});}
self.waitFor=waitFor;function waitFor(dfd)
{if(waitFor.caller==null)
throw"waitFor MUST be called in function!";if(dfd.state()=="resolved")
return false;if(!dfd.isset_)
{var caller=waitFor.caller;var args=caller.arguments;dfd.isset_=true;dfd.then(function(){caller.apply(this,args);});}
return true;}
self.rgb=rgb;function rgb(r,g,b,a)
{if(a===0)
return;return'#'+pad16(r)+pad16(g)+pad16(b);function pad16(n){var ret=n.toString(16);return n>16?ret:'0'+ret;}}
self.rgb2hex=rgb2hex;function rgb2hex(rgbFormat)
{var rgba=rgb;try{return eval(rgbFormat);}catch(ex){console.log(ex);}}
$.fn.jdata=function(val){if(val!=null){this.data("jdata",val);return val;}
var jd=this.data("jdata");if(jd==null)
jd=this.jdata({});return jd;}
self.compressImg=compressImg;function compressImg(fileObj,cb,opt)
{var opt0={quality:0.8,maxSize:1280,mimeType:"image/jpeg"};opt=$.extend(opt0,opt);window.BlobBuilder=(window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder);var doDowngrade=!window.Blob||window.BlobBuilder;if(doDowngrade){var rv={name:fileObj.name,size:fileObj.size,b64src:window.URL.createObjectURL(fileObj),blob:fileObj,};rv.info="compress ignored. "+rv.name+": "+(rv.size/1024).toFixed(0)+"KB";console.log(rv.info);cb(rv);return;}
var img=new Image();img.src=window.URL.createObjectURL(fileObj);img.onload=function(){var rv=resizeImg(img);rv.info="compress "+rv.name+" q="+rv.quality+": "+rv.w0+"x"+rv.h0+"->"+rv.w+"x"+rv.h+", "+(rv.size0/1024).toFixed(0)+"KB->"+(rv.size/1024).toFixed(0)+"KB(rate="+(rv.size/rv.size0*100).toFixed(2)+"%,b64="+(rv.b64size/1024).toFixed(0)+"KB)";console.log(rv.info);cb(rv);}
function resizeImg()
{var w=img.naturalWidth,h=img.naturalHeight;if(opt.maxSize<w||opt.maxSize<h){if(w>h){h=Math.round(h*opt.maxSize/w);w=opt.maxSize;}
else{w=Math.round(w*opt.maxSize/h);h=opt.maxSize;}}
var cvs=document.createElement('canvas');cvs.width=w;cvs.height=h;var ctx=cvs.getContext("2d").drawImage(img,0,0,w,h);var b64src=cvs.toDataURL(opt.mimeType,opt.quality);var blob=getBlob(b64src);if(blob.size>fileObj.size){blob=fileObj;opt.mimeType=fileObj.type;}
var fname=getFname(fileObj.name,opt.mimeType);return{w0:img.naturalWidth,h0:img.naturalHeight,w:w,h:h,quality:opt.quality,mimeType:opt.mimeType,b64src:b64src,name:fname,blob:blob,size0:fileObj.size,b64size:b64src.length,size:blob.size};}
function getBlob(b64src)
{var bytes=window.atob(b64src.split(',')[1]);var ia=new Uint8Array(bytes.length);for(var i=0;i<bytes.length;i++){ia[i]=bytes.charCodeAt(i);}
var blob;try{blob=new Blob([ia.buffer],{type:opt.mimeType});}
catch(e){if(e.name=='TypeError'&&window.BlobBuilder){var bb=new BlobBuilder();bb.append(ia.buffer);blob=bb.getBlob(opt.mimeType);}
else{}}
return blob;}
function getFname(fname,mimeType)
{var exts={"image/jpeg":".jpg","image/png":".png","image/webp":".webp"};var ext1=exts[mimeType];if(ext1==null)
return fname;return fname.replace(/(\.\w+)?$/,ext1);}}
self.triggerAsync=triggerAsync;function triggerAsync(jo,ev,paramArr)
{if(typeof(ev)=="string"){ev=$.Event(ev);}
ev.dfds=[];jo.trigger(ev,paramArr);if(ev.isDefaultPrevented())
return false;return $.when.apply(this,ev.dfds);}
var fnDeferred=$.Deferred;$.Deferred=function(){var ret=fnDeferred.apply(this,arguments);ret.catch=ret.fail;ret.finally=ret.always;var fn=ret.promise;ret.promise=function(){var r=fn.apply(this,arguments);r.catch=r.fail;r.finally=r.always;return r;}
return ret;}
function appendCond(cond,cond1)
{if(!cond){if($.isArray(cond1))
return $.extend(true,[],cond1);if($.isPlainObject(cond1))
return $.extend(true,{},cond1);return cond1;}
if(!cond1)
return cond;if($.isArray(cond)){cond.push(cond1);}
else if(typeof(cond)=="string"&&typeof(cond1)=="string"){cond+=" AND ("+cond1+")";}
else{cond=[cond,cond1];}
return cond;}
self.extendQueryParam=extendQueryParam;function extendQueryParam(target,a,b)
{var cond;$.each(arguments,function(i,e){if(i==0){cond=target.cond;}
else if($.isPlainObject(e)){cond=appendCond(cond,e.cond);$.extend(target,e);}});if(cond){target.cond=cond;}
return target;}
self.makeTree=makeTree;function makeTree(arr,idField,fatherIdField,childrenField)
{if(idField==null)
idField="id";if(fatherIdField==null)
fatherIdField="fatherId";if(childrenField==null)
childrenField="children";var ret=[];$.each(arr,function(i,e){var fid=e[fatherIdField];if(fid==null){ret.push(e);return;}
var found=false;$.each(arr,function(i1,e1){if(fid==e1[idField]){if(e1[childrenField]==null){e1[childrenField]=[];}
e1[childrenField].push(e);found=true;return false;}});if(!found)
ret.push(e);});return ret;}
(function($){var keyString="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";var utf8Encode=function(string){string=string.replace(/\x0d\x0a/g,"\x0a");var output="";for(var n=0;n<string.length;n++){var c=string.charCodeAt(n);if(c<128){output+=String.fromCharCode(c);}else if((c>127)&&(c<2048)){output+=String.fromCharCode((c>>6)|192);output+=String.fromCharCode((c&63)|128);}else{output+=String.fromCharCode((c>>12)|224);output+=String.fromCharCode(((c>>6)&63)|128);output+=String.fromCharCode((c&63)|128);}}
return output;};var utf8Decode=function(input){var string="";var i=0;var c=c1=c2=0;while(i<input.length){c=input.charCodeAt(i);if(c<128){string+=String.fromCharCode(c);i++;}else if((c>191)&&(c<224)){c2=input.charCodeAt(i+1);string+=String.fromCharCode(((c&31)<<6)|(c2&63));i+=2;}else{c2=input.charCodeAt(i+1);c3=input.charCodeAt(i+2);string+=String.fromCharCode(((c&15)<<12)|((c2&63)<<6)|(c3&63));i+=3;}}
return string;};$.extend(self,{base64Encode:function(input,enhance){var output="";var chr1,chr2,chr3,enc1,enc2,enc3,enc4;var i=0;input=utf8Encode(input);var key=keyString;if(enhance){var n=self.randInt(1,63);var n1=(n+input.length)%64;key=key.substr(n,64-n)+key.substr(0,n)+' ';output=keyString.charAt(n)+key.charAt(n1);}
while(i<input.length){chr1=input.charCodeAt(i++);chr2=input.charCodeAt(i++);chr3=input.charCodeAt(i++);enc1=chr1>>2;enc2=((chr1&3)<<4)|(chr2>>4);enc3=((chr2&15)<<2)|(chr3>>6);enc4=chr3&63;if(isNaN(chr2)){enc3=enc4=64;}else if(isNaN(chr3)){enc4=64;}
output=output+key.charAt(enc1)+key.charAt(enc2)+key.charAt(enc3)+key.charAt(enc4);}
if(enhance)
output=output.trim().replace(/[+]/g,'-');return output;},base64Decode:function(input){var output="";var chr1,chr2,chr3;var enc1,enc2,enc3,enc4;var i=0;input=input.replace(/[^A-Za-z0-9\+\/\=]/g,"");while(i<input.length){enc1=keyString.indexOf(input.charAt(i++));enc2=keyString.indexOf(input.charAt(i++));enc3=keyString.indexOf(input.charAt(i++));enc4=keyString.indexOf(input.charAt(i++));chr1=(enc1<<2)|(enc2>>4);chr2=((enc2&15)<<4)|(enc3>>2);chr3=((enc3&3)<<6)|enc4;output=output+String.fromCharCode(chr1);if(enc3!=64){output=output+String.fromCharCode(chr2);}
if(enc4!=64){output=output+String.fromCharCode(chr3);}}
output=utf8Decode(output);return output;}});return 0;})(jQuery);}
function JdcloudApp()
{var self=this;self.ctx=self.ctx||{};window.E_AUTHFAIL=-1;window.E_NOAUTH=2;window.E_ABORT=-100;self.evalAttr=evalAttr;function evalAttr(jo,name,ctx)
{var val=jo.attr(name);if(val){val=self.evalOptions(val,ctx,function(ex){self.app_alert("属性`"+name+"'格式错误: <br>"+val+"<br>"+ex,"e");});}
return val;}
self.ctx.fixPageCss=fixPageCss;function fixPageCss(css,selector)
{var level=1;var css1=css.replace(/\/\*(.|\s)*?\*\//g,'').replace(/([^{}]*)([{}])/g,function(ms,text,brace){if(brace=='}'){--level;return ms;}
if(brace=='{'&&level++!=1)
return ms;return ms.replace(/((?:^|,)\s*)([^,{}]+)/g,function(ms,ms1,sel){if(sel[0]=='@')
return ms;if(sel.startsWith(selector)){var ch=sel.substr(selector.length,1);if(ch==''||ch==' '||ch=='.'||ch=='#'||ch==':'||ch=='>'||ch=='+')
return ms;}
return ms1+selector+' '+sel;});});return css1;}
self.app_abort=app_abort;function app_abort()
{throw new DirectReturn();}
window.DirectReturn=DirectReturn;function DirectReturn(){}
function windowOnError(ev)
{if($.active||self.isBusy){setTimeout(function(){$.active=0;self.isBusy=0;self.hideLoading();},1000);}
var msg=ev.message,errObj=ev.error;if(errObj instanceof DirectReturn||/abort$/.test(msg))
return true;if(self.options.skipErrorRegex&&self.options.skipErrorRegex.test(msg))
return true;if(errObj===undefined&&msg==="[object Object]")
return true;debugger;var content=msg+" ("+ev.filename+":"+ev.lineno+":"+ev.colno+")";if(errObj&&errObj.stack)
content+="\n"+errObj.stack.toString();if(self.syslog)
self.syslog("fw","ERR",content);app_alert(msg,"e");}
window.addEventListener('error',windowOnError);self.m_enhanceFn={};self.enhanceWithin=enhanceWithin;function enhanceWithin(jp)
{$.each(self.m_enhanceFn,function(sel,fn){var jo=jp.find(sel);if(jp.is(sel))
jo=jo.add(jp);if(jo.size()==0)
return;jo.each(function(i,e){var je=$(e);var enhanced=je.data("mui-enhanced");if(enhanced){if(enhanced.indexOf(sel)>=0)
return;enhanced.push(sel);}
else{enhanced=[sel];}
je.data("mui-enhanced",enhanced);fn(je);});});}
self.getOptions=getOptions;function getOptions(jo,defVal)
{var opt=jo.prop("muiOptions");if(opt===undefined){opt=$.extend({},defVal,self.evalAttr(jo,"data-options"));jo.prop("muiOptions",opt);}
else if($.isPlainObject(defVal)){$.each(defVal,function(k,v){if(opt[k]===undefined)
opt[k]=v;});}
return opt;}
self.setOptions=setOptions;function setOptions(jo,val)
{if($.isPlainObject(val))
jo.prop("muiOptions",val);}
function getexp(k,v,hint)
{if(typeof(v)=="number")
return k+"="+v;var op="=";var is_like=false;var ms;if(ms=v.match(/^(<>|>=?|<=?|!=?)/)){op=ms[1];v=v.substr(op.length);if(op=="!"||op=="!=")
op="<>";}
else if(v.indexOf("*")>=0||v.indexOf("%")>=0){v=v.replace(/[*]/g,"%");op=" LIKE ";}
v=$.trim(v);if(v==="null")
{if(op=="<>")
return k+" is not null";return k+" is null";}
if(v==="empty")
v="";var isId=(k=="id"||k.substr(-2)=="Id");if(isId&&v.match(/^\d+$/))
return k+op+v;var doFuzzy=self.options.fuzzyMatch&&op=="="&&!(hint=="e");if(doFuzzy){op=" LIKE ";v="%"+v+"%";}
return k+op+Q(v);}
self.queryHint="查询示例\n"+"文本：\"王小明\", \"王*\"(匹配开头), \"*上海*\"(匹配部分)\n"+"数字：\"5\", \">5\", \"5-10\", \"5-10,12,18\"\n"+"时间：\">=2017-10-1\", \"<2017-10-1 18:00\", \"2017-10\"(10月), \"2017-7-1~2017-10-1\"(7-9月即3季度)\n"+'支持"今天"，"本周"，"本月", "今年", "近3天(小时|周|月|季度|年)”，"前3天(小时|周|月|季度|年)"等。\n'+"高级：\"!5\"(排除5),\"1-10 and !5\", \"王*,张*\"(王某或张某), \"empty\"(为空), \"0,null\"(0或未设置)\n";self.getQueryCond=getQueryCond;function getQueryCond(kvList)
{var condArr=[];if($.isPlainObject(kvList)){$.each(kvList,handleOne);}
else if($.isArray(kvList)){$.each(kvList,function(i,e){handleOne(e[0],e[1]);});}
function handleOne(k,v){if(v==null||v===""||v.length==0)
return;var hint=null;var k1=k.split('/');if(k1.length>1){k=k1[0];hint=k1[1];}
if($.isArray(v)){if(v[0])
condArr.push(k+">='"+v[0]+"'");if(v[1])
condArr.push(k+"<'"+v[1]+"'");return;}
var arr=v.toString().split(/\s+(and|or)\s+/i);var str='';var bracket=false;var isTm=hint=="tm"||/(Tm|^tm|时间)\d*$/.test(k);var isDt=hint=="dt"||/(Dt|^dt|日期)\d*$/.test(k);$.each(arr,function(i,v1){if((i%2)==1){str+=' '+v1.toUpperCase()+' ';bracket=true;return;}
v1=v1.replace(/，/g,',');v1=v1.replace(/＊/g,'*');var str1='';var bracket2=false;$.each(v1.split(/\s*,\s*/),function(j,v2){if(str1.length>0){str1+=" OR ";bracket2=true;}
var mt;var isHandled=false;if(hint!="s"&&(isTm||isDt)){if(mt=v2.match(/^(\d{4})-(\d{1,2})(?:-(\d{1,2}))?$/)){var y=parseInt(mt[1]),m=parseInt(mt[2]),d=mt[3]!=null?parseInt(mt[3]):null;if((y>1900&&y<2100)&&(m>=1&&m<=12)&&(d==null||(d>=1&&d<=31&&isTm))){isHandled=true;var dt1,dt2;if(d){var dt=new Date(y,m-1,d);dt1=dt.format("D");dt2=dt.addDay(1).format("D");}
else{var dt=new Date(y,m-1,1);dt1=dt.format("D");dt2=dt.addMonth(1).format("D");}
str1+="("+k+">='"+dt1+"' AND "+k+"<'"+dt2+"')";}}
else if(mt=self.getTmRange(v2)){str1+="("+k+">='"+mt[0]+"' AND "+k+"<'"+mt[1]+"')";isHandled=true;}}
if(!isHandled&&hint!="s"){if(mt=v2.match(/^(\d{4}-\d{1,2}.*?)\s*~\s*(\d{4}-\d{1,2}.*?)$/)){var dt1=mt[1],dt2=mt[2];str1+="("+k+">='"+dt1+"' AND "+k+"<'"+dt2+"')";isHandled=true;}
else if(mt=v2.match(/^(\d+)-(\d+)$/)){var a=parseInt(mt[1]),b=parseInt(mt[2]);if(a<b){str1+="("+k+">="+mt[1]+" AND "+k+"<="+mt[2]+")";isHandled=true;}}}
if(!isHandled){str1+=getexp(k,v2,hint);}});if(bracket2)
str+="("+str1+")";else
str+=str1;});if(bracket)
str='('+str+')';condArr.push(str);}
return condArr.join(' AND ');}
self.getQueryParam=getQueryParam;function getQueryParam(kvList)
{var ret={};var cond=getQueryCond(kvList);if(cond)
ret.cond=cond;return ret;}
self.doSpecial=doSpecial;function doSpecial(jo,filter,fn,cnt,interval)
{var MAX_CNT=cnt||5;var INTERVAL=interval||2;jo.on("click.special",filter,function(ev){var tm=new Date();var obj=this;if(fn.cnt==null||fn.lastTm==null||tm-fn.lastTm>INTERVAL*1000||fn.lastObj!=obj)
{fn.cnt=0;fn.lastTm=tm;fn.lastObj=obj;}
if(++fn.cnt<MAX_CNT)
return;fn.cnt=0;fn.lastTm=tm;fn.call(this,ev);});}
self.execCopy=execCopy;function execCopy(text)
{$(window).one("copy",function(ev){ev.originalEvent.clipboardData.setData('text/plain',text);app_show("已复制到剪贴板，按Ctrl-V粘贴。");return false;});document.execCommand("copy");}}
function JdcloudCall()
{var self=this;var mCommon=jdModule("jdcloud.common");self.lastError=null;var m_tmBusy;var m_manualBusy=0;var m_appVer;var m_silentCall=0;self.disableBatch=false;var m_curBatch=null;self.m_curBatch=m_curBatch;var RV_ABORT=undefined;self.mockData={};var ajaxOpt={beforeSend:function(xhr){this.xhr_=xhr;var type=this.dataType;if(this.jdFilter!==false&&(type=="json"||type=="text")){this.jdFilter=true;this.converters["text json"]=true;}},dataFilter:function(data,type){if(this.jdFilter){rv=defDataProc.call(this,data);if(rv!==RV_ABORT)
return rv;--$.active;self.app_abort();}
return data;},error:defAjaxErrProc};if(location.protocol=="file:"){ajaxOpt.xhrFields={withCredentials:true};}
$.ajaxSetup(ajaxOpt);self.enterWaiting=enterWaiting;function enterWaiting(ctx)
{if(ctx&&ctx.noLoadingImg){++m_silentCall;return;}
if(self.isBusy==0){m_tmBusy=new Date();}
self.isBusy=1;if(ctx==null||ctx.isMock)
++m_manualBusy;setTimeout(function(){if(self.isBusy)
self.showLoading();},(self.options.showLoadingDelay||200));}
self.leaveWaiting=leaveWaiting;function leaveWaiting(ctx)
{if(ctx==null||ctx.isMock)
{if(--m_manualBusy<0)
m_manualBusy=0;}
mCommon.delayDo(function(){if(self.options.logAction&&ctx&&ctx.ac&&ctx.tv){var tv2=(new Date()-ctx.tm)-ctx.tv;ctx.tv2=tv2;console.log(ctx);}
if(ctx&&ctx.noLoadingImg)
--m_silentCall;if($.active<0)
$.active=0;loopDo(function(){if($.active-m_silentCall>0||m_manualBusy!=0)
return;if(self.isBusy){self.isBusy=0;var tv=new Date()-m_tmBusy;m_tmBusy=0;console.log("idle after "+tv+"ms");self.hideLoading();$(document).trigger("idle");}
return true;});});}
function loopDo(fn)
{if(fn())
return;setTimeout(loopDo.bind(this,fn),50);}
function defAjaxErrProc(xhr,textStatus,e)
{var ctx=this.ctx_||{};ctx.status=xhr.status;ctx.statusText=xhr.statusText;if(xhr.status==0&&!ctx.noex){self.app_alert("连不上服务器了，是不是网络连接不给力？","e");}
else if(this.handleHttpError){var data=xhr.responseText;var rv=defDataProc.call(this,data);if(rv!==RV_ABORT)
this.success&&this.success(rv);return;}
else if(!ctx.noex){self.app_alert("操作失败: 服务器错误. status="+xhr.status+"-"+xhr.statusText,"e");}
leaveWaiting(ctx);}
self.defDataProc=defDataProc;function defDataProc(rv)
{var ctx=this.ctx_||{};var ext=ctx.ext;while(this.xhr_&&(ext==null||ext=="default")){var val=this.xhr_.getResponseHeader("X-Powered-By");if(g_data.poweredBy==null)
g_data.poweredBy=val;else if(g_data.poweredBy!=val)
break;val=this.xhr_.getResponseHeader("X-Daca-Server-Rev");if(val&&g_data.serverRev!=val){if(g_data.serverRev){mCommon.reloadSite();}
console.log("Server Revision: "+val);g_data.serverRev=val;}
var modeStr;val=mCommon.parseValue(this.xhr_.getResponseHeader("X-Daca-Test-Mode"));if(g_data.testMode!=val){g_data.testMode=val;if(g_data.testMode)
modeStr=T("测试模式");self.options.xparam=0;}
val=mCommon.parseValue(this.xhr_.getResponseHeader("X-Daca-Mock-Mode"));if(g_data.mockMode!=val){g_data.mockMode=val;if(g_data.mockMode)
modeStr=T("测试模式")+","+T("模拟模式");}
if(modeStr){self.dfdLogin.then(function(){self.app_alert(modeStr,{timeoutInterval:2000});});}
break;}
try{if(rv!==""&&typeof(rv)=="string")
rv=$.parseJSON(rv);}
catch(e)
{leaveWaiting(ctx);var msg=T("服务器数据错误。");self.app_alert(msg);ctx.dfd.reject.call(this,msg);return;}
if(ctx.tm){ctx.tv=new Date()-ctx.tm;}
ctx.ret=rv;leaveWaiting(ctx);if(ext){var filter=self.callSvrExt[ext]&&self.callSvrExt[ext].dataFilter;if(filter){var ret=filter.call(this,rv);if(ret==null||ret===false)
self.lastError=ctx;return ret;}}
if(rv&&$.isArray(rv)&&rv.length>=2&&typeof rv[0]=="number"){var that=this;if(rv[0]==0){ctx.dfd&&setTimeout(function(){ctx.dfd.resolve.call(that,rv[1]);});return rv[1];}
ctx.dfd&&setTimeout(function(){if(!that.noex)
ctx.dfd.reject.call(that,rv[1]);else
ctx.dfd.resolve.call(that,false);});if(this.noex)
{this.lastError=rv;self.lastError=ctx;return false;}
if(rv[0]==E_NOAUTH){if(self.tryAutoLogin()){$.ajax(this);}
return RV_ABORT;}
else if(rv[0]==E_AUTHFAIL){var errmsg=rv[1]||"验证失败，请检查输入是否正确!";self.app_alert(errmsg,"e");return RV_ABORT;}
else if(rv[0]==E_ABORT){console.log("!!! abort call");return RV_ABORT;}
logError();self.app_alert(T("操作失败")+": "+rv[1],"e");}
else{logError();self.app_alert(T("服务器通讯协议异常!"),"e");}
return RV_ABORT;function logError()
{self.lastError=ctx;console.log("failed call");console.log(ctx);}}
self.getBaseUrl=getBaseUrl;function getBaseUrl()
{return self.options.serverUrl.replace(/\/[^\/]+$/,'/');}
self.makeUrl=makeUrl;function makeUrl(action,params)
{var ext;if($.isArray(action)){if(window.MUI){ext=action[1];action=action[0];}
else{ext="default";action=action[0]+"."+action[1];}}
else if(action){var m=action.match(/^(\w+):(\w.*)/);if(m){ext=m[1];action=m[2];}
else{ext="default";}}
else{throw"makeUrl error: no action";}
if(action.makeUrl||/^http/.test(action)){if(params==null)
return action;if(action.makeUrl)
return makeUrl(action.action,$.extend({},action.params,params));var url=mCommon.appendParam(action,$.param(params));return makeUrlObj(url);}
if(params==null)
params={};var xparam=0;var url;var fnMakeUrl=self.callSvrExt[ext]&&self.callSvrExt[ext].makeUrl;if(fnMakeUrl){url=fnMakeUrl(action,params);}
else if(self.options.moduleExt&&$.isFunction(self.options.moduleExt["callSvr"])&&(url=self.options.moduleExt["callSvr"](action))!=null){}
else if(action[0]!='.'&&action[0]!='/'&&action.indexOf(".php")<0)
{var opt=self.options;var usePathInfo=!opt.serverUrlAc&&!opt.xparam;if(usePathInfo){if(opt.serverUrl.slice(-1)=='/')
url=opt.serverUrl+action;else
url=opt.serverUrl+"/"+action;}
else{url=opt.serverUrl;var ac=opt.serverUrlAc||"ac";if(!params[ac]){params[ac]=action;}
else{params["_ac"]=action;}}
xparam=opt.xparam;}
else{if(location.protocol=="file:"){url=getBaseUrl()+action;}
else
url=action;}
if(window.g_cordova){if(m_appVer===undefined)
{var platform="n";if(mCommon.isAndroid()){platform="a";}
else if(mCommon.isIOS()){platform="i";}
m_appVer=platform+"/"+g_cordova;}
params._ver=m_appVer;}
if(self.options.appName)
params._app=self.options.appName;if(g_args._debug)
params._debug=g_args._debug;if(g_args.phpdebug)
params.XDEBUG_SESSION_START=1;var p=$.param(params);if(xparam)
p="xp="+(p?self.base64Encode(p,true):1);var ret=mCommon.appendParam(url,p);return makeUrlObj(ret);function makeUrlObj(url)
{var o=new String(url);o.makeUrl=true;if(action.makeUrl){o.action=action.action;o.params=$.extend({},action.params,params);}
else{o.action=action;o.params=params;}
delete o.params.ac;return o;}}
self.callSvr=callSvr;self.callSvrExt={};function callSvr(ac,params,fn,postParams,userOptions)
{if($.isFunction(params)){userOptions=postParams;postParams=fn;fn=params;params=null;}
mCommon.assert(ac!=null,"*** bad param `ac`");var ext=null;var ac0=ac.action||ac;var m;if($.isArray(ac)){mCommon.assert(ac.length==2,"*** bad ac format, require [ac, ext]");ext=ac[1];if(ext!='default')
ac0=ext+':'+ac[0];else
ac0=ac[0];}
else if(m=ac.match(/^(\w+):(\w.*)/)){ext=m[1];}
else if(self.callSvrExt['default']){ext='default';}
var isSyncCall=(userOptions&&userOptions.async==false);if(m_curBatch&&!isSyncCall)
{return m_curBatch.addCall({ac:ac,get:params,post:postParams},fn,userOptions);}
var url=makeUrl(ac,params);var ctx={ac:ac0,tm:new Date()};if(userOptions&&userOptions.noLoadingImg)
ctx.noLoadingImg=1;if(userOptions&&userOptions.noex)
ctx.noex=1;if(ext){ctx.ext=ext;}
ctx.dfd=$.Deferred();if(self.mockData&&self.mockData[ac0]){ctx.isMock=true;ctx.getMockData=function(){var d=self.mockData[ac0];var param1=$.extend({},url.params);var postParam1=$.extend({},postParams);if($.isFunction(d)){d=d(param1,postParam1);}
if(self.options.logAction)
console.log({ac:ac0,ret:d,params:param1,postParams:postParam1,userOptions:userOptions});return d;}}
enterWaiting(ctx);var callType="call";if(isSyncCall)
callType+="-sync";if(ctx.isMock)
callType+="-mock";var method=(postParams==null?'GET':'POST');var opt={dataType:'text',url:url,data:postParams,type:method,success:fn,xhrFields:{withCredentials:true},ctx_:ctx};if(window.FormData&&postParams instanceof FormData){opt.processData=false;opt.contentType=false;}
$.extend(opt,userOptions);if(ext&&self.callSvrExt[ext].beforeSend){self.callSvrExt[ext].beforeSend(opt);}
if(opt.contentType==null&&opt.data){var useJson=$.isArray(opt.data);if(!useJson&&$.isPlainObject(opt.data)){$.each(opt.data,function(i,e){if(typeof(e)=="object"){useJson=true;return false;}})}
if(useJson){opt.contentType="application/json";}}
console.log(callType+": "+opt.type+" "+ac0);if(ctx.isMock)
return callSvrMock(opt,isSyncCall);var isJson=opt.contentType&&opt.contentType.indexOf("/json")>0;if(isJson&&opt.data instanceof Object)
opt.data=JSON.stringify(opt.data);if(opt.data&&opt.processData!==false&&opt.url.indexOf("?xp=")>0){if(typeof(opt.data)==="string"){if(opt.contentType==null){var pos;if(opt.data[0]=='{'||opt.data[0]=='['){opt.contentType="application/json";}
else if((pos=opt.data.indexOf('=')>0)&&pos<100){opt.contentType="application/x-www-form-urlencoded";}
else{opt.contentType="text/plain";}}
opt.data=self.base64Encode(opt.data,true);}
else{opt.data=self.base64Encode(JSON.stringify(opt.data),true);opt.contentType="application/json";}
opt.contentType+=";xparam=1";}
$.ajax(opt);return ctx.dfd;}
function callSvrMock(opt,isSyncCall)
{var dfd_=opt.ctx_.dfd;var opt_=opt;if(isSyncCall){callSvrMock1();}
else{setTimeout(callSvrMock1,self.options.mockDelay);}
return dfd_;function callSvrMock1()
{var data=opt_.ctx_.getMockData();if(typeof(data)!="string")
data=JSON.stringify(data);var rv=defDataProc.call(opt_,data);if(rv!==RV_ABORT)
{opt_.success&&opt_.success(rv);return;}
self.app_abort();}}
self.callSvrSync=callSvrSync;function callSvrSync(ac,params,fn,postParams,userOptions)
{var ret;if($.isFunction(params)){userOptions=postParams;postParams=fn;fn=params;params=null;}
userOptions=$.extend({async:false},userOptions);var dfd=callSvr(ac,params,function(data){ret=data;fn&&fn.call(this,data);},postParams,userOptions);return ret;}
self.setupCallSvrViaForm=setupCallSvrViaForm;function setupCallSvrViaForm($form,$iframe,url,fn,callOpt)
{$form.attr("action",url);$iframe.on("load",function(){var data=this.contentDocument.body.innerText;if(data=="")
return;var rv=defDataProc.call(callOpt,data);if(rv===RV_ABORT)
self.app_abort();fn(rv);});}
self.batchCall=batchCall;function batchCall(opt)
{mCommon.assert(m_curBatch==null,"*** multiple batch call!");this.opt_=opt;this.calls_=[];this.callOpts_=[];if(!self.disableBatch)
m_curBatch=this;}
batchCall.prototype={addCall:function(call0,fn,opt0){var call=$.extend({},call0);var opt=$.extend({},opt0);if(opt.ref){call.ref=opt.ref;}
if(call.ac&&call.ac.makeUrl){call.get=$.extend({},call.ac.params,call.get);call.ac=call.ac.action;}
this.calls_.push(call);var callOpt={fn:fn,opt:opt,dfd:$.Deferred()};this.callOpts_.push(callOpt);return callOpt.dfd;},deferred:function(){return this.dfd_;},commit:function(){if(m_curBatch==null)
return;m_curBatch=null;if(this.calls_.length<1){console.log("!!! warning: batch has "+this.calls_.length+" calls!");return;}
if(this.calls_.length==1){var call=this.calls_[0];var callOpt=this.callOpts_[0];var dfd=callSvr(call.ac,call.get,callOpt.fn,call.post,callOpt.opt);dfd.then(function(data){callOpt.dfd.resolve(data);});return;}
var batch_=this;var postData=this.calls_;callSvr("batch",this.opt_,api_batch,postData,{contentType:"application/json; charset=utf-8"});function api_batch(data)
{var ajaxCtx_=this;$.each(data,function(i,e){var callOpt=batch_.callOpts_[i];var extendCtx=false;if(callOpt.opt&&!$.isEmptyObject(callOpt.opt)){extendCtx=true;$.extend(ajaxCtx_,callOpt.opt);}
var data1=defDataProc.call(ajaxCtx_,e);if(data1!==RV_ABORT){if(callOpt.fn){callOpt.fn.call(ajaxCtx_,data1);}
callOpt.dfd.resolve(data1);}
if(extendCtx){$.each(Object.keys(callOpt.opt),function(){ajaxCtx_[this]=null;});}});}},cancel:function(){m_curBatch=null;}}
self.useBatchCall=useBatchCall;function useBatchCall(opt,tv)
{if(self.disableBatch)
return;if(m_curBatch!=null)
return;tv=tv||0;var batch=new self.batchCall(opt);setTimeout(function(){batch.commit();},tv);}}
function JdcloudPage()
{var self=this;self.ctx=self.ctx||{};var mCommon=jdModule("jdcloud.common");var m_batchMode=false;self.isBatchMode=function(){return m_batchMode;}
self.toggleBatchMode=toggleBatchMode;function toggleBatchMode(val){if(val!==undefined)
m_batchMode=val;else
m_batchMode=!m_batchMode;app_alert(T("批量模式")+": "+(m_batchMode?"ON":"OFF"));self.tabMain.toggleClass("batchMode",m_batchMode);var opt=WUI.getActivePage().find(".datagrid-f").datagrid("options");opt.ctrlSelect=!m_batchMode;$.fn.datagrid.defaults.singleSelect=false;$.fn.datagrid.defaults.ctrlSelect=!m_batchMode;}
mCommon.assert($.fn.combobox,"require jquery-easyui lib.");self.getRow=getRow;function getRow(jtbl,silent)
{var row=jtbl.datagrid('getSelected');if(!row&&!silent)
{self.app_alert(T("请先选择一行。"),"w");return null;}
return row;}
self.isTreegrid=isTreegrid;function isTreegrid(jtbl)
{var d;if(jtbl==null||jtbl.size()==0||(d=jtbl.data())==null)
return false;return!!d.treegrid;}
self.reload=reload;function reload(jtbl,url,queryParams,doAppendFilter)
{var datagrid=isTreegrid(jtbl)?"treegrid":"datagrid";if(url!=null||queryParams!=null){var opt=jtbl[datagrid]("options");if(url!=null){opt.url=url;}
if(queryParams!=null){opt.queryParams=doAppendFilter?self.extendQueryParam(opt.queryParams,queryParams):queryParams;}}
if(jtbl.is(":hidden")){var opage=mCommon.getAncestor(jtbl[0],istab);if(opage&&opage.title)
$(opage).closest(".easyui-tabs").tabs("select",opage.title);}
resetPageNumber(jtbl);jtbl[datagrid]('reload');jtbl[datagrid]('clearSelections');}
self.reloadTmp=reloadTmp;function reloadTmp(jtbl,url,queryParams)
{var opt=jtbl.datagrid("options");var url_bak=opt.url;var param_bak=opt.queryParams;reload(jtbl,url,queryParams);opt.url=url_bak;opt.queryParams=param_bak;}
function jdListToDgList(data)
{if(!data)
data=[];var ret=data;if($.isArray(data)){ret={total:data.length,rows:data};}
else if($.isArray(data.list)){ret={total:data.total||data.list.length,rows:data.list};}
else if(data.h!==undefined)
{var arr=mCommon.rs2Array(data);ret={total:data.total||arr.length,rows:arr};}
return ret;}
function jdListToArray(data)
{var ret=data;if($.isArray(data)){ret=data;}
else if($.isArray(data.list)){ret=data.list;}
else if(data.h!==undefined)
{ret=mCommon.rs2Array(data);}
return ret;}
function jdListToTree(data,idField,fatherField,parentId,isLeaf)
{var data1=jdListToDgList(data)
var idMap={};$.each(data1.rows,function(i,e){idMap[e[idField]]=true;});$.each(data1.rows,function(i,e){var fatherId=e[fatherField];if(fatherId&&(idMap[fatherId]||parentId)){e._parentId=fatherId;}
if(isLeaf&&!isLeaf(e)){e.state='closed';}})
return data1;}
self.reloadRow=reloadRow;function reloadRow(jtbl,rowData)
{var datagrid=isTreegrid(jtbl)?"treegrid":"datagrid";if(rowData==null){rowData=jtbl[datagrid]('getSelected');if(rowData==null)
return;}
jtbl[datagrid]("loading");var opt=jtbl[datagrid]("options");return self.callSvr(opt.url,api_queryOne,{cond:"id="+rowData.id});function api_queryOne(data)
{jtbl[datagrid]("loaded");var idx=jtbl[datagrid]("getRowIndex",rowData);var objArr=jdListToArray(data);if(datagrid=="treegrid"){$.extend(rowData,objArr[0]);var fatherId=rowData[opt.fatherField];var id=rowData[opt.idField];if(rowData["_parentId"]&&rowData["_parentId"]!=fatherId){rowData["_parentId"]=fatherId;jtbl.treegrid("remove",id);jtbl.treegrid("append",{parent:rowData["_parentId"],data:[rowData]});}
else{jtbl.treegrid("update",{id:id,row:rowData});}
return;}
if(idx!=-1&&objArr.length==1){for(var k in rowData)
delete rowData[k];$.extend(rowData,objArr[0]);jtbl.datagrid("refreshRow",idx);}}}
function appendRow(jtbl,id)
{var datagrid=isTreegrid(jtbl)?"treegrid":"datagrid";jtbl[datagrid]("loading");var opt=jtbl[datagrid]("options");self.callSvr(opt.url,api_queryOne,{cond:"id="+id});function api_queryOne(data)
{jtbl[datagrid]("loaded");var objArr=jdListToArray(data);if(objArr.length!=1)
return;var row=objArr[0];if(datagrid=="treegrid"){if(jtbl.treegrid('getData').length==0){jtbl.treegrid('loadData',[row]);return;}
var fatherId=row[opt.fatherField];jtbl.treegrid('append',{parent:fatherId,data:[row]});return;}
if(opt.sortOrder=="desc")
jtbl.datagrid("insertRow",{index:0,row:row});else
jtbl.datagrid("appendRow",row);}}
function tabid(title)
{return"pg_"+title.replace(/[ ()\[\]\/\\,<>.!@#$%^&*-+]+/g,"_");}
function istab(o)
{var id=o.getAttribute("id");return id&&id.substr(0,3)=="pg_";}
function callInitfn(jo,paramArr)
{if(jo.jdata().init)
return;jo.jdata().init=true;var attr=jo.attr("my-initfn");if(attr==null)
return;try{initfn=eval(attr);}
catch(e){self.app_alert("bad initfn: "+attr,"e");}
if(initfn)
{console.log("### initfn: "+attr,jo.selector);try{initfn.apply(jo,paramArr||[]);}catch(ex){console.error(ex);throw(ex);}}}
function getModulePath(file)
{var url=self.options.moduleExt["showPage"](file);if(url)
return url;return self.options.pageFolder+"/"+file;}
self.showPage=showPage;function showPage(pageName,title_or_opt,paramArr)
{var showPageOpt={pageName:pageName};if($.isPlainObject(title_or_opt)){$.extend(true,showPageOpt,title_or_opt);}
else{showPageOpt.title=title_or_opt;}
var title=showPageOpt.title;if(title&&title.substr(-1,1)=="!"){showPageOpt.force=true;showPageOpt.title=title.substr(0,title.length-1);}
if(paramArr==null){paramArr=[showPageOpt];}
else if(!showPageOpt.pageFilter&&$.isArray(paramArr)&&$.isPlainObject(paramArr[1])){showPageOpt.pageFilter=paramArr[1];}
var dfdShowPage=$.Deferred();var showPageArgs_=[pageName,showPageOpt,paramArr];var sel="#my-pages > div."+pageName;var jpage=$(sel);if(jpage.length>0){initPage();}
else{sel="#tpl_"+pageName;var html=$(sel).html();if(html){loadPage(html,pageName,null);return dfdShowPage;}
var pageFile=getModulePath(pageName+".html");$.ajax(pageFile).then(function(html){loadPage(html,pageName,pageFile);}).fail(function(){});}
return dfdShowPage;function initPage()
{var title0=jpage.attr("title")||"无标题";if(!showPageOpt.title)
showPageOpt.title=title0;var title=showPageOpt.title;title=T(title).replace('%s',title0);var tt=showPageOpt.target?$("#"+showPageOpt.target):self.tabMain;if(tt.tabs('exists',title)){if(!showPageOpt.force){tt.tabs('select',title);dfdShowPage.resolve();return;}
tt.tabs('close',title);}
var id=tabid(title);var content="<div id='"+id+"' title='"+title+"' style='height:100%'/>";var jtab=$(content);var closable=(pageName!=self.options.pageHome);tt.tabs('add',{title:title,closable:closable,fit:true,content:jtab});var jpageNew=jpage.clone().appendTo(jtab);jpageNew.addClass('wui-page');jpageNew.attr("wui-pageName",pageName);jpageNew.attr("title",title);var dep=self.evalAttr(jpageNew,"wui-deferred");if(dep){self.assert(dep.then,"*** wui-deferred attribute DOES NOT return a deferred object");dep.then(initPage1);return;}
initPage1();function initPage1()
{jpageNew.data("showPageArgs_",showPageArgs_);enhancePage(jpageNew);$.parser.parse(jpageNew);self.enhanceWithin(jpageNew);callInitfn(jpageNew,paramArr);jpageNew.trigger('pagecreate');jpageNew.trigger('pageshow');dfdShowPage.resolve();}}
function loadPage(html,pageClass,pageFile)
{var jcontainer=$("#my-pages");jpage=$(html).filter("div");if(jpage.size()>1||jpage.size()==0){console.log("!!! Warning: bad format for page '"+pageClass+"'. Element count = "+jpage.size());jpage=jpage.filter(":first");}
jpage.find("style").each(function(){$(this).html(self.ctx.fixPageCss($(this).html(),"."+pageClass));});jpage.find("style").attr("wui-origin",pageClass).appendTo(document.head);jpage.attr("wui-pageFile",pageFile);jpage.addClass(pageClass).appendTo(jcontainer);var val=jpage.attr("wui-script");if(val!=null){var path=getModulePath(val);var dfd=mCommon.loadScript(path,initPage);dfd.fail(function(){self.app_alert("加载失败: "+val);self.leaveWaiting();});}
else{initPage();}}}
function getDgFilter(jtbl,param,ignoreQueryParam)
{var p1,p2;var p3=getPageFilter(jtbl.closest(".wui-page"));if(p3&&p3._pageFilterOnly){p3=$.extend(true,{},p3);delete p3._pageFilterOnly;}
else{var datagrid=isTreegrid(jtbl)?"treegrid":"datagrid";var dgOpt=jtbl[datagrid]("options");var p1=dgOpt.url&&dgOpt.url.params;if(p1)
delete p1._app;var p2=!ignoreQueryParam&&dgOpt.queryParams;}
return self.extendQueryParam({},p1,p2,p3,param);}
self.getPageFilter=getPageFilter;function getPageFilter(jpage,name)
{var showPageArgs=jpage.data("showPageArgs_");if(showPageArgs&&$.isPlainObject(showPageArgs[1].pageFilter)){var ret=showPageArgs[1].pageFilter;if(name){ret=$.isPlainObject(ret.cond)?ret.cond[name]:null;if(!isFixedField(ret))
ret=null;}
return ret;}}
function enhancePage(jpage)
{var o=jpage[0].firstElementChild;if(o&&o.tagName=="TABLE"&&jpage[0].children.length==1){if(o.style.height==""||o.style.height=="auto")
o.style.height="100%";}}
function enhanceDialog(jdlg)
{jdlg.find(".easyui-tabs, .wui-subobj>table").each(function(){if(!this.style.width)
this.style.width="100%";});jdlg.find("td>[required]").each(function(){$(this).parent().prev("td").addClass("required");});}
self.saveDlg=saveDlg;self.noCloseDlg=false;function saveDlg(jdlg,noCloseDlg)
{if(noCloseDlg){self.noCloseDlg=true;setTimeout(function(){self.noCloseDlg=false;},2000);}
jdlg.next(".dialog-button").find("#btnOk").click();}
self.closeDlg=closeDlg;function closeDlg(jdlg)
{if(self.noCloseDlg)
return;jdlg.dialog("close");}
function openDlg(jdlg)
{jdlg.dialog("open");}
function focusDlg(jdlg)
{var jo;jdlg.find(":input[type!=hidden]").each(function(i,o){var jo1=$(o);if(!jo1.prop("disabled")&&!jo1.prop("readonly")){jo=jo1;return false;}});if(jo==null)
jo=jdlg.find("a button");if(jo)
setTimeout(function(){jo.focus()},50);}
$.fn.okCancel=function(fnOk,fnCancel){this.unbind("keydown").keydown(function(e){if(e.keyCode==13&&e.target.tagName!="TEXTAREA"&&fnOk){$(e.target).blur().focus();fnOk();return false;}
else if(e.keyCode==27&&fnCancel){fnCancel();return false;}
else if((e.ctrlKey||e.metaKey)&&e.which==70)
{showObjDlg($(this),FormMode.forFind,$(this).data("objParam"));return false;}
else if((e.ctrlKey||e.metaKey)&&e.which==68)
{dupDlg($(this));return false;}});}
self.dupDlg=dupDlg;function dupDlg(jdlg)
{var formMode=jdlg.jdata().mode;if(formMode!=FormMode.forSet)
return false;var data=$.extend(true,{},jdlg.data("origin_"));jdlg.find(".wui-subobj").each(function(){var jsub=$(this);var subOpt=WUI.getOptions(jsub);var isLoaded=jsub.data("subobjLoaded_");if(!(subOpt.valueField&&subOpt.dlg&&subOpt.dgCall&&isLoaded&&subOpt.relatedKey))
return;var ms=subOpt.relatedKey.match(/^([^ =]+)/);if(!ms)
return;var relatedKey=ms[1];var rows=subOpt.dgCall("getData").rows;data[subOpt.valueField]=rows;setTimeout(function(ev){var rows1=data[subOpt.valueField];if(!$.isArray(rows1))
return;rows1.forEach(function(e){delete e.id;delete e[relatedKey];});subOpt.dgCall("loadData",rows);},50);});jdlg.trigger("duplicate",[data]);delete data.id;WUI.showObjDlg(jdlg,FormMode.forAdd,{data:data});}
self.isSmallScreen=isSmallScreen;function isSmallScreen(){return $(document.body).width()<640;}
if(isSmallScreen()){$('<meta name="viewport" content="width=device-width, initial-scale=0.8, maximum-scale=0.8">').appendTo(document.head);}
self.showDlg=showDlg;function showDlg(jdlg,opt)
{if(jdlg.constructor!=jQuery)
jdlg=$(jdlg);if(opt&&opt.reload){opt=$.extend({},opt);delete opt.reload;if(jdlg.size()>0){unloadDialog(jdlg);if(!jdlg.attr("id"))
return;jdlg=$("#"+jdlg.attr("id"));}}
if(loadDialog(jdlg,onLoad,opt))
return;function onLoad(){jdlg.trigger('create');showDlg(jdlg,opt);}
var formMode=opt&&opt.mode;opt=$.extend({okLabel:"确定",cancelLabel:"取消",noCancel:false,modal:opt&&opt.noCancel,reset:true,validate:true,forSet:(formMode==FormMode.forSet),data:{}},opt);jdlg.addClass('wui-dialog');callInitfn(jdlg,[opt]);if(opt.fixedFields)
$.extend(opt.data,opt.fixedFields);var jfrm=jdlg.is("form")?jdlg:jdlg.find("form:first");jfrm.trigger("beforeshow",[formMode,opt]);if(opt.cancel)
return;var btns=[{id:"btnOk",text:opt.okLabel,iconCls:'icon-ok',handler:fnOk}];if(!opt.noCancel)
btns.push({id:"btnCancel",text:opt.cancelLabel,iconCls:'icon-cancel',handler:fnCancel})
if($.isArray(opt.buttons))
btns.unshift.apply(btns,opt.buttons);var small=self.isSmallScreen();var dlgOpt=$.extend({maximizable:!small,collapsible:!small,resizable:!small,left:null,top:null,closable:!opt.noCancel,modal:opt.modal,buttons:btns,title:opt.title},opt.dialogOpt,WUI.getOptions(jdlg));if(jdlg.is(":visible")){dlgOpt0=jdlg.dialog("options");$.extend(dlgOpt,{left:dlgOpt0.left,top:dlgOpt0.top});}
var h=jdlg[0].style.height;if(h==""||h=="auto"){dlgOpt.shadow=false;}
jdlg.dialog(dlgOpt);var perm=jdlg.attr("wui-perm")||jdlg.dialog("options").title;jdlg.toggleClass("wui-readonly",(opt.objParam&&opt.objParam.readonly)||!self.canDo(perm,"对话框")||(formMode==FormMode.forSet&&!self.canDo(perm,"修改")));jdlg.okCancel(fnOk,opt.noCancel?undefined:fnCancel);if(opt.reset)
{mCommon.setFormData(jdlg);jdlg.find(".my-reset").empty();}
if(opt.data&&opt.reset)
{jfrm.trigger("initdata",[opt.data,formMode]);mCommon.setFormData(jdlg,opt.data,{setOrigin:opt.forSet});jfrm.trigger("loaddata",[opt.data,formMode]);}
setFixedFields(jdlg,opt);focusDlg(jdlg);jfrm.trigger("show",[formMode,opt.data]);opt.onShow&&opt.onShow.call(jdlg,formMode,opt.data);function fnCancel(){closeDlg(jdlg)}
function fnOk()
{if(jdlg.hasClass("wui-readonly")&&formMode!=FormMode.forFind){closeDlg(jdlg);return;}
var ret=true;if(opt.validate){var jo=jfrm.find(".validatebox-text:hidden").filter(function(){var ji=$(this);return ji.css("display")=="none"||ji.closest("tr,.wui-field").css("display")=="none";});jo.validatebox("disableValidation");ret=jfrm.form("validate");jo.validatebox("enableValidation");}
if(!ret){var ji=jfrm.find(".validatebox-invalid:first");var vb=ji.data("validatebox");if(vb&&vb.message&&ji.is(":hidden,[readonly],:disabled")){var it=ji.gn();var code="验证失败: <br><span style='color:red'>字段\""+it.getTitle()+"\": "+vb.message+'</span>';app_alert(code,"w",function(){it.setFocus();});}
return false;}
var newData={};var dfd=self.triggerAsync(jfrm,"validate",[formMode,opt.data,newData]);if(dfd===false)
return false;dfd.then(afterValidate);function afterValidate(){var ev=$.Event("savedata");jfrm.trigger(ev,[formMode,opt.data]);if(ev.isDefaultPrevented())
return false;var data=formMode!=FormMode.forFind?mCommon.getFormData(jdlg):getFindData(jdlg);$.extend(data,newData);if(opt.url){if(opt.forSet){if($.isEmptyObject(data)){closeDlg(jdlg);return false;}}
if(opt.onSubmit&&opt.onSubmit.call(jdlg,data)===false)
return false;var m=opt.url.action.match(/\.(add|set|del)$/);if(m){var cmd={add:"新增",set:"修改",del:"删除"}[m[1]];if(!self.canDo(perm,cmd)){app_alert("无权限操作! 本操作需要权限："+perm+"."+cmd,"w");throw"abort";}}
if(formMode==FormMode.forSet&&opt.url.action&&/.set$/.test(opt.url.action)){if($.isEmptyObject(data)){app_alert("没有需要更新的内容。");return;}
var jtbl=jdlg.jdata().jtbl;var obj=opt.url.action.replace(".set","");var rv=batchOp(obj,obj+".setIf",jtbl,{acName:"更新",data:data,offline:opt.offline,onBatchDone:function(){closeDlg(jdlg);}});if(rv!==false)
return;}
self.callSvr(opt.url,function(retData){success(data,retData);},data);}
else{success(data,data);}}
function success(reqData,retData)
{if(opt.data)
$.extend(opt.data,reqData);if(opt.onOk){jfrm.trigger('retdata',[retData,formMode]);if(opt.onOk==='close'){app_show(T("操作成功!"));WUI.closeDlg(jdlg);}
else{opt.onOk.call(jdlg,retData);}}}}}
self.showDlgByMeta=showDlgByMeta;function showDlgByMeta(itemArr,opt)
{var jdlg=$("<form><table></table></form>");if(!opt)
opt={};opt.meta=itemArr;self.showDlg(jdlg,opt);return jdlg;}
self.UDF={onGetMeta:function(obj){},addFieldByMeta:addFieldByMeta,addColByMeta:function(columns){}};function addFieldByMeta(jdlg,jp,itemArr)
{var code='';for(var i=0;i<itemArr.length;++i){var item=itemArr[i];var hint='';if(item.hint)
hint="<p class=\"hint\">"+item.hint+"</p>";code+="<tr><td>"+(item.title||'')+"</td><td>"+(item.dom||'')+hint+"</td></tr>";}
if(code){$(code).appendTo(jp);$.parser.parse(jp);self.enhanceWithin(jp);}}
var tmrBatch_;$(document).keydown(function(e){if(e.ctrlKey||e.metaKey){m_batchMode=true;clearTimeout(tmrBatch_);tmrBatch_=setTimeout(function(){m_batchMode=false;tmrBatch_=null;},500);}});$(window).keyup(function(e){if(e.ctrlKey||e.metaKey){m_batchMode=false;clearTimeout(tmrBatch_);}});self.batchOp=batchOp;function batchOp(obj,ac,jtbl,opt)
{if(obj==null)
return false;opt=$.extend({batchOpMode:0,acName:"操作"},opt);var acName=opt.acName;var queryParams=opt.queryParam;if(queryParams){queryCnt();return;}
if(jtbl==null){console.warn("batchOp: require jtbl or opt.queryParam")
return false;}
var selArr=jtbl.datagrid("getChecked");var batchOpMode=opt.batchOpMode;if(!batchOpMode&&!(m_batchMode||selArr.length>1)){return false;}
if(batchOpMode===2&&!m_batchMode&&selArr.length==0){self.app_alert(T("请先选择一行。"),"w");return false;}
var doBatchOnSel=selArr.length>1&&(selArr[0].id!=null||opt.offline);if(!doBatchOnSel&&batchOpMode===2&&!m_batchMode&&selArr.length==1&&selArr[0].id!=null)
doBatchOnSel=true;if(opt.offline){if(acName=="删除"){var totalCnt=jtbl.datagrid("getRows").length;if(doBatchOnSel&&selArr.length<totalCnt){$.each(selArr,function(i,row){var idx=jtbl.datagrid("getRowIndex",row);jtbl.datagrid("deleteRow",idx)});}
else{jtbl.datagrid("loadData",[]);}}
return;}
if(doBatchOnSel){if(selArr.length==1){queryParams={cond:"id="+selArr[0].id};}
else{var idList=$.map(selArr,function(e){return e.id}).join(',');queryParams={cond:"id IN ("+idList+")"};}
confirmBatch(selArr.length);}
else{queryParams=getDgFilter(jtbl);if(!queryParams.cond)
queryParams.cond="t0.id>0";queryCnt();}
return;function queryCnt(){var param=$.extend({},queryParams,{res:"count(*) cnt"});self.callSvr(obj+".query",param,function(data1){confirmBatch(data1.d[0][0]);});}
function confirmBatch(batchCnt){console.log(ac+": "+JSON.stringify(queryParams));if(batchCnt==0){app_alert("没有记录需要操作。");return;}
var data=opt.data;if(!$.isFunction(data)){if(batchCnt>1)
acName="批量"+acName;app_confirm(acName+batchCnt+"条记录？",function(b){if(!b)
return;doBatch(data);});}
else{var dataFn=data;data=dataFn(batchCnt);if(data==false)
return;$.when(data).then(doBatch);}}
function doBatch(data){self.callSvr(ac,queryParams,function(cnt){opt.onBatchDone&&opt.onBatchDone();if(jtbl){if(doBatchOnSel&&selArr.length==1){reloadRow(jtbl,selArr[0]);}
else{reload(jtbl);}}
app_alert(acName+cnt+"条记录");},data);}}
function isFixedField(value){if(value==null)
return false;if(typeof(value)!="string")
return true;return!/^([!<>=~]|IN|NOT IN)/i.test(value);}
function getFixedFields(jpage,fixedFields)
{if(!(jpage&&jpage.size()>0))
return fixedFields;var filter=getPageFilter(jpage);if(filter&&filter.cond){handleCond(filter.cond);}
return fixedFields;function handleCond(cond){if(!cond)
return;if($.isArray(cond)){$.each(cond,function(i,e){handleCond(e);});}
else if($.isPlainObject(cond)){$.each(cond,function(k,v){if(isFixedField(v)){if(fixedFields==null)
fixedFields={};fixedFields[k]=v;}});}}}
function setFixedFields(jfrm,beforeShowOpt){var objParam=beforeShowOpt.objParam;var fixedFields=beforeShowOpt.fixedFields;if(jfrm[0].cleanFn){$.each(jfrm[0].cleanFn,function(i,fn){fn();});jfrm[0].cleanFn=null;}
var cleanFn=[];var forFind=beforeShowOpt.mode==FormMode.forFind;self.formItems(jfrm,function(ji,name,it){var fixedVal=(ji.hasClass("wui-fixedField")&&objParam&&objParam[name]!=null)?objParam[name]:null;if(fixedVal==null){fixedVal=(fixedFields&&fixedFields[name]!=null)?fixedFields[name]:null;}
if(fixedVal!=null){var oldVal=it.getReadonly();it.setReadonly(true);if(forFind){var oldVal2=it.getDisabled();it.setDisabled(true);}
it.setValue(fixedVal);cleanFn.push(function(){it.setReadonly(oldVal);if(forFind){it.setDisabled(oldVal2);}});}});if(cleanFn.length>0)
jfrm[0].cleanFn=cleanFn;}
self.getTopDialog=getTopDialog;function getTopDialog()
{var val=0;var jo=$();$(".window:visible").each(function(i,e){var z=parseInt(this.style.zIndex);if(z>val){val=z;jo=$(this).find(".wui-dialog");}});return jo;}
self.unloadPage=unloadPage;function unloadPage(pageName)
{g_data.doUnload=true;setTimeout(function(){g_data.doUnload=false;});if(pageName==null){pageName=self.getActivePage().attr("wui-pageName");if(pageName==null)
return;self.tabClose();}
var sel="."+pageName;var jo=$(sel);if(jo.attr("wui-pageFile")==null)
return;var jtabs=WUI.tabMain.tabs("tabs");for(var i=jtabs.length-1;i>=0;--i){if(jtabs[i].find(sel).size()>0)
WUI.tabClose(i);}
jo.remove();$("style[wui-origin="+pageName+"]").remove();}
self.reloadPage=reloadPage;function reloadPage()
{var showPageArgs=self.getActivePage().data("showPageArgs_");self.unloadPage();self.showPage.apply(this,showPageArgs);}
self.unloadDialog=unloadDialog;self.reloadDialog=unloadDialog;function unloadDialog(jdlg)
{if(jdlg==null){jdlg=getTopDialog();}
else if(jdlg===true){jdlg=$(".wui-dialog[wui-pageFile]");}
else if(jdlg.hasClass("wui-dialog")){}
else{console.error("WUI.unloadDialog: bad dialog spec",jdlg);}
jdlg.each(function(){var jdlg=$(this);if(jdlg.size()==0)
return;if(jdlg.is(":visible")){try{closeDlg(jdlg);}catch(ex){console.log(ex);}}
if(jdlg.attr("wui-pageFile")==null)
return;var dlgId=jdlg.attr("id");try{jdlg.dialog("destroy");}catch(ex){console.log(ex);}
jdlg.remove();$("style[wui-origin="+dlgId+"]").remove();});}
self.canDo=canDo;function canDo(topic,cmd,defaultVal,permSet2)
{if(!g_data.permSet)
return true;if(defaultVal==null)
defaultVal=(checkPerm('*')!==false);if(cmd==null){if(topic){var rv=checkPerm(topic);if(rv!==undefined)
return rv;}
return defaultVal;}
if(topic){var rv=checkPerm(topic+"."+cmd);if(rv!==undefined)
return rv;}
rv=checkPerm(cmd);if(rv!==undefined)
return rv;if(topic)
rv=checkPerm(topic+".只读");if(rv===undefined)
rv=checkPerm("只读");if(rv&&(cmd=="新增"||cmd=="修改"||cmd=="删除"||cmd=="导入"||cmd=="对话框")){return false;}
if(topic){rv=checkPerm(topic);if(rv!==undefined)
return rv;}
return defaultVal;function checkPerm(perm){if(permSet2){var rv=permSet2[perm];if(rv!==undefined)
return rv;}
return g_data.permSet[perm];}}
var BTN_TEXT={A:"添加",S:"确定",F:"查询",D:"删除"};function getFindData(jfrm,doGetAll)
{var kvList={};var kvList2={};self.formItems(jfrm,function(ji,name,it){if((!doGetAll&&it.getDisabled())||ji.hasClass("notForFind"))
return;var v=it.getValue();if(v==null||v==="")
return;if(ji.attr("wui-find-hint")){name+="/"+ji.attr("wui-find-hint");}
if(ji.hasClass("wui-notCond"))
kvList2[name]=v;else
kvList[name]=v;})
var param=self.getQueryParam(kvList);if(kvList2)
$.extend(param,kvList2);return param;}
function loadDialog(jdlg,onLoad,opt)
{if(jdlg.size()>0&&jdlg[0].parentElement!=null&&jdlg[0].parentElement.parentElement!=null){if(!jdlg.hasClass("wui-dialog")){jdlg.addClass('wui-dialog');enhanceDialog(jdlg);}
return;}
opt=opt||{};if(!jdlg.selector){jdlg.addClass('wui-dialog');var jcontainer=$("#my-pages");jdlg.appendTo(jcontainer);loadDialogTpl1();return true;}
var jo=$(jdlg.selector);if(jo.size()>0){fixJdlg(jo);return;}
function fixJdlg(jo)
{jdlg.splice(0,jdlg.size(),jo[0]);}
var dlgId=jdlg.selector.substr(1);var arr=dlgId.split("_inst_");var tplName=arr[0];var sel="#tpl_"+tplName;var html=$(sel).html();if(html){loadDialogTpl(html,dlgId,pageFile);return true;}
var pageFile=getModulePath(tplName+".html");$.ajax(pageFile).then(function(html){loadDialogTpl(html,dlgId,pageFile);}).fail(function(){});function loadDialogTpl(html,dlgId,pageFile)
{var jcontainer=$("#my-pages");var jo=$(html).filter("div,form");if(jo.size()>1||jo.size()==0){console.log("!!! Warning: bad format for dialog '"+dlgId+"'. Element count = "+jo.size());jo=jo.filter(":first");}
fixJdlg(jo);jdlg.find("style").each(function(){$(this).html(self.ctx.fixPageCss($(this).html(),jdlg.selector));});jdlg.find("style").attr("wui-origin",dlgId).appendTo(document.head);jdlg.attr("id",dlgId).appendTo(jcontainer);jdlg.attr("wui-pageFile",pageFile);jdlg.addClass('wui-dialog');var dep=self.evalAttr(jdlg,"wui-deferred");if(dep){self.assert(dep.then,"*** wui-deferred attribute DOES NOT return a deferred object");dep.then(loadDialogTpl1);return;}
loadDialogTpl1();}
function loadDialogTpl1()
{var baseObj=jdlg.attr("my-obj")||opt.obj;var meta=opt.meta||(baseObj&&self.UDF.onGetMeta(baseObj));if(meta){var jp=jdlg.find(opt.metaParent||"table:first");if(jp.size()>0&&!jp.hasClass("wui-meta-parent")){self.UDF.addFieldByMeta(jdlg,jp,meta);jp.addClass("wui-meta-parent");}}
enhanceDialog(jdlg);$.parser.parse(jdlg);jdlg.find(">table:first, form>table:first").has(":input").addClass("wui-form-table");self.enhanceWithin(jdlg);var val=jdlg.attr("wui-script");if(val!=null){var path=getModulePath(val);var dfd=mCommon.loadScript(path,onLoad);dfd.fail(function(){self.app_alert("加载失败: "+val);});}
else{setTimeout(onLoad);}}
return true;}
self.doFind=doFind;function doFind(jo,jtbl,doAppendFilter)
{var force=(jtbl!=null);if(!jtbl){var jdlg=jo.closest(".wui-dialog");if(jdlg.size()>0)
jtbl=jdlg.jdata().jtbl;}
if(!jtbl||jtbl.size()==0){console.warn("doFind: no table");return;}
var param=getFindData(jo,true);if(!force&&$.isEmptyObject(param)){console.warn("doFind: no param");return;}
reload(jtbl,undefined,param,doAppendFilter);}
self.showObjDlg=showObjDlg;function showObjDlg(jdlg,mode,opt)
{if(jdlg.constructor!=jQuery)
jdlg=$(jdlg);if(loadDialog(jdlg,onLoad,opt))
return;function onLoad(){jdlg.trigger('create');showObjDlg(jdlg,mode,opt);}
opt=$.extend({mode:mode},jdlg.objParam,opt);jdlg.data("objParam",jdlg.objParam);callInitfn(jdlg,[opt]);if(opt.jtbl){jdlg.jdata().jtbl=opt.jtbl;}
var id=opt.id;var obj=opt.obj||jdlg.attr("my-obj");mCommon.assert(obj);var jd=jdlg.jdata();var jd2=jd.jtbl&&jd.jtbl.jdata();var rowData;if(id==null){if(mode==FormMode.forSet||mode==FormMode.forDel)
{mCommon.assert(jd.jtbl);if(mode==FormMode.forDel){var rv=batchOp(obj,obj+".delIf",jd.jtbl,{acName:"删除",onBatchDone:onCrud,offline:opt.offline});if(rv!==false)
return;}
rowData=getRow(jd.jtbl);if(rowData==null)
return;id=rowData.id;}}
var url;if(mode==FormMode.forAdd){if(!opt.offline)
url=self.makeUrl([obj,"add"],jd.url_param);}
else if(mode==FormMode.forSet){if(!opt.offline)
url=self.makeUrl([obj,"set"],{id:id});}
else if(mode==FormMode.forDel){if(opt.offline){if(jd.jtbl){var rowIndex=jd.jtbl.datagrid("getRowIndex",rowData);jd.jtbl.datagrid("deleteRow",rowIndex);onCrud();}
return;}
self.app_confirm(T("确定要删除一条记录?"),function(b){if(!b)
return;var ac=obj+".del";self.callSvr(ac,{id:id},function(data){if(jd.jtbl)
reload(jd.jtbl);self.app_show(T('删除成功!'));onCrud();});});return;}
var jfrm=jdlg.is("form")?jdlg:jdlg.find("form:first");var doReset=!(jd.mode==FormMode.forFind&&mode==FormMode.forFind)
if(mode==FormMode.forFind&&jd.mode!=FormMode.forFind){self.formItems(jfrm,function(je,name,it){var jshow=it.getShowbox();var bak=je.jdata().bak={disabled:it.getDisabled(),readonly:it.getReadonly(),title:jshow.prop("title"),type:null}
if(je.hasClass("notForFind")){it.setDisabled(true);jshow.css("backgroundColor","");}
else if(jshow.is("[type=hidden]")){}
else{jshow.addClass("wui-find-field").prop("title",self.queryHint);it.setDisabled(false);it.setReadonly(false);var type=jshow.attr("type");if(type&&["number","date","time","datetime"].indexOf(type)>=0){bak.type=type;jshow.attr("type","text");}}});jfrm.form("disableValidation");}
else if(jd.mode==FormMode.forFind&&mode!=FormMode.forFind){self.formItems(jfrm,function(je,name,it){var bak=je.jdata().bak;if(bak==null)
return;var jshow=it.getShowbox();jshow.removeClass("wui-find-field")
jshow.prop("title",bak.title);it.setDisabled(bak.disabled);it.setReadonly(bak.readonly);if(bak.type){jshow.attr("type",bak.type);}});jfrm.form("enableValidation");}
jd.mode=mode;var load_data={};if(mode==FormMode.forAdd){load_data=$.extend({},opt.data);if(jd.jtbl&&isTreegrid(jd.jtbl)&&(rowData=getRow(jd.jtbl,true))){if(rowData.state=="open"){load_data["fatherId"]=rowData.id;}
else{load_data["fatherId"]=rowData["fatherId"];}}}
else if(mode==FormMode.forSet){if(rowData){load_data=$.extend({},rowData);}
else{var load_url=self.makeUrl([obj,'get'],{id:id});var data=self.callSvrSync(load_url);if(data==null)
return;load_data=data;}
if(opt.data){setTimeout(function(){mCommon.setFormData(jdlg,opt.data,{setOnlyDefined:true});});}}
opt.reloadRow=function(){if(mode==FormMode.forSet&&opt.jtbl&&rowData)
self.reloadRow(opt.jtbl,rowData);};var jpage=opt.jtbl?opt.jtbl.closest(".wui-page"):null;opt.fixedFields=getFixedFields(jpage,opt.fixedFields);if(opt.fixedFields&&(mode==FormMode.forAdd||mode==FormMode.forFind)){$.extend(load_data,opt.fixedFields);}
var jchkClose=null;var showDlgOpt=$.extend({},opt,{url:url,okLabel:BTN_TEXT[mode],validate:mode!=FormMode.forFind,modal:false,reset:doReset,data:load_data,onOk:onOk,objParam:opt,onShow:onShow});jdlg.prop('objParam',opt);showDlg(jdlg,showDlgOpt);if(mode==FormMode.forSet)
jfrm.form("validate");function onShow(formMode,data){opt.onShow&&opt.onShow.call(this,formMode,data);var jbtns=jdlg.next(".dialog-button");jchkClose=jbtns.find(".chkClose");if(jchkClose.size()==0){var jo=$("<label style='float:left'><input type='checkbox' class='chkClose'> "+T("确定后关闭")+"</label>").prependTo(jbtns);jchkClose=jo.find(".chkClose");if(formMode==FormMode.forAdd){var val=jdlg.data("closeAfterAdd");if(val||self.options.closeAfterAdd)
jchkClose.prop("checked",true);}
else if(formMode==FormMode.forFind){var val=jdlg.data("closeAfterFind");if(val||self.options.closeAfterFind)
jchkClose.prop("checked",true);}
else if(formMode==FormMode.forSet){jchkClose.prop("checked",true);}
jchkClose.click(function(){var val=jchkClose.prop("checked");if(formMode==FormMode.forAdd){jdlg.data("closeAfterAdd",val);}
else if(formMode==FormMode.forFind){jdlg.data("closeAfterFind",val);}});}}
function onOk(retData){opt.onOk&&opt.onOk.call(this,retData);var jtbl=jd.jtbl;mCommon.assert(jchkClose.size()>0);var doClose=jchkClose.prop("checked");if(mode==FormMode.forFind){mCommon.assert(jtbl);reload(jtbl,undefined,retData);if(doClose)
closeDlg(jdlg);return;}
var dfdSet=null;if(jtbl){if(opt.offline){var retData_vf=self.getFormData_vf(jfrm);retData=$.extend(retData_vf,retData);if(mode==FormMode.forSet&&rowData){var idx=jtbl.datagrid("getRowIndex",rowData);$.extend(rowData,retData);jtbl.datagrid("refreshRow",idx);}
else if(mode==FormMode.forAdd){jtbl.datagrid("appendRow",retData);}}
else{if(mode==FormMode.forSet&&rowData)
dfdSet=reloadRow(jtbl,rowData);else if(mode==FormMode.forAdd){appendRow(jtbl,retData);}
else
reload(jtbl);}}
if(doClose){closeDlg(jdlg);}
else if(mode==FormMode.forAdd){showObjDlg(jdlg,mode);}
else if(mode==FormMode.forSet){if(dfdSet){dfdSet.then(function(){showObjDlg(jdlg,mode,opt);});}
else{setTimeout(function(){showObjDlg(jdlg,mode,opt);});}}
if(!opt.offline)
self.app_show(T('操作成功!'));onCrud();}
function onCrud(){if(self.isBusy){$(document).one("idle",onCrud);return;}
if(obj&&!opt.offline){console.log("refresh: "+obj);$(".my-combobox,.wui-combogrid").trigger("markRefresh",obj);}
opt.onCrud&&opt.onCrud();}}
self.dg_toolbar=dg_toolbar;function dg_toolbar(jtbl,jdlg)
{var toolbar=null;if(jtbl==null){toolbar="";}
else{toolbar=jtbl.jdata().toolbar;if(toolbar==null)
toolbar="rfasd";jtbl.jdata().toolbar="";}
var btns=[];var btnSpecArr=$.isArray(toolbar)?$.extend([],toolbar):toolbar.split("");for(var i=2;i<arguments.length;++i){btnSpecArr.push(arguments[i]);}
var permSet2=null;if(jtbl){var jp=jtbl.closest(".wui-page");if(jp.size()==0)
jp=jtbl.closest(".wui-dialog");var perm=jp.attr("wui-perm")||jp.attr("title");if(!perm&&jp.hasClass("wui-dialog")){var tmp=jp.dialog("options");if(tmp)
perm=tmp.title;}
jp.trigger("dg_toolbar",[btnSpecArr,jtbl,jdlg]);permSet2=(jtbl.jdata().readonly||jp.hasClass("wui-readonly"))?{"只读":true}:null;}
var ctx={jp:jp,jtbl:jtbl,jdlg:jdlg};for(var i=0;i<btnSpecArr.length;++i){var btn=btnSpecArr[i];if(!btn)
continue;if(btn!=='-'&&typeof(btn)=="string"){var btnfn=dg_toolbar[btn];mCommon.assert(btnfn,"toolbar button `"+btn+"` does not support");btn=btnfn(ctx);}
else if($.isArray(btn)&&typeof(btn[0])=="string"){var btnfn=dg_toolbar[btn[0]];mCommon.assert(btnfn,"toolbar button `"+btn[0]+"` does not support");btn=btnfn(ctx,btn[1]);}
if(btn.text!="-"&&perm&&!self.canDo(perm,btn["wui-perm"]||btn.text,null,permSet2)){continue;}
btns.push(btn);}
if(btns.length==0)
return null;return btns;}
self.setToolbarMenu=setToolbarMenu;function setToolbarMenu(jtbl,enableMap)
{jtbl.datagrid("getPanel").find(".datagrid-toolbar .l-btn .l-btn-text").each(function(i,o){var val=enableMap[o.innerText];if(val!==undefined){if($.isFunction(val)){val($(o).closest('.l-btn'));}
else{$(o).closest('.l-btn').linkbutton(val?'enable':'disable');}}});}
$.extend(dg_toolbar,{r:function(ctx){return{text:'刷新',iconCls:'icon-reload',handler:function(){reload(ctx.jtbl,null,m_batchMode?{}:null);}}},f:function(ctx){return{text:'查询',class:'splitbutton',iconCls:'icon-search',handler:function(){showObjDlg(ctx.jdlg,FormMode.forFind,{jtbl:ctx.jtbl});},menu:self.createFindMenu(ctx.jtbl)}},a:function(ctx){return{text:'新增',iconCls:'icon-add',handler:function(){showObjDlg(ctx.jdlg,FormMode.forAdd,{jtbl:ctx.jtbl});}}},s:function(ctx){return{text:'修改',iconCls:'icon-edit',handler:function(){showObjDlg(ctx.jdlg,FormMode.forSet,{jtbl:ctx.jtbl});}}},d:function(ctx){return{text:'删除',iconCls:'icon-remove',handler:function(){showObjDlg(ctx.jdlg,FormMode.forDel,{jtbl:ctx.jtbl});}}},'export':function(ctx){return{text:'导出',class:'splitbutton',iconCls:'icon-save',handler:getExportHandler(ctx.jtbl),menu:createExportMenu(ctx.jtbl)}}});function createExportMenu(jtbl)
{var jmenu=$('<div>'+'<div data-options="id:\'csv\'">逗号分隔(csv)</div>'+'<div data-options="id:\'txt\'">TAB分隔(txt)</div>'+'<div data-options="id:\'html\'">网页(html)</div>'+'</div>');jmenu.menu({onClick:function(item){console.log(item);var handler=getExportHandler(jtbl,null,{fmt:item.id});handler();}})
return jmenu;}
self.dg_dblclick=function(jtbl,jdlg)
{return function(idx,data){showObjDlg(jdlg,FormMode.forSet,{jtbl:jtbl});}}
self.m_enhanceFn["a[href]"]=enhanceAnchor;function enhanceAnchor(jo)
{if(jo.attr("onclick"))
return;if(jo.attr("target"))
return;var title=jo.text();jo.click(function(ev){var href=$(this).attr("href");if(href.search(/^#(page\w+)$/)>=0){var pageName=RegExp.$1;WUI.showPage.call(this,pageName);return false;}
if(href.match(/^https?:\/\//)){WUI.showPage("pageIframe",title,[href]);return false;}});}
self.getExportHandler=getExportHandler;function getExportHandler(jtbl,ac,param)
{param=$.extend({},{fmt:"excel",pagesz:-1},param);return function(){if(ac==null){if(jtbl.size()==0||!jtbl.hasClass("datagrid-f"))
throw"error: bad datagrid: \""+jtbl.selector+"\"";var datagrid=isTreegrid(jtbl)?"treegrid":"datagrid";ac=jtbl[datagrid]("options").url;if(ac==null){app_alert("该数据表不支持导出","w");return;}}
var p1=getQueryParamFromTable(jtbl,param);if(p1.gres&&!(param&&param.res))
p1.gresHidden=1;var debugShow=false;if(m_batchMode){var fmt=prompt("输入导出格式: excel csv txt excelcsv html outfile(无导出条数限制), 以!结尾为调试输出",p1.fmt);if(!fmt)
return;if(fmt.substr(-1)=="!"){fmt=fmt.substr(0,fmt.length-1);debugShow=true;}
p1.fmt=fmt;}
var url=WUI.makeUrl(ac,p1);console.log("export: "+url);console.log("(HINT: debug via Ctrl-Export OR window.open=$.get)");if(debugShow){$.get(url);return;}
window.open(url);}}
self.getQueryParamFromTable=self.getParamFromTable=getQueryParamFromTable;function getQueryParamFromTable(jtbl,param)
{var datagrid=self.isTreegrid(jtbl)?"treegrid":"datagrid";var opt=jtbl[datagrid]("options");var param1=getDgFilter(jtbl);if(param!=null){$.extend(param1,param);}
else{param={};}
var selArr=jtbl[datagrid]("getChecked");if(selArr.length>1&&selArr[0].id!=null){var idList=$.map(selArr,function(e){return e.id}).join(',');param1.cond="t0.id IN ("+idList+")";}
if(param.orderby===undefined&&opt.sortName){param1.orderby=opt.sortName;if(opt.sortOrder&&opt.sortOrder.toLowerCase()!="asc")
param1.orderby+=" "+opt.sortOrder;}
if(param.res===undefined){var resArr=[];$.each([opt.frozenColumns[0],opt.columns[0]],function(idx0,cols){if(cols==null)
return;$.each(cols,function(i,e){if(!e.field||e.field.substr(-1)=="_")
return;var one=e.field;if(one!=e.title||e.jdEnumMap){if(/[\s()\[\]\{\}\/\\,<>.!@#$%^&*-+]|^\d/.test(e.title))
one+=" "+Q(e.title,'"');else
one+=" "+e.title;}
if(e.jdEnumMap){one+='='+mCommon.kvList2Str(e.jdEnumMap,';',':');}
resArr.push(one);});});param1.res=resArr.join(',');}
if(param.fname===undefined){param1.fname=jtbl.prop("title")||jtbl.closest(".wui-page").prop("title");}
return param1;}
self.getDgInfo=getDgInfo;function getDgInfo(jtbl,res)
{if(!jtbl||jtbl.size()==0||!jtbl.hasClass("datagrid-f")){console.error("bad datagrid: ",jtbl);throw"getDgInfo error: bad datagrid.";}
if(res==null)
res={};res.isTreegrid=self.isTreegrid(jtbl);var datagrid=res.datagrid=(res.isTreegrid?"treegrid":"datagrid");var opt=res.opt=jtbl[datagrid]("options");res.url=opt.url;res.param=opt.queryParams;res.ac=opt.url&&opt.url.action;if(res.ac){var m=res.ac.match(/\w+(?=\.query\b)/);res.obj=m&&m[0];}
if(res.sel!==undefined){res.sel=jtbl[datagrid]('getSelected');}
if(res.selArr!==undefined){res.selArr=jtbl[datagrid]("getChecked");}
if(res.res!==undefined){res.res={};$.each([opt.frozenColumns[0],opt.columns[0]],function(idx0,cols){if(cols==null)
return;$.each(cols,function(i,e){if(!e.field||e.field.substr(-1)=="_")
return;res.res[e.field]=e;});});}
if(res.dgFilter!==undefined){res.dgFilter=getDgFilter(jtbl);}
return res;}
window.YesNoMap={0:T("否"),1:T("是")};window.YesNo2Map={0:T("否"),1:T("是"),2:T("处理中")};var Formatter={dt:function(value,row){var dt=WUI.parseDate(value);if(dt==null)
return value;return dt.format("L");},number:function(value,row){var ret=parseFloat(value);return isNaN(ret)?value:ret;},atts:function(value,row){if(value==null)
return"(无)";return value.toString().replace(/(\d+)(?::([^,]+))?,?/g,function(ms,attId,name){var url=WUI.makeUrl("att",{id:attId});if(name==null)
name=attId;return"<a target='_black' href='"+url+"'>"+name+"</a>&nbsp;";});},picx:function(opt){if(opt===null)
opt={};return function(value,row){if(value==null)
return"(无图)";if(!opt.preview)
return'<a target="_black" href="'+linkUrl(value)+'">'+value+'</a>';var maxN=opt.preview||3;value1=value.toString().replace(/(\d+)(?::([^,]+))?,?/g,function(ms,picId,name){if(name==null)
name="图"+picId;if(maxN<=0)
return name+" ";--maxN;var url;if(opt.thumb&&self.options.useNewThumb){url=WUI.makeUrl("att",{id:picId,thumb:1});}
else{url=WUI.makeUrl("att",{id:picId});}
return'<img alt="'+name+'" src="'+url+'">';});return'<a target="_black" href="'+linkUrl(value)+'">'+value1+'</a>';}
function linkUrl(value){if(!opt.thumb){return WUI.makeUrl("pic",{id:value});}
else if(!self.options.useNewThumb){return WUI.makeUrl("pic",{smallId:value});}
else{return WUI.makeUrl("pic",{id:value,thumb:1});}}},flag:function(yes,no){if(yes==null)
yes=T("是");if(no==null)
no=T("否");return function(value,row){if(value==null)
return;return value?yes:no;}},enum:function(enumMap,sep){sep=sep||',';return function(value,row){if(value==null)
return enumMap[value];var v=enumMap[value];if(v!=null)
return v;if(value.indexOf&&value.indexOf(sep)>0){var v1=$.map(value.split(sep),function(e){return enumMap[e]||e;});v=v1.join(sep);}
else{v=value;}
return v;}},enumStyler:function(colorMap,defaultColor,field){return function(value,row){if(field)
value=row[field];var color=colorMap[value];if(color==null&&defaultColor)
color=defaultColor;if(Color[color])
color=Color[color];if(color)
return"background-color: "+color;}},enumFnStyler:function(colorMap,defaultColor){var fnArr=$.map(colorMap,function(v0,k){return[[function(v,row){return eval(k)},v0]];});console.log(fnArr);return function(value,row){var color=null;$.each(fnArr,function(i,fn){if(fn[0](value,row)){color=fn[1];return false;}});if(color==null&&defaultColor)
color=defaultColor;if(Color[color])
color=Color[color];if(color)
return"background-color: "+color;}},linkTo:function(field,dlgRef,showField){return function(value,row){if(value==null)
return;var val=typeof(showField)=="string"?row[showField]:showField?(row[field]+"-"+value):value;return self.makeLinkTo(dlgRef,row[field],val);}},progress:function(value,row){if(!value)
return;value=Math.ceil(value*100);var htmlstr='<div class="easyui-progressbar progressbar" style="min-width: 100px;width: 100%; height: 20px;">'
+'<div class="progressbar-value" style="width: '+value+'%; height: 20px; line-height: 20px;"></div>'
+'<div class="progressbar-text" style="width: '+value+'%; top: 0;">'+value+'%</div>'
+'</div>';return htmlstr;}};Formatter.pics=Formatter.picx({thumb:1,preview:3});Formatter.pics1=Formatter.picx({thumb:1});self.formatter=Formatter;function dgLoader(param,success,error)
{var jo=$(this);var datagrid=self.isTreegrid(jo)?"treegrid":"datagrid";var opts=jo[datagrid]("options");if(opts.data){return defaultDgLoader[datagrid].apply(this,arguments);}
if(opts.url==null)
return false;var param1={};for(var k in param){if(k==="rows"){param1.pagesz=param[k];}
else if(k==="sort"){param1.orderby=param.sort+" "+param.order;}
else if(k==="order"){}
else if(k==="q"&&opts.jd_qsearch){param1.qsearch=opts.jd_qsearch+":"+param.q;}
else{param1[k]=param[k];}}
param1=getDgFilter(jo,param1,true);var dfd=self.callSvr(opts.url,param1,success);dfd.fail(function(){jo[datagrid]("loaded");});}
function dgLoadFilter(data)
{var ret=jdListToDgList(data);var isOnePage=(ret.total==ret.rows.length);var doHidePager=(isOnePage&&ret.total<=5);var jtbl=$(this);var dgOpt=jtbl.datagrid("options");if(dgOpt.pagination){hidePagerAuto(jtbl,doHidePager);}
if(dgOpt.showFooter&&dgOpt.sumFields){var stat=data.stat||{};dgOpt.sumFields.forEach(function(field){if(stat[field]!==undefined)
return;stat[field]=ret.rows.reduce(function(s,row,i){var v=row[field];if(!v||isNaN(v))
return s;return s+parseFloat(v);},0);});ret.footer=[stat];}
return ret;function hidePagerAuto(jtbl,doHidePager){var tmpName="_restorefn_pager";var jpager=jtbl.datagrid("getPager");var isHidden=jpager.css("display")=="none";if(doHidePager&&!isHidden){var h=jpager.height();jpager.hide().height(0);jtbl.data(tmpName,function(){jpager.height(h).show();})}
else if(!doHidePager&&isHidden){var restorefn=jtbl.data(tmpName);restorefn();jtbl.data(tmpName,null);}}}
function resetPageNumber(jtbl)
{var opt=jtbl.datagrid('options');if(opt.pagination&&opt.pageNumber)
{opt.pageNumber=1;var jpager=jtbl.datagrid("getPager");jpager.pagination("refresh",{pageNumber:opt.pageNumber});}}
var defaultDgLoader={datagrid:$.fn.datagrid.defaults.loader,treegrid:$.fn.treegrid.defaults.loader}
$.extend($.fn.datagrid.defaults,{rownumbers:true,ctrlSelect:true,pagination:true,pageSize:20,pageList:[20,50,100],loadFilter:dgLoadFilter,loader:dgLoader,onLoadError:self.ctx.defAjaxErrProc,onBeforeSortColumn:function(sort,order){var jtbl=$(this);resetPageNumber(jtbl);},onLoadSuccess:function(data){if(data.total){$(this).datagrid("fitColumns");}
else{var body=$(this).data().datagrid.dc.body2;var view=$(this).data().datagrid.dc.view;var h=50;view.height(view.height()-body.height()+h);body.height(h);body.find('table tbody').empty().append('<tr><td width="'+body.width()+'px" height="50px" align="center" class="noData" style="border:none; color:#ccc; font-size:14px">没有数据</td></tr>');}},onHeaderContextMenu:function(ev,field){var jtbl=$(this);var jmenu=GridHeaderMenu.showMenu({left:ev.pageX,top:ev.pageY,field},jtbl,field);ev.preventDefault();},onClickCell:function(row,field,val){var this_=this;var jtbl=$(this);if(this_.infoTmr)
clearTimeout(this_.infoTmr);this_.infoTmr=setTimeout(function(){GridHeaderMenu.statSelection(jtbl,row,field);delete this_.infoTmr;},1000);},onInitOptions:function(opt){var ac=opt.url&&opt.url.action;if(ac){var m=ac.match(/\w+(?=\.query\b)/);var obj=m&&m[0];if(obj){opt.obj=obj;var jtbl=$(this);var baseObj=jtbl.attr("my-obj")||obj;var meta=self.UDF.onGetMeta(baseObj);if(meta&&!jtbl.data("udfLoaded_")){self.UDF.addColByMeta(opt.columns[0],meta);jtbl.data("udfLoaded_",true);}}}
if(this.datagridOpt){$.extend(opt,this.datagridOpt);}
opt.columns[0].forEach(function(e){e.title=T(e.title);});},});var GridHeaderMenu={showMenu:function(pos,jtbl,field){jmenu=$('<div class="mnuGridHeader"></div>');var items=field?GridHeaderMenu.itemsForField:GridHeaderMenu.items;$.each(items,function(i,e){var je=$(e);var perm=je.attr("wui-perm")||je.text();if(canDo("通用",perm))
je.appendTo(jmenu);});jmenu.menu({onClick:function(mnuItem){GridHeaderMenu[mnuItem.id].call(mnuItem,jtbl,field);}});jmenu.menu('show',pos);},items:['<div id="showDlgFieldInfo">字段信息</div>','<div id="filterGrid" data-options="iconCls:\'icon-search\'">自定义查询</div>','<div id="showDlgDataReport" data-options="iconCls:\'icon-sum\'">自定义报表</div>','<div id="showDlgQuery">高级查询</div>','<div id="import" wui-perm="新增" data-options="iconCls:\'icon-add\'">导入</div>','<div id="export" data-options="iconCls:\'icon-save\'">导出</div>'],itemsForField:['<div id="copyCol">复制本列</div>','<div id="statCol" data-options="iconCls:\'icon-sum\'">统计本列</div>','<div id="doFindCell" data-options="iconCls:\'icon-search\'">查询本列</div>','<div id="freezeCol" data-options="iconCls:\'icon-lock\'">冻结列</div>',],showDlgFieldInfo:function(jtbl){var param=WUI.getQueryParamFromTable(jtbl);console.log(param);var title="字段信息";var title1=jtbl.prop("title")||jtbl.closest(".wui-page").prop("title");if(title1)
title+="-"+title1;var strArr=[];var datagrid=WUI.isTreegrid(jtbl)?"treegrid":"datagrid";var url=jtbl[datagrid]("options").url;if(url&&url.action)
strArr.push("<b>[接口]</b>\n"+url.action);if(param.cond){var cond=param.cond;if($.isArray(cond)||$.isPlainObject(cond))
cond=JSON.stringify(cond);strArr.push("<b>[查询条件]</b>\n"+cond);}
if(param.orderby)
strArr.push("<b>[排序]</b>\n"+param.orderby);var varr=WUI.list2varr(param.res," ",",");var resArr=WUI.rs2Array({h:["name","title"],d:varr});var rows=jtbl.datagrid("getData").rows;if(rows.length>0){var colMap={};$.each(resArr,function(i,res){colMap[res.name]=true;addExample(rows,res);});$.each(rows[0],function(field,val){if(colMap[field])
return;var res={name:field,title:"(未使用)"};addExample(rows,res);resArr.push(res);});}
strArr.push("<b>[字段列表]</b>\n");var jdlg=$("<div class='dlgFieldInfo' style='width:500px;height:500px' title='"+title+"'><pre>"+strArr.join("\n\n")+"</pre>"+"<table id='res' style='width:100%'></table>"+"</div>");if($("#styleFieldInfo").size()==0){var style="<style id='styleFieldInfo'>"+".dlgFieldInfo .datagrid-cell { white-space: normal }"+".dlgFieldInfo .example { color: blue; font-size: 0.6em }"+"</style>";$(style).appendTo(document.head);}
WUI.showDlg(jdlg,{modal:false,onOk:function(){WUI.closeDlg(this);},noCancel:true});setTimeout(onShow);function onShow(){jdlg.find("#res").datagrid({columns:[[{field:"name",title:"字段",width:"33%"},{field:"title",title:"标题",width:"34%"},{field:"example",title:"示例",width:"33%"},]],pagination:false,data:resArr});}
function addExample(rows,res){var field=res.name;if(rows[0][field]===undefined){res.name+="<span style='color:red'>(缺失)</span>";}
if(res.title){res.title="<span>"+res.title+"</span>";}
var arr=[];var MAX_EXAMPLE=2;var lastOne=null;$.each(rows,function(i,row){var s=row[field];if($.isArray(s)||$.isPlainObject(s))
s=JSON.stringify(s);if(s&&s!=lastOne){arr.push(s);lastOne=s;if(arr.length==MAX_EXAMPLE)
return false;}});if(arr.length>0)
res.example="<span class='example'>"+arr.join('<br>')+"</span>";}},filterGrid:function(jtbl){var param=self.getDgInfo(jtbl).param;app_alert(T("查询条件(cond)? "),"p",function(cond){WUI.reload(jtbl,null,{cond:cond});},{defValue:param&&param.cond});},showDlgDataReport:function(jtbl){self.showDlg("#dlgDataReport");},showDlgQuery:function(jtbl){var data=null;var datagrid=WUI.isTreegrid(jtbl)?"treegrid":"datagrid";var url=jtbl[datagrid]("options").url;if(url&&url.action)
data={ac:url.action};var param=WUI.getQueryParamFromTable(jtbl);self.showDlgQuery(data,param);},'import':function(jtbl){var param=self.getDgInfo(jtbl);if(!param.obj){app_alert(T("该数据表不支持导入"),"w");return;}
DlgImport.show({obj:param.obj},function(){WUI.reload(jtbl);});},'export':function(jtbl){var fn=getExportHandler(jtbl);fn();},dgStatCol:function(rows,field){var stat={cnt:0,realCnt:0,numCnt:0,sum:0,max:0,min:0,info:[]};stat.cnt=rows.length;if(stat.cnt<1)
return stat;rows.forEach(function(e){var v=e[field];if(v===null||v==="")
return;++stat.realCnt;if(isNaN(v))
return;if(v.constructor!==Number){v=parseFloat(v);}
++stat.numCnt;if(stat.numCnt==1){stat.max=v;stat.min=v;stat.sum=v;}
else{stat.sum+=v;if(v>stat.max)
stat.max=v;if(v<stat.min)
stat.min=v;}});stat.info=["COUNT="+stat.cnt,"COUNT(非空项)="+stat.realCnt];if(stat.numCnt>0){stat.info.push("COUNT(数值项)="+stat.numCnt,"SUM="+stat.sum,"MAX="+stat.max,"MIN="+stat.min,"AVG="+stat.sum/stat.numCnt)}
return stat;},statSelection:function(jtbl,row,field){var rows=jtbl.datagrid("getSelections");if(rows.length<2)
return;var stat=GridHeaderMenu.dgStatCol(rows,field);var colTitle=jtbl.datagrid("getColumnOption",field).title;var title="选中"+rows.length+"行，列=["+colTitle+"]";app_show(stat.info.join("<br>"),title);},copyCol:function(jtbl,field){var rows=jtbl.datagrid("getSelections");var arr=null;if(rows.length<2){var data=jtbl.datagrid("getData");arr=data.rows.map(function(e){return e[field];});var colTitle=jtbl.datagrid("getColumnOption",field).title;arr.unshift(colTitle);}
else{arr=rows.map(function(e){return e[field];});}
var ret=arr.join("\r\n");self.execCopy(ret);},statCol:function(jtbl,field){var data=jtbl.datagrid("getData");var colTitle=jtbl.datagrid("getColumnOption",field).title;if(data.rows.length==0){var info="["+colTitle+"]列: 无数据";app_alert(info);return;}
var stat=GridHeaderMenu.dgStatCol(data.rows,field);stat.info.unshift("<b>["+colTitle+"]</b>列:");var jdlg=$("<div title='列统计'><pre>"+stat.info.join("\n")+"</pre></div>");WUI.showDlg(jdlg,{modal:false,onOk:function(){WUI.closeDlg(this);},noCancel:true});},doFindCell:function(jtbl,field){var dgInfo=WUI.getDgInfo(jtbl);var colTitle=jtbl.datagrid("getColumnOption",field).title;if(colTitle!=field)
colTitle+="("+field+")";var info="请输入<b>["+colTitle+"]</b>的过滤条件：<br>"+"按住Ctrl点\"确定\"可追加过滤条件。";var rows=jtbl.datagrid("getSelections");var defValue=$.map(rows,function(row){return row[field];}).join(',');app_alert(info,"p",function(text){var kv={};kv[field]=text;var param=WUI.getQueryParam(kv);var doAppendFilter=WUI.isBatchMode();WUI.reload(jtbl,undefined,param,doAppendFilter);},{defValue:defValue});},freezeCol:function(jtbl,field){var dgOpt=jtbl.datagrid("options");if(dgOpt.columns.length>1){app_alert("不支持","w");return;}
var cols=[];if(dgOpt.frozenColumns[0])
cols.push.apply(cols,dgOpt.frozenColumns[0]);cols.push.apply(cols,dgOpt.columns[0]);var col=cols.findIndex(function(e){return e.field==field;});dgOpt.quickAutoSize=false;jtbl.datagrid({frozenColumns:[cols.slice(0,col+1)],columns:[cols.slice(col+1)]});}}
self.GridHeaderMenu=GridHeaderMenu;self.showDlgQuery=showDlgQuery;function showDlgQuery(data1,param)
{var itemArr=[{title:"接口名",dom:"<input name='ac' required>",hint:"示例: Ordr.query"},{title:"参数",dom:'<textarea name="param" rows=8></textarea>',hint:"cond:查询条件, res:返回字段, gres:分组字段, pivot:转置字段, fmt:输出格式(html,excel,txt,list,array,csv等)"},{title:"统计图<br>参数",dom:'<textarea name="showChartParam" rows=4></textarea>',hint:"<a target='_blank' href='https://oliveche.com/jdcloud-site/api_web.html#showDlgChart'>须为数组，原型为[rs2StatOpt, seriesOpt, chartOpt]</a><br>"+"示例: <span class='example'>[]</span> <span class='example'>[{xcol: [0,1]}]</span>"+" <span class='example'>[{ tmUnit: 'y,m' }]</span> <span class='example'>[null, {type:'pie'}]</span>"}];var data=$.extend({ac:'Ordr.query',param:param?JSON.stringify(param,null,2):'{\n cond: {createTm: ">2020-1-1"},\n res: "count(*) 数量",\n gres: "status 状态=CR:新创建;PA:待处理;RE:已完成;CA:已取消",\n// pivot: "状态"\n}'},data1);var jdlg=self.showDlgByMeta(itemArr,{title:"高级查询",modal:false,data:data,onOk:function(data){var param={page:1};if(data.param){try{param=$.extend(param,eval("("+data.param+")"));}
catch(ex){app_alert("参数格式出错：须为JS对象格式");return false;}}
var showChartParam;if(data.showChartParam){try{showChartParam=eval("("+data.showChartParam+")");}
catch(ex){app_alert("参数格式出错：须为JS对象格式");return false;}
if(!$.isArray(showChartParam)){app_alert("统计图表参数必须为JS数组格式");return false;}}
var url=self.makeUrl(data.ac,param);if(param&&param.fmt){window.open(url);return;}
WUI.showPage("pageSimple",T("查询结果")+"!",[url,null,null,showChartParam]);}});jdlg.find(".example").css({backgroundColor:"#eeeeee",cursor:"pointer"}).click(function(){$(this).closest("td").find("textarea:first").val($(this).text());});}
$.extend($.fn.treegrid.defaults,{idField:"id",treeField:"id",pagination:false,rownumbers:true,fatherField:"fatherId",singleSelect:false,ctrlSelect:true,loadFilter:function(data,parentId){var opt=$(this).treegrid("options");var isLeaf=opt.isLeaf;var ret=jdListToTree(data,opt.idField,opt.fatherField,parentId,isLeaf);return ret;},loader:dgLoader,onBeforeLoad:function(row,param){if(row){var opt=$(this).treegrid("options");param.cond=opt.fatherField+"="+row.id;delete param["id"];}},onLoadSuccess:function(row,data){$.fn.datagrid.defaults.onLoadSuccess.call(this,data);},onHeaderContextMenu:$.fn.datagrid.defaults.onHeaderContextMenu});$.extend($.fn.combotree.defaults,{idField:"id",textField:"name",fatherField:"fatherId",loadFilter:function(data,parentId){var arr=null;if($.isArray(data)){arr=data;}
else if($.isArray(data.list)){arr=data.list;}
else if(data.h!==undefined)
{arr=WUI.rs2Array(data);}
else{return data;}
var opt=$(this).tree("options");var ret=WUI.makeTree(arr,opt.idField,opt.fatherField);$.each(arr,function(i,e){e.text=e[opt.textField];});return ret;}});$.extend($.fn.combogrid.defaults,{loadFilter:$.fn.datagrid.defaults.loadFilter,loader:$.fn.datagrid.defaults.loader,});$.extend($.fn.combotreegrid.defaults,{idField:"id",treeField:"name",textField:"name",fatherField:"fatherId",loadFilter:$.fn.treegrid.defaults.loadFilter});self.checkIdCard=checkIdCard;function checkIdCard(idcard)
{if(idcard.length!=18)
return false;if(!/\d{17}[0-9x]/i.test(idcard))
return false;var a=idcard.split("");var w=[7,9,10,5,8,4,2,1,6,3,7,9,10,5,8,4,2];var s=0;for(var i=0;i<17;++i)
{s+=a[i]*w[i];}
var x="10x98765432".substr(s%11,1);return x==a[17].toLowerCase();}
var DefaultValidateRules={number:{validator:function(v){return/^[0-9.-]+$/.test(v);},message:T("validate.number")||'必须为数字!'},idcard:{validator:checkIdCard,message:T("validate.idcard")||'18位身份证号有误!'},uname:{validator:function(v){return v.length>=4&&v.length<=16&&/^[a-z]\w+$/i.test(v);},message:T("validate.uname")||"4-16位英文字母或数字，以字母开头，不能出现符号."},pwd:{validator:function(v){return(v.length>=4&&v.length<=16)||v.length==32;},message:T("validate.pwd")||"4-16位字母、数字或符号."},equalTo:{validator:function(v,param){return v==$(this).closest("form").find(param[0]).val();},message:T("validate.equalTo")||"两次输入不一致."},cellphone:{validator:function(v){return v.length==11&&!/\D/.test(v);},message:T("validate.cellphone")||"手机号为11位数字"},datetime:{validator:function(v){return/\d{4}-\d{1,2}-\d{1,2}(\d{1,2}:\d{1,2}(:\d{1,2})?)?/.test(v);
  },
  message: T("validate.datetime") || "格式为\"年-月-日 时:分:秒\"，时间部分可忽略"
 },
 usercode: {
  validator: function (v) {
   return /^[a-zA-Z]/.test(v)||(v.length==11&&!/\D/.test(v));},message:T("validate.usercode")||"11位手机号或客户代码"}};var validateboxDefaults={rules:DefaultValidateRules,validateOnCreate:false,missingMessage:"必填项，不可为空"}
$.extend(true,$.fn.validatebox.defaults,validateboxDefaults);$.extend(true,$.fn.combo.defaults,validateboxDefaults);$.extend(true,$.fn.combogrid.defaults,validateboxDefaults);$.fn.linkbutton0=$.fn.linkbutton;$.fn.linkbutton=function(a,b){if($.isPlainObject(a)&&a.class){mCommon.assert(a.class=="splitbutton"||a.class=="menubutton");var cls=a.class;delete a.class;return $.fn[cls].apply(this,arguments);}
return $.fn.linkbutton0.apply(this,arguments);}
$.extend($.fn.linkbutton,$.fn.linkbutton0);if(g_args.lang!="dev"){$.fn.datebox.defaults.formatter=function(date){var y=date.getFullYear();var m=date.getMonth()+1;var d=date.getDate();return y+'-'+(m<10?('0'+m):m)+'-'+(d<10?('0'+d):d);};$.fn.datebox.defaults.parser=function(s){if(!s)return new Date();var ss=s.split('-');var y=parseInt(ss[0],10);var m=parseInt(ss[1],10);var d=parseInt(ss[2],10);if(!isNaN(y)&&!isNaN(m)&&!isNaN(d)){return new Date(y,m-1,d);}else{return new Date();}};}
self.m_enhanceFn[".my-combobox"]=function(jo){jo.mycombobox();};self.m_enhanceFn[".wui-form-table"]=enhanceTableLayout;function enhanceTableLayout(jo){var tbl=jo[0];if(tbl.rows.length==0)
return;var tr=tbl.rows[0];var colCnt=tr.cells.length;var doAddTr=false;for(var j=0;j<tr.cells.length;++j){var td=tr.cells[j];if(td.getAttribute("colspan")!=null){colCnt+=parseInt(td.getAttribute("colspan"))-1;doAddTr=true;}}
if(doAddTr){var td=dup("<td></td>",colCnt);$('<tr class="wui-form-table-tr-width" style="visibility:hidden">'+td+'</tr>').prependTo(jo);tr=tbl.rows[0];}
var w=100/(colCnt/2);for(var i=1;i<colCnt;i+=2){var je=$(tr.cells[i]);if(je.attr("width")==null)
je.attr("width",w+"%");je.css("min-width","100px");}
self.enhanceLang(jo.find("td:even"));self.doSpecial(jo,'td',function(ev){var jo=$(this).next();if(jo.find("[name]").size()>0){var appendFilter=(ev.ctrlKey||ev.metaKey);doFind(jo,null,appendFilter);}},3,2);function dup(s,n){var ret='';for(var i=0;i<n;++i){ret+=s;}
return ret;}};function main()
{self.title=document.title;self.container=$(".wui-container");if(self.container.size()==0)
self.container=$(document.body);self.enhanceWithin(self.container);self.container.trigger("wuiInit");}
$(main);}
jdModule("jdcloud.wui",JdcloudWui);function JdcloudWui()
{var self=this;var mCommon=jdModule("jdcloud.common");self.isBusy=false;window.g_args={};window.g_data={};window.BASE_URL="../";window.FormMode={forAdd:'A',forSet:'S',forLink:'S',forFind:'F',forDel:'D'};self.options={title:"客户端",appName:"user",onShowLogin:function(){throw"NotImplemented";},pageHome:"pageHome",pageFolder:"page",serverUrl:"./",logAction:false,PAGE_SZ:20,manualSplash:false,mockDelay:50,moduleExt:{showPage:$.noop,callSvr:$.noop},xparam:1,useNewThumb:0};parseArgs();initLang();JdcloudApp.call(self);JdcloudCall.call(self);JdcloudPage.call(self);function parseArgs()
{if(location.search){g_args=mCommon.parseQuery(location.search.substr(1));}}
function T(s){if(s==null||LANG==null)
return s;var s1=s;if(s.length>2&&s.substr(-2)=="管理")
s1=s.substr(0,s.length-2);return LANG[s1]||s;}
function initLang(){window.LANG=null;window.T=T;if(!g_args.lang)
g_args.lang=document.documentElement.lang||'dev';if(g_args.lang!='dev'){mCommon.loadScript("lib/lang-"+g_args.lang+".js",{async:false});mCommon.loadScript("lib/easyui/locale/easyui-lang-en.js");}
else{mCommon.loadScript("lib/easyui/locale/easyui-lang-zh_CN.js");}}
self.m_enhanceFn[".lang"]=self.enhanceLang=enhanceLang;function enhanceLang(jo)
{if(LANG==null)
return;jo.contents().each(function(){if(this.nodeType==3){var t=T(this.nodeValue);this.nodeValue=t;}});}
self.app_alert=app_alert;function app_alert(msg)
{var type="i";var fn=undefined;var alertOpt={};var jmsg;for(var i=1;i<arguments.length;++i){var arg=arguments[i];if($.isFunction(arg)){fn=arg;}
else if($.isPlainObject(arg)){alertOpt=arg;}
else if(typeof(arg)==="string"){type=arg;}}
if(type=="q"){app_confirm(msg,function(isOk){if(isOk){fn&&fn();}
else if(alertOpt.onCancel){alertOpt.onCancel();}});return;}
else if(type=="p"){jmsg=$.messager.prompt(self.options.title,msg,function(text){if(text&&fn){fn(text);}});setTimeout(function(){var ji=jmsg.find(".messager-input");ji.focus();if(alertOpt.defValue){ji.val(alertOpt.defValue);}});return;}
var icon={i:"info",w:"warning",e:"error"}[type];var s={i:T("提示"),w:T("警告"),e:T("出错")}[type]||"";var s1="<b>["+s+"]</b>";jmsg=$.messager.alert(self.options.title+" - "+s,s1+" "+msg,icon,fn);setTimeout(function(){var jbtn=jmsg.parent().find(".l-btn");jbtn.focus();if(alertOpt.timeoutInterval){setTimeout(function(){try{jbtn.click();}catch(ex){console.error(ex);}},alertOpt.timeoutInterval);}});}
self.app_confirm=app_confirm;function app_confirm(msg,fn)
{var s="<div style='font-size:10pt'>"+msg.replace(/\n/g,"<br/>")+"</div>";$.messager.confirm(self.options.title+" - "+T("确认"),s,fn);}
self.app_show=app_show;function app_show(msg,title)
{$.messager.show({title:title||self.options.title,msg:msg});}
self.app_progress=app_progress;var m_isPgShow=false;function app_progress(value,msg)
{value=Math.round(value);if(!m_isPgShow){$.messager.progress({interval:0});m_isPgShow=true;}
if(msg!==undefined){$(".messager-p-msg").html(msg||'');}
var bar=$.messager.progress('bar');bar.progressbar("setValue",value);if(value>=100){setTimeout(function(){if(m_isPgShow){$.messager.progress('close');m_isPgShow=false;}},500);}}
self.makeLinkTo=makeLinkTo;function makeLinkTo(dlg,id,text,obj)
{if(text==null)
text=id;var optStr=obj==null?"{id:"+id+"}":"{id:"+id+",obj:\""+obj+"\"}";return"<a href=\""+dlg+"\" onclick='WUI.showObjDlg(\""+dlg+"\",FormMode.forSet,"+optStr+");return false'>"+text+"</a>";}
function tokenName()
{var name="token";if(self.options.appName)
name+="_"+self.options.appName;return name;}
self.saveLoginToken=saveLoginToken;function saveLoginToken(data)
{if(data._token)
{mCommon.setStorage(tokenName(),data._token);}}
self.loadLoginToken=loadLoginToken;function loadLoginToken()
{return mCommon.getStorage(tokenName());}
self.deleteLoginToken=deleteLoginToken;function deleteLoginToken()
{mCommon.delStorage(tokenName());}
self.tryAutoLogin=tryAutoLogin;function tryAutoLogin(onHandleLogin,reuseCmd)
{if(g_data.initClient&&g_data.initClient.userInfo)
return;var ok=false;var ajaxOpt={async:false,noex:true};function handleAutoLogin(data)
{if(data===false)
return;if(onHandleLogin)
onHandleLogin.call(this,data);ok=true;}
if(reuseCmd!=null){self.callSvr(reuseCmd,handleAutoLogin,null,ajaxOpt);}
if(ok)
return ok;var token=loadLoginToken();if(token!=null)
{var postData={token:token};self.callSvr("login",handleAutoLogin,postData,ajaxOpt);}
if(ok)
return ok;self.showLogin();return ok;}
self.showLogin=showLogin;function showLogin()
{self.options.onShowLogin();}
self.tryAutoLoginAsync=tryAutoLoginAsync;function tryAutoLoginAsync(onHandleLogin,reuseCmd)
{var ajaxOpt={noex:true};var dfd=$.Deferred();function success(data){if(onHandleLogin)
onHandleLogin.call(this,data);dfd.resolve();}
function fail(){dfd.reject();self.showLogin();}
if(reuseCmd!=null){self.callSvr(reuseCmd,function(data){if(data===false){loginByToken()
return;}
success(data);},null,ajaxOpt);}
else{loginByToken();}
function loginByToken()
{var token=loadLoginToken();if(token!=null)
{var postData={token:token};self.callSvr("login",function(data){if(data===false){fail();return;}
success(data);},postData,ajaxOpt);}
else{fail();}}
return dfd.promise();}
self.handleLogin=handleLogin;self.dfdLogin=$.Deferred();function handleLogin(data)
{g_data.userInfo=data;if(g_args.autoLogin||/android|ipad|iphone/i.test(navigator.userAgent))
saveLoginToken(data);WUI.applyPermission();var jcont=$("body");if(WUI.isSmallScreen()){$("#menu").attr("data-options","collapsed:true");}
jcont.layout();$(".loginPanel > .window-header").addClass("panel-header");$("#menu,#main").css("visibility","");$(".my-title").html(document.title);if(data){$(".user-name").html(data.name||data.uname);$(".user-phone").html(data.phone);}
self.dfdLogin.resolve();self.showPage(self.options.pageHome);if(location.hash.startsWith("#page")){WUI.showPage(location.hash.replace('#',''));}}
self.initClient=initClient;var plugins_={};function initClient(param)
{self.callSvrSync('initClient',function(data){g_data.initClient=data;plugins_=data.plugins||{};$.each(plugins_,function(k,e){if(e.js){var js=BASE_URL+'plugin/'+k+'/'+e.js;mCommon.loadScript(js,{async:true});}});},param);if(g_data.initClient&&g_data.initClient.userInfo){WUI.handleLogin(g_data.initClient.userInfo);}}
window.Plugins={exists:function(pname){return plugins_[pname]!==undefined;},list:function(){return plugins_;}};self.setApp=setApp;function setApp(app)
{$.extend(self.options,app);}
self.logout=logout;function logout(dontReload)
{deleteLoginToken();g_data.userInfo=null;return self.callSvr("logout",function(data){if(!dontReload)
mCommon.reloadSite();});}
self.tabClose=tabClose;function tabClose(idx)
{if(idx==null){var jtab=self.tabMain.tabs("getSelected");idx=self.tabMain.tabs("getTabIndex",jtab);}
self.tabMain.tabs("close",idx);}
self.getActivePage=getActivePage;function getActivePage()
{var pp=self.tabMain.tabs('getSelected');if(pp==null)
return $();var jpage=pp.find(".wui-page");return jpage;}
self.showLoading=showLoading;function showLoading()
{$('#block').css({width:$(document).width(),height:$(document).height(),'z-index':999999}).show();}
self.hideLoading=hideLoading;function hideLoading()
{$('#block').hide();}
function mainInit()
{self.tabMain=$('#my-tabMain');mCommon.assert(self.tabMain.size()==1,"require #my-tabMain as container");var opt=self.tabMain.tabs('options');$.extend(opt,{onSelect:function(title){var jpage=getActivePage();if(jpage.size()==0)
return;jpage.trigger('pageshow');},onBeforeClose:function(title){var jpage=getActivePage();if(jpage.size()==0)
return;jpage.trigger('pagedestroy');}});self.PageHeaderMenu={items:['<div id="mnuReload">刷新页面</div>','<div id="mnuReloadDlg">刷新对话框</div>','<div id="mnuBatch">批量模式</div>'],mnuReload:function(){self.reloadPage();self.reloadDialog(true);},mnuReloadDlg:function(){var jdlg=self.isBatchMode()?true:null;self.reloadDialog(jdlg);},mnuBatch:function(){console.log(this);self.toggleBatchMode();}};var jmenu=null;function onSpecial(ev){if(jmenu==null){jmenu=$('<div>'+self.PageHeaderMenu.items.join('')+'</div>');jmenu.menu({onClick:function(mnuItem){self.PageHeaderMenu[mnuItem.id].call(mnuItem);}});}
jmenu.menu('show',{left:ev.pageX,top:ev.pageY});return false;}
self.doSpecial(self.tabMain.find(".tabs-header"),".tabs-selected",onSpecial,3);self.tabMain.find(".tabs-header").on("contextmenu",".tabs-selected",onSpecial);function onResizePanel(){var jo=$(this);jo.trigger("resize.dialog");}
$.fn.dialog.defaults.onResize=onResizePanel;}
$(mainInit);}
jdModule("jdcloud.wui.name",JdcloudWuiName);function JdcloudWuiName()
{var self=this;var mCommon=jdModule("jdcloud.common");window.WUI=jdModule("jdcloud.wui");$.extend(WUI,mCommon);$.each(["intSort","numberSort","callSvr","callSvrSync","app_alert","app_confirm","app_show",],function(){window[this]=WUI[this];});}
var m_dataCache={};$.fn.mycombobox=mycombobox;function mycombobox(force)
{var mCommon=jdModule("jdcloud.common");this.each(initCombobox);function initCombobox(i,o)
{var jo=$(o);var opts=WUI.getOptions(jo);if(!force&&opts.isLoaded_)
return;if(jo.attr("required"))
opts.required=true;if(o.tagName!="SELECT"){var jo1=$("<select></select>");$.each(o.attributes,function(i,e){jo1.attr(e.name,e.value);});jo.replaceWith(jo1);jo=jo1;o=jo1[0];}
jo.removeAttr("data-options");jo.addClass("easyui-validatebox");jo.validatebox(opts);o.enableAsyncFix=true;if(opts.url){if(!jo.attr("ondblclick"))
{jo.off("dblclick").dblclick(function(){if(!confirm("刷新数据?"))
return false;refresh();});}}
jo.on("refresh",refresh);jo.on("markRefresh",markRefresh);jo.on("loadOptions",function(ev,param){if(param&&opts.urlParams!=param)
opts.isLoaded_=false;opts.urlParams=param;loadOptions();});jo.change(function(ev){if(!ev.isTrigger)
this.value_="";});jo.on("setOption",function(ev,opt){if(opt==null)
return;$.extend(opts,opt);opts.isLoaded_=false;if(this.value_)
loadOptions();});jo.keydown(function(){if($(this).attr("readonly"))
return false;loadOptions();});jo.mousedown(function(){loadOptions();});function loadOptions()
{if(opts.isLoaded_)
return;opts.isLoaded_=true;jo.prop("value_",jo.val());jo.empty();var j1=$("<option value=''></option>").appendTo(jo);if(opts.emptyText)
j1.text(opts.emptyText);if(opts.jdEnumList){opts.jdEnumMap=mCommon.parseKvList(opts.jdEnumList,';',':');}
if(opts.jdEnumMap){$.each(opts.jdEnumMap,function(k,v){var jopt=$("<option></option>").attr("value",k).text(v).appendTo(jo);});jo.attr("wui-find-hint","e");}
if(opts.url==null){jo.val(jo.prop("value_"));return;}
var url=opts.url;if($.isFunction(url)){if(url.length==0){url=url();}
else if(opts.urlParams!=null){url=url(opts.urlParams);}
else if(opts.url_){url=opts.url_;}
else{return;}
opts.url_=url;}
if(m_dataCache[url]===undefined){self.callSvr(url,onLoadOptions);}
else{onLoadOptions(m_dataCache[url]);}
function onLoadOptions(data){m_dataCache[url]=data;applyData(data);jo.val(jo.prop("value_"));}}
function applyData(data)
{opts.isLoaded_=true;function getText(row)
{if(opts.formatter){return opts.formatter(row);}
else if(opts.textField){return row[opts.textField];}
return row.id;}
if(opts.loadFilter){data=opts.loadFilter.call(this,data);}
var arr=$.isArray(data.d)?mCommon.rs2Array(data):$.isArray(data)?data:data.list;mCommon.assert($.isArray(arr),"bad data format for combobox");if(arr.length==0)
return;var names=Object.getOwnPropertyNames(arr[0]);if(opts.valueField==null){opts.valueField=names[0];}
if(opts.formatter==null&&opts.textField==null){opts.textField=names[1]||names[0];}
$.each(arr,function(i,row){var jopt=$("<option></option>").attr("value",row[opts.valueField]).prop("chooseValue",row).text(getText(row)).appendTo(jo);});}
function refresh()
{markRefresh();loadOptions();}
function markRefresh(ev,obj)
{var url=opts.url_||opts.url;if(url==null)
return;if(obj){var ac=obj+".query";if(url.action!=ac)
return;}
delete m_dataCache[url];opts.isLoaded_=false;}}}
function mycombobox_fixAsyncSetValue()
{var hook=$.valHooks["select"];$.valHooks["select"]={set:function(elem,value){elem.value_=value;if(elem.enableAsyncFix&&value){$(elem).trigger("loadOptions");}
return hook.set.apply(this,arguments);},get:function(elem){if(elem.enableAsyncFix)
return hook.get.apply(this,arguments)||elem.value_;return hook.get.apply(this,arguments);}}}
mycombobox_fixAsyncSetValue();