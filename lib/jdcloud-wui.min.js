// jdcloud-wui version 1.1

jdModule("jdcloud.common",JdcloudCommon);function JdcloudCommon()
{var self=this;self.assert=assert;function assert(cond,dscr)
{if(!cond){var msg="!!! assert fail!";if(dscr)
msg+=" - "+dscr;throw(msg);}}
self.parseQuery=parseQuery;function parseQuery(s)
{var ret={};if(s!="")
{var a=s.split('&')
for(i=0;i<a.length;++i){var a1=a[i].split("=");var val=a1[1];if(val===undefined)
val=1;else if(/^-?[0-9]+$/.test(val)){val=parseInt(val);}
else if(/^-?[0-9.]+$/.test(val)){val=parseFloat(val);}
else{val=decodeURIComponent(val);}
ret[a1[0]]=val;}}
return ret;}
self.tobool=tobool;function tobool(v)
{if(typeof v==="string")
return v!==""&&v!=="0"&&v.toLowerCase()!=="false"&&v.toLowerCase()!=="off";return!!v;}
self.reloadSite=reloadSite;function reloadSite()
{var href=location.href.replace(/#.+/,'#');location.href=href;location.reload();throw"abort";}
function setWidth_2(number)
{return number<10?("0"+number):(""+number);}
Date.prototype.format=function(fmt)
{if(fmt==null)
fmt="L";switch(fmt){case"L":fmt="yyyy-mm-dd HH:MM:SS";break;case"D":fmt="yyyy-mm-dd";break;case"T":fmt="HH:MM:SS";break;}
var year=this.getFullYear();return fmt.replace("yyyy",year).replace("yy",(""+year).substring(2)).replace("mm",setWidth_2(this.getMonth()+1)).replace("dd",setWidth_2(this.getDate())).replace("HH",setWidth_2(this.getHours())).replace("MM",setWidth_2(this.getMinutes())).replace("SS",setWidth_2(this.getSeconds()));}
Date.prototype.addDay=function(iDay)
{this.setDate(this.getDate()+iDay);return this;}
Date.prototype.addHours=function(iHours)
{this.setHours(this.getHours()+iHours);return this;}
Date.prototype.addMin=function(iMin)
{this.setMinutes(this.getMinutes()+iMin);return this;}
Date.prototype.addMonth=function(iMonth)
{this.setMonth(this.getMonth()+iMonth);return this;}
self.parseTime=parseTime;function parseTime(s)
{var a=s.split(":");var dt=new Date(0,0,1,a[0],a[1]||0,a[2]||0);if(isNaN(dt.getYear()))
return null;return dt;}
self.parseDate=parseDate;function parseDate(str)
{if(str==null)
return null;if(str instanceof Date)
return str;if(/Z$/.test(str)){return new Date(str);}
var ms=str.match(/^(\d+)(?:[-\/.](\d+)(?:[-\/.](\d+))?)?/);if(ms==null)
return null;var y,m,d;var now=new Date();if(ms[3]!==undefined){y=parseInt(ms[1]);m=parseInt(ms[2])-1;d=parseInt(ms[3]);if(y<100)
y+=2000;}
else if(ms[2]!==undefined){y=now.getFullYear();m=parseInt(ms[1])-1;d=parseInt(ms[2]);}
else{y=now.getFullYear();m=now.getMonth();d=parseInt(ms[1]);}
var h,n,s;h=0;n=0;s=0;ms=str.match(/(\d+):(\d+)(?::(\d+))?/);if(ms!=null){h=parseInt(ms[1]);n=parseInt(ms[2]);if(ms[3]!==undefined)
s=parseInt(ms[3]);}
var dt=new Date(y,m,d,h,n,s);if(isNaN(dt.getYear()))
return null;ms=str.match(/:[0-9.T]+([+-])(\d{1,4})$/);if(ms!=null){var sign=(ms[1]=="-"?-1:1);var cnt=ms[2].length;var n=parseInt(ms[2].replace(/^0+/,''));if(isNaN(n))
n=0;else if(cnt>2)
n=Math.floor(n/100);var tzOffset=sign*n*60+dt.getTimezoneOffset();if(tzOffset)
dt.addMin(-tzOffset);}
return dt;}
Date.prototype.add=function(sInterval,n)
{switch(sInterval){case'd':this.setDate(this.getDate()+n);break;case'm':this.setMonth(this.getMonth()+n);break;case'y':this.setFullYear(this.getFullYear()+n);break;case'h':this.setHours(this.getHours()+n);break;case'n':this.setMinutes(this.getMinutes()+n);break;case's':this.setSeconds(this.getSeconds()+n);break;}
return this;}
Date.prototype.diff=function(sInterval,dtEnd)
{var dtStart=this;switch(sInterval)
{case'd':return Math.round((dtEnd-dtStart)/86400000);case'm':return dtEnd.getMonth()-dtStart.getMonth()+(dtEnd.getFullYear()-dtStart.getFullYear())*12;case'y':return dtEnd.getFullYear()-dtStart.getFullYear();case's':return Math.round((dtEnd-dtStart)/1000);case'n':return Math.round((dtEnd-dtStart)/60000);case'h':return Math.round((dtEnd-dtStart)/3600000);}}
self.getTimeDiffDscr=getTimeDiffDscr;function getTimeDiffDscr(tm,tm1)
{if(!tm||!tm1)
return"";if(!(tm instanceof Date)){tm=parseDate(tm);}
if(!(tm1 instanceof Date)){tm1=parseDate(tm1);}
var diff=(tm1-tm)/1000;if(diff<60){return"刚刚";}
diff/=60;if(diff<60){return Math.floor(diff)+"分钟前";}
diff/=60;if(diff<48){return Math.floor(diff)+"小时前";}
diff/=24;if(diff<365*2)
return Math.floor(diff)+"天前";diff/=365;if(diff<10)
return Math.floor(diff)+"年前";return"很久前";}
self.setCookie=setCookie;function setCookie(name,value,days)
{if(days===undefined)
days=30;if(value==null)
{days=-1;value="";}
var exp=new Date();exp.setTime(exp.getTime()+days*24*60*60*1000);document.cookie=name+"="+escape(value)+";expires="+exp.toGMTString();}
self.getCookie=getCookie;function getCookie(name)
{var m=document.cookie.match(new RegExp("(^| )"+name+"=([^;]*)(;|$)"));if(m!=null){return(unescape(m[2]));}else{return null;}}
self.delCookie=delCookie;function delCookie(name)
{if(getCookie(name)!=null){setCookie(name,null,-1);}}
self.setStorage=setStorage;function setStorage(name,value,useSession)
{assert(typeof value!="object","value must be scalar!");if(window.localStorage==null)
{setCookie(name,value);return;}
if(useSession)
sessionStorage.setItem(name,value);else
localStorage.setItem(name,value);}
self.getStorage=getStorage;function getStorage(name,useSession)
{if(window.localStorage==null)
{getCookie(name);return;}
var rv;if(useSession)
rv=sessionStorage.getItem(name);else
rv=localStorage.getItem(name);if(rv==null)
return getCookie(name);return rv;}
self.delStorage=delStorage;function delStorage(name,useSession)
{if(window.localStorage==null)
{delCookie(name);return;}
if(useSession)
sessionStorage.removeItem(name);else
localStorage.removeItem(name);delCookie(name);}
self.rs2Array=rs2Array;function rs2Array(rs)
{var ret=[];var colCnt=rs.h.length;for(var i=0;i<rs.d.length;++i){var obj={};var row=rs.d[i];for(var j=0;j<colCnt;++j){obj[rs.h[j]]=row[j];}
ret.push(obj);}
return ret;}
self.rs2Hash=rs2Hash;function rs2Hash(rs,key)
{var ret={};var colCnt=rs.h.length;var keyfn;if(typeof(key)=="function")
keyfn=key;for(var i=0;i<rs.d.length;++i){var obj={};var row=rs.d[i];for(var j=0;j<colCnt;++j){obj[rs.h[j]]=row[j];}
var k=keyfn?keyfn(obj):obj[key];ret[k]=obj;}
return ret;}
self.rs2MultiHash=rs2MultiHash;function rs2MultiHash(rs,key)
{var ret={};var colCnt=rs.h.length;var keyfn;if(typeof(key)=="function")
keyfn=key;for(var i=0;i<rs.d.length;++i){var obj={};var row=rs.d[i];for(var j=0;j<colCnt;++j){obj[rs.h[j]]=row[j];}
var k=keyfn?keyfn(obj):obj[key];if(ret[k]===undefined)
ret[k]=[obj];else
ret[k].push(obj);}
return ret;}
self.list2varr=list2varr;function list2varr(ls,sep,sep2)
{if(sep==null)
sep=':';if(sep2==null)
sep2=',';var ret=[];$.each(ls.split(sep2),function(){if(this.length==0)
return;ret.push(this.split(sep));});return ret;}
self.objarr2list=objarr2list;function objarr2list(objarr,fields,sep,sep2)
{sep=sep||':';sep2=sep2||',';var fn=$.isFunction(fields)?fields:function(e,i){var row='';$.each(fields,function(j,e1){if(row.length>0)
row+=sep;row+=e[e1];});return row;};return $.map(objarr,fn).join(sep2);}
self.intSort=intSort;function intSort(a,b)
{return parseInt(a)-parseInt(b);}
self.numberSort=numberSort;function numberSort(a,b)
{return parseFloat(a)-parseFloat(b);}
self.getAncestor=getAncestor;function getAncestor(o,fn)
{while(o){if(fn(o))
return o;o=o.parentElement;}
return o;}
self.appendParam=appendParam;function appendParam(url,param)
{if(param==null)
return url;var ret;var a=url.split("#");ret=a[0]+(url.indexOf('?')>=0?"&":"?")+param;if(a.length>1){ret+="#"+a[1];}
return ret;}
self.deleteParam=deleteParam;function deleteParam(url,paramName)
{var ret=url.replace(new RegExp('&?'+paramName+"=[^&#]+"),'');if(ret.indexOf('?&')>=0){ret=ret.replace('?&','?');}
return ret;}
self.isWeixin=isWeixin;function isWeixin()
{return/micromessenger/i.test(navigator.userAgent);}
self.isIOS=isIOS;function isIOS()
{return/iPhone|iPad/i.test(navigator.userAgent);}
self.isAndroid=isAndroid;function isAndroid()
{return/Android/i.test(navigator.userAgent);}
self.parseValue=parseValue;function parseValue(str)
{if(str==null)
return str;var val=str;if(/^-?[0-9]+$/.test(str)){val=parseInt(str);}
if(/^-?[0-9.]+$/.test(str)){val=parseFloat(str);}
return val;}
self.applyTpl=applyTpl;function applyTpl(tpl,data)
{return tpl.replace(/{(\w+)}/g,function(m0,m1){return data[m1];});}
self.delayDo=delayDo;function delayDo(fn,delayCnt)
{if(delayCnt==null)
delayCnt=3;doIt();function doIt()
{if(delayCnt==0)
{fn();return;}
--delayCnt;setTimeout(doIt);}}
self.kvList2Str=kvList2Str;function kvList2Str(kv,sep,sep2)
{var ret='';$.each(kv,function(k,v){if(typeof(v)!="function"){if(ret)
ret+=sep;ret+=k+sep2+v;}});return ret;}
self.parseKvList=parseKvList;function parseKvList(str,sep,sep2)
{var map={};$.each(str.split(sep),function(i,e){var kv=e.split(sep2,2);if(kv.length<2){kv[1]=kv[0];}
map[kv[0]]=kv[1];});return map;}
function initModule()
{if(String.prototype.startsWith==null){String.prototype.startsWith=function(s){return this.substr(0,s.length)==s;}}
if(window.console===undefined){window.console={log:function(){}}}}
initModule();}
function jdModule(name,fn,overrideCtor)
{if(!window.jdModuleMap){window.jdModuleMap={};}
if(name==null){return window.jdModuleMap;}
var ret;if(fn instanceof Function){if(window.jdModuleMap[name]){fn.call(window.jdModuleMap[name]);}
else{window.jdModuleMap[name]=new fn();}
ret=window.jdModuleMap[name];if(overrideCtor)
ret.constructor=fn;}
else{ret=window.jdModuleMap[name];if(!ret){throw"load module fails: "+name;}}
return ret;}
jdModule("jdcloud.common",JdcloudCommonJq);function JdcloudCommonJq()
{var self=this;self.assert(window.jQuery,"require jquery lib.");self.getFormData=getFormData;function getFormData(jo)
{var data={};var isFormData=false;var enctype=jo.attr("enctype");if((enctype&&enctype.toLowerCase()=="multipart/form-data")||jo.has("[name]:file").size()>0){isFormData=true;data=new FormData();}
var orgData=jo.data("origin_")||{};formItems(jo,function(name,content){var ji=this;var orgContent=orgData[name];if(orgContent==null)
orgContent="";if(content==null)
content="";if(content!==String(orgContent))
{if(!isFormData){data[name]=content;}
else{if(ji.is(":file")){$.each(ji.prop("files"),function(i,e){data.append(name,e);});}
else{data.append(name,content);}}}});return data;}
self.formItems=formItems;function formItems(jo,cb)
{jo.find("[name]:not([disabled])").each(function(){var name=this.name;if(!name)
return;var ji=$(this);var val;if(ji.is(":input")){if(this.type=="checkbox"&&!this.checked)
return;if(this.type=="radio"&&!this.checked)
return;val=ji.val();}
else{val=ji.html();}
if(cb.call(ji,name,val)===false)
return false;});}
self.setFormData=setFormData;function setFormData(jo,data,opt)
{var opt1=$.extend({setOrigin:false},opt);if(data==null)
data={};var jo1=jo.filter("[name]:not([noReset])");jo.find("[name]:not([noReset])").add(jo1).each(function(){var ji=$(this);var name=ji.attr("name");var content=data[name];var isInput=ji.is(":input");if(content===undefined){if(isInput){if(ji[0].tagName==="TEXTAREA")
content=ji.html();else
content=ji.attr("value");if(content===undefined)
content="";}
else{content="";}}
if(ji.is(":input")){ji.val(content);}
else{ji.html(content);}});jo.data("origin_",opt1.setOrigin?data:null);}
self.loadScript=loadScript;function loadScript(url,fnOK,options)
{if($.isPlainObject(fnOK)){options=fnOK;fnOK=null;}
if(options){var ajaxOpt=$.extend({dataType:"script",cache:true,success:fnOK,url:url,error:function(xhr,textStatus,err){console.log("*** loadScript fails for "+url);console.log(err);}},options);return jQuery.ajax(ajaxOpt);}
var dfd_=$.Deferred();var script=document.createElement('script');script.type='text/javascript';script.src=url;script.onload=function(){if(fnOK)
fnOK();dfd_.resolve();}
script.onerror=function(){dfd_.reject();console.log("*** loadScript fails for "+url);}
document.head.appendChild(script);return dfd_;}
self.setDateBox=setDateBox;function setDateBox(jo,defDateFn)
{jo.blur(function(){var dt=self.parseDate(this.value);if(dt==null){if(defDateFn)
dt=defDateFn();else
dt=new Date();}
this.value=dt.format("D");});}
self.setTimeBox=setTimeBox;function setTimeBox(jo,defTimeFn)
{jo.blur(function(){var dt=self.parseTime(this.value);if(dt==null){if(defTimeFn)
dt=defTimeFn();else
dt=new Date();}
this.value=dt.format("HH:MM");});}
self.waitFor=waitFor;function waitFor(dfd)
{if(waitFor.caller==null)
throw"waitFor MUST be called in function!";if(dfd.state()=="resolved")
return false;if(!dfd.isset_)
{var caller=waitFor.caller;var args=caller.arguments;dfd.isset_=true;dfd.then(function(){caller.apply(this,args);});}
return true;}
self.rgb2hex=rgb2hex;function rgb2hex(rgb)
{var ms=rgb.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);if(ms==null)
return;var hex="#";for(var i=1;i<=3;++i){var s=parseInt(ms[i]).toString(16);if(s.length==1){hex+="0"+s;}
else{hex+=s;}}
return hex;}
$.fn.jdata=function(val){if(val!=null){this.data("jdata",val);return val;}
var jd=this.data("jdata");if(jd==null)
jd=this.jdata({});return jd;}
self.compressImg=compressImg;function compressImg(fileObj,cb,opt)
{var opt0={quality:0.8,maxSize:1280,mimeType:"image/jpeg"};opt=$.extend(opt0,opt);window.BlobBuilder=(window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder);var doDowngrade=!window.Blob||window.BlobBuilder;if(doDowngrade){var rv={name:fileObj.name,size:fileObj.size,b64src:window.URL.createObjectURL(fileObj),blob:fileObj,};rv.info="compress ignored. "+rv.name+": "+(rv.size/1024).toFixed(0)+"KB";console.log(rv.info);cb(rv);return;}
var img=new Image();img.src=window.URL.createObjectURL(fileObj);img.onload=function(){var rv=resizeImg(img);rv.info="compress "+rv.name+" q="+rv.quality+": "+rv.w0+"x"+rv.h0+"->"+rv.w+"x"+rv.h+", "+(rv.size0/1024).toFixed(0)+"KB->"+(rv.size/1024).toFixed(0)+"KB(rate="+(rv.size/rv.size0*100).toFixed(2)+"%,b64="+(rv.b64size/1024).toFixed(0)+"KB)";console.log(rv.info);cb(rv);}
function resizeImg()
{var w=img.naturalWidth,h=img.naturalHeight;if(opt.maxSize<w||opt.maxSize<h){if(w>h){h=Math.round(h*opt.maxSize/w);w=opt.maxSize;}
else{w=Math.round(w*opt.maxSize/h);h=opt.maxSize;}}
var cvs=document.createElement('canvas');cvs.width=w;cvs.height=h;var ctx=cvs.getContext("2d").drawImage(img,0,0,w,h);var b64src=cvs.toDataURL(opt.mimeType,opt.quality);var blob=getBlob(b64src);if(blob.size>fileObj.size){blob=fileObj;b64src=img.src;opt.mimeType=fileObj.type;}
var fname=getFname(fileObj.name,opt.mimeType);return{w0:img.naturalWidth,h0:img.naturalHeight,w:w,h:h,quality:opt.quality,mimeType:opt.mimeType,b64src:b64src,name:fname,blob:blob,size0:fileObj.size,b64size:b64src.length,size:blob.size};}
function getBlob(b64src)
{var bytes=window.atob(b64src.split(',')[1]);var ia=new Uint8Array(bytes.length);for(var i=0;i<bytes.length;i++){ia[i]=bytes.charCodeAt(i);}
var blob;try{blob=new Blob([ia.buffer],{type:opt.mimeType});}
catch(e){if(e.name=='TypeError'&&window.BlobBuilder){var bb=new BlobBuilder();bb.append(ia.buffer);blob=bb.getBlob(opt.mimeType);}
else{}}
return blob;}
function getFname(fname,mimeType)
{var exts={"image/jpeg":".jpg","image/png":".png","image/webp":".webp"};var ext1=exts[mimeType];if(ext1==null)
return fname;return fname.replace(/(\.\w+)?$/,ext1);}}}
function JdcloudApp()
{var self=this;self.ctx=self.ctx||{};window.E_AUTHFAIL=-1;window.E_NOAUTH=2;window.E_ABORT=-100;self.evalAttr=evalAttr;function evalAttr(jo,name,ctx)
{var val=jo.attr(name);if(val){if(val[0]!='{'&&val.indexOf(":")>0){val1="({"+val+"})";}
else{val1="("+val+")";}
try{val=eval(val1);}
catch(ex){self.app_alert("属性`"+name+"'格式错误: "+val,"e");val=null;}}
return val;}
self.ctx.fixPageCss=fixPageCss;function fixPageCss(css,selector)
{var prefix=selector+" ";var level=1;var css1=css.replace(/\/\*(.|\s)*?\*\//g,'').replace(/([^{}]*)([{}])/g,function(ms,text,brace){if(brace=='}'){--level;return ms;}
if(brace=='{'&&level++!=1)
return ms;return ms.replace(/((?:^|,)\s*)([^,{}]+)/g,function(ms,ms1,sel){if(sel.startsWith(prefix)||sel[0]=='@')
return ms;return ms1+prefix+sel;});});return css1;}
self.app_abort=app_abort;function app_abort()
{throw new DirectReturn();}
window.DirectReturn=function(){}
self.setOnError=setOnError;function setOnError()
{var fn=window.onerror;window.onerror=function(msg,script,line,col,errObj){if(fn&&fn.apply(this,arguments)===true)
return true;if(errObj instanceof DirectReturn||/abort$/.test(msg)||(!script&&!line))
return true;debugger;var content=msg+" ("+script+":"+line+":"+col+")";if(errObj&&errObj.stack)
content+="\n"+errObj.stack.toString();if(self.syslog)
self.syslog("fw","ERR",content);app_alert(msg,"e");setTimeout(function(){$.active=0;self.isBusy=0;self.hideLoading();},1000);}}
setOnError();self.m_enhanceFn={};self.enhanceWithin=enhanceWithin;function enhanceWithin(jp)
{$.each(self.m_enhanceFn,function(sel,fn){var jo=jp.find(sel);if(jp.is(sel))
jo=jo.add(jp);if(jo.size()==0)
return;jo.each(function(i,e){var je=$(e);var opt=getOptions(je);if(opt.enhanced)
return;opt.enhanced=true;fn(je);});});}
self.getOptions=getOptions;function getOptions(jo)
{var opt=jo.data("muiOptions");if(opt===undefined){opt={};jo.data("muiOptions",opt);}
return opt;}
function getop(v)
{if(typeof(v)=="number")
return"="+v;var op="=";var is_like=false;var ms;if(ms=v.match(/^(<>|>=?|<=?|!=?)/)){op=ms[1];v=v.substr(op.length);if(op=="!"||op=="!=")
op="<>";}
else if(v.indexOf("*")>=0||v.indexOf("%")>=0){v=v.replace(/[*]/g,"%");op=" like ";}
v=$.trim(v);if(v==="null")
{if(op=="<>")
return" is not null";return" is null";}
if(v==="empty")
v="";if(v.length==0||v.match(/\D/)||v[0]=='0'){v=v.replace(/'/g,"\\'");return op+"'"+v+"'";}
return op+v;}
self.queryHint="查询示例\n"+"文本：\"王小明\", \"王*\"(匹配开头), \"*上海*\"(匹配部分)\n"+"数字：\"5\", \">5\", \"5-10\", \"5-10,12,18\"\n"+"时间：\">=2017-10-1\", \"<2017-10-1 18:00\", \"2017-10\"(10月份区间), \"2017-10-01~2017-11-01\"(10月份区间)\n"+"高级：\"!5\"(排除5),\"1-10 and !5\", \"王*,张*\"(王某或张某), \"empty\"(为空), \"0,null\"(0或未设置)\n";self.getQueryCond=getQueryCond;function getQueryCond(kvList)
{var condArr=[];if($.isPlainObject(kvList)){$.each(kvList,handleOne);}
else if($.isArray(kvList)){$.each(kvList,function(i,e){handleOne(e[0],e[1]);});}
function handleOne(k,v){if(v==null||v==="")
return;var arr=v.toString().split(/\s+(and|or)\s+/i);var str='';var bracket=false;var isTm=/(Tm|^tm)\d*$/.test(k);var isDt=/(Dt|^dt)\d*$/.test(k);$.each(arr,function(i,v1){if((i%2)==1){str+=' '+v1.toUpperCase()+' ';bracket=true;return;}
v1=v1.replace(/，/g,',');var str1='';var bracket2=false;$.each(v1.split(/\s*,\s*/),function(j,v2){if(str1.length>0){str1+=" OR ";bracket2=true;}
var mt;var isHandled=false;if(isTm|isDt){if(mt=v2.match(/^(\d{4})-(\d{1,2})(?:-(\d{1,2}))?$/)){var y=parseInt(mt[1]),m=parseInt(mt[2]),d=mt[3]!=null?parseInt(mt[3]):null;if((y>1900&&y<2100)&&(m>=1&&m<=12)&&(d==null||(d>=1&&d<=31&&isTm))){isHandled=true;var dt1,dt2;if(d){var dt=new Date(y,m-1,d);dt1=dt.format("D");dt2=dt.addDay(1).format("D");}
else{var dt=new Date(y,m-1,1);dt1=dt.format("D");dt2=dt.addMonth(1).format("D");}
str1+="("+k+">='"+dt1+"' AND "+k+"<'"+dt2+"')";}}}
if(!isHandled){if(mt=v2.match(/^(\d{4}-\d{1,2}.*?)\s*~\s*(\d{4}-\d{1,2}.*?)$/)){var dt1=mt[1],dt2=mt[2];str1+="("+k+">='"+dt1+"' AND "+k+"<'"+dt2+"')";isHandled=true;}
else if(mt=v2.match(/^(\d+)-(\d+)$/)){var a=parseInt(mt[1]),b=parseInt(mt[2]);if(a<b){str1+="("+k+">="+mt[1]+" AND "+k+"<="+mt[2]+")";isHandled=true;}}}
if(!isHandled){str1+=k+getop(v2);}});if(bracket2)
str+="("+str1+")";else
str+=str1;});if(bracket)
str='('+str+')';condArr.push(str);}
return condArr.join(' AND ');}
self.getQueryParam=getQueryParam;function getQueryParam(kvList)
{var ret={};var cond=getQueryCond(kvList);if(cond)
ret.cond=cond;return ret;}
self.doSpecial=doSpecial;function doSpecial(jo,filter,fn)
{jo.on("click",filter,function(ev){var INTERVAL=4;var MAX_CNT=5;var tm=new Date();var obj=this;if(fn.cnt==null||fn.lastTm==null||tm-fn.lastTm>INTERVAL*1000||fn.lastObj!=obj)
{fn.cnt=0;fn.lastTm=tm;fn.lastObj=obj;}
if(++fn.cnt<MAX_CNT)
return;fn.cnt=0;fn.lastTm=tm;fn();});}}
function JdcloudCall()
{var self=this;var mCommon=jdModule("jdcloud.common");self.lastError=null;var m_tmBusy;var m_manualBusy=0;var m_appVer;var m_silentCall=0;self.disableBatch=false;var m_curBatch=null;self.m_curBatch=m_curBatch;self.mockData={};var ajaxOpt={beforeSend:function(xhr){this.xhr_=xhr;},dataFilter:function(data,type){if(this.jdFilter!==false&&(type=="json"||type=="text")){rv=defDataProc.call(this,data);if(rv!=null)
return rv;--$.active;self.app_abort();}
return data;},converters:{"text json":true},error:defAjaxErrProc};if(location.protocol=="file:"){ajaxOpt.xhrFields={withCredentials:true};}
$.ajaxSetup(ajaxOpt);self.enterWaiting=enterWaiting;function enterWaiting(ctx)
{if(ctx&&ctx.noLoadingImg){++m_silentCall;return;}
if(self.isBusy==0){m_tmBusy=new Date();}
self.isBusy=1;if(ctx==null||ctx.isMock)
++m_manualBusy;setTimeout(function(){if(self.isBusy)
self.showLoading();},200);}
self.leaveWaiting=leaveWaiting;function leaveWaiting(ctx)
{if(ctx==null||ctx.isMock)
{if(--m_manualBusy<0)
m_manualBusy=0;}
mCommon.delayDo(function(){if(self.options.logAction&&ctx&&ctx.ac&&ctx.tv){var tv2=(new Date()-ctx.tm)-ctx.tv;ctx.tv2=tv2;console.log(ctx);}
if(ctx&&ctx.noLoadingImg)
--m_silentCall;if($.active<0)
$.active=0;if($.active-m_silentCall<=0&&self.isBusy&&m_manualBusy==0){self.isBusy=0;var tv=new Date()-m_tmBusy;m_tmBusy=0;console.log("idle after "+tv+"ms");self.hideLoading();}});}
function defAjaxErrProc(xhr,textStatus,e)
{var ctx=this.ctx_||{};ctx.status=xhr.status;ctx.statusText=xhr.statusText;if(xhr.status==0){self.app_alert("连不上服务器了，是不是网络连接不给力？","e");}
else if(this.handleHttpError){var data=xhr.responseText;var rv=defDataProc.call(this,data);if(rv!=null)
this.success&&this.success(rv);return;}
else{self.app_alert("操作失败: 服务器错误. status="+xhr.status+"-"+xhr.statusText,"e");}
leaveWaiting(ctx);}
self.defDataProc=defDataProc;function defDataProc(rv)
{var ctx=this.ctx_||{};var ext=ctx.ext;if(this.xhr_&&(ext==null||ext=="default")){var val=this.xhr_.getResponseHeader("X-Daca-Server-Rev");if(val&&g_data.serverRev!=val){if(g_data.serverRev){mCommon.reloadSite();}
console.log("Server Revision: "+val);g_data.serverRev=val;}
val=mCommon.parseValue(this.xhr_.getResponseHeader("X-Daca-Test-Mode"));if(g_data.testMode!=val){g_data.testMode=val;if(g_data.testMode)
self.app_alert("测试模式!",{timeoutInterval:2000});}
val=mCommon.parseValue(this.xhr_.getResponseHeader("X-Daca-Mock-Mode"));if(g_data.mockMode!=val){g_data.mockMode=val;if(g_data.mockMode)
self.app_alert("模拟模式!",{timeoutInterval:2000});}}
try{if(rv!==""&&typeof(rv)=="string")
rv=$.parseJSON(rv);}
catch(e)
{leaveWaiting(ctx);self.app_alert("服务器数据错误。");return;}
if(ctx.tm){ctx.tv=new Date()-ctx.tm;}
ctx.ret=rv;leaveWaiting(ctx);if(ext){var filter=self.callSvrExt[ext]&&self.callSvrExt[ext].dataFilter;if(filter){var ret=filter.call(this,rv);if(ret==null||ret===false)
self.lastError=ctx;return ret;}}
if(rv&&$.isArray(rv)&&rv.length>=2&&typeof rv[0]=="number"){if(rv[0]==0)
return rv[1];if(this.noex)
{this.lastError=rv;self.lastError=ctx;return false;}
if(rv[0]==E_NOAUTH){if(self.tryAutoLogin()){$.ajax(this);}
return;}
else if(rv[0]==E_AUTHFAIL){var errmsg=rv[1]||"验证失败，请检查输入是否正确!";self.app_alert(errmsg,"e");return;}
else if(rv[0]==E_ABORT){console.log("!!! abort call");return;}
logError();self.app_alert("操作失败："+rv[1],"e");}
else{logError();self.app_alert("服务器通讯协议异常!","e");}
function logError()
{self.lastError=ctx;console.log("failed call");console.log(ctx);}}
self.getBaseUrl=getBaseUrl;function getBaseUrl()
{return self.options.serverUrl.replace(/\/[^\/]+$/,'/');}
self.makeUrl=makeUrl;function makeUrl(action,params)
{var ext;if($.isArray(action)){if(window.MUI){ext=action[1];action=action[0];}
else{ext="default";action=action[0]+"."+action[1];}}
else{var m=action.match(/^(\w+):(\w.*)/);if(m){ext=m[1];action=m[2];}
else{ext="default";}}
if(action.makeUrl||/^http/.test(action)){if(params==null)
return action;if(action.makeUrl)
return makeUrl(action.action,$.extend({},action.params,params));var url=mCommon.appendParam(action,$.param(params));return makeUrlObj(url);}
if(params==null)
params={};var url;var fnMakeUrl=self.callSvrExt[ext]&&self.callSvrExt[ext].makeUrl;if(fnMakeUrl){url=fnMakeUrl(action,params);}
else if(action.indexOf(".php")<0)
{var opt=self.options;var usePathInfo=!opt.serverUrlAc;if(usePathInfo){if(opt.serverUrl.slice(-1)=='/')
url=opt.serverUrl+action;else
url=opt.serverUrl+"/"+action;}
else{url=opt.serverUrl;params[opt.serverUrlAc]=action;}}
else{if(location.protocol=="file:"){url=getBaseUrl()+action;}
else
url=action;}
if(window.g_cordova){if(m_appVer===undefined)
{var platform="n";if(mCommon.isAndroid()){platform="a";}
else if(mCommon.isIOS()){platform="i";}
m_appVer=platform+"/"+g_cordova;}
params._ver=m_appVer;}
if(self.options.appName)
params._app=self.options.appName;if(g_args._debug)
params._debug=g_args._debug;var ret=mCommon.appendParam(url,$.param(params));return makeUrlObj(ret);function makeUrlObj(url)
{var o=new String(url);o.makeUrl=true;if(action.makeUrl){o.action=action.action;o.params=$.extend({},action.params,params);}
else{o.action=action;o.params=params;}
return o;}}
self.callSvr=callSvr;self.callSvrExt={};function callSvr(ac,params,fn,postParams,userOptions)
{if(params instanceof Function){userOptions=postParams;postParams=fn;fn=params;params=null;}
mCommon.assert(ac!=null,"*** bad param `ac`");var ext=null;var ac0=ac.action||ac;var m;if($.isArray(ac)){mCommon.assert(ac.length==2,"*** bad ac format, require [ac, ext]");ext=ac[1];if(ext!='default')
ac0=ext+':'+ac[0];else
ac0=ac[0];}
else if(m=ac.match(/^(\w+):(\w.*)/)){ext=m[1];}
else if(self.callSvrExt['default']){ext='default';}
var isSyncCall=(userOptions&&userOptions.async==false);if(m_curBatch&&!isSyncCall)
{return m_curBatch.addCall({ac:ac,get:params,post:postParams},fn,userOptions);}
var url=makeUrl(ac,params);var ctx={ac:ac0,tm:new Date()};if(userOptions&&userOptions.noLoadingImg)
ctx.noLoadingImg=1;if(ext){ctx.ext=ext;}
if(self.mockData&&self.mockData[ac0]){ctx.isMock=true;ctx.getMockData=function(){var d=self.mockData[ac0];var param1=$.extend({},url.params);var postParam1=$.extend({},postParams);if($.isFunction(d)){d=d(param1,postParam1);}
if(self.options.logAction)
console.log({ac:ac0,ret:d,params:param1,postParams:postParam1,userOptions:userOptions});return d;}}
enterWaiting(ctx);var callType="call";if(isSyncCall)
callType+="-sync";if(ctx.isMock)
callType+="-mock";var method=(postParams==null?'GET':'POST');var opt={dataType:'text',url:url,data:postParams,type:method,success:fn,xhrFields:{withCredentials:true},ctx_:ctx};if(window.FormData&&postParams instanceof FormData){opt.processData=false;opt.contentType=false;}
$.extend(opt,userOptions);if(ext&&self.callSvrExt[ext].beforeSend){self.callSvrExt[ext].beforeSend(opt);}
var isJson=opt.contentType&&opt.contentType.indexOf("/json")>0;if(isJson&&opt.data instanceof Object)
opt.data=JSON.stringify(opt.data);console.log(callType+": "+opt.type+" "+ac0);if(ctx.isMock)
return callSvrMock(opt,isSyncCall);return $.ajax(opt);}
function callSvrMock(opt,isSyncCall)
{var dfd_=$.Deferred();var opt_=opt;if(isSyncCall){callSvrMock1();}
else{setTimeout(callSvrMock1,self.options.mockDelay);}
return dfd_;function callSvrMock1()
{var data=opt_.ctx_.getMockData();if(typeof(data)!="string")
data=JSON.stringify(data);var rv=defDataProc.call(opt_,data);if(rv!=null)
{opt_.success&&opt_.success(rv);dfd_.resolve(rv);return;}
self.app_abort();}}
self.callSvrSync=callSvrSync;function callSvrSync(ac,params,fn,postParams,userOptions)
{var ret;if(params instanceof Function){userOptions=postParams;postParams=fn;fn=params;params=null;}
userOptions=$.extend({async:false},userOptions);var dfd=callSvr(ac,params,fn,postParams,userOptions);dfd.then(function(data){ret=data;});return ret;}
self.setupCallSvrViaForm=setupCallSvrViaForm;function setupCallSvrViaForm($form,$iframe,url,fn,callOpt)
{$form.attr("action",url);$iframe.on("load",function(){var data=this.contentDocument.body.innerText;if(data=="")
return;var rv=defDataProc.call(callOpt,data);if(rv==null)
self.app_abort();fn(rv);});}
self.batchCall=batchCall;function batchCall(opt)
{mCommon.assert(m_curBatch==null,"*** multiple batch call!");this.opt_=opt;this.calls_=[];this.callOpts_=[];if(!self.disableBatch)
m_curBatch=this;}
batchCall.prototype={addCall:function(call0,fn,opt0){var call=$.extend({},call0);var opt=$.extend({},opt0);if(opt.ref){call.ref=opt.ref;}
if(call.ac&&call.ac.makeUrl){call.get=$.extend({},call.ac.params,call.get);call.ac=call.ac.action;}
this.calls_.push(call);var callOpt={fn:fn,opt:opt,dfd:$.Deferred()};this.callOpts_.push(callOpt);return callOpt.dfd;},deferred:function(){return this.dfd_;},commit:function(){if(m_curBatch==null)
return;m_curBatch=null;if(this.calls_.length<1){console.log("!!! warning: batch has "+this.calls_.length+" calls!");return;}
if(this.calls_.length==1){var call=this.calls_[0];var callOpt=this.callOpts_[0];var dfd=callSvr(call.ac,call.get,callOpt.fn,call.post,callOpt.opt);dfd.then(function(data){callOpt.dfd.resolve(data);});return;}
var batch_=this;var postData=this.calls_;callSvr("batch",this.opt_,api_batch,postData,{contentType:"application/json; charset=utf-8"});function api_batch(data)
{var ajaxCtx_=this;$.each(data,function(i,e){var callOpt=batch_.callOpts_[i];var extendCtx=false;if(callOpt.opt&&!$.isEmptyObject(callOpt.opt)){extendCtx=true;$.extend(ajaxCtx_,callOpt.opt);}
var data1=defDataProc.call(ajaxCtx_,e);if(data1!=null){if(callOpt.fn){callOpt.fn.call(ajaxCtx_,data1);}
callOpt.dfd.resolve(data1);}
if(extendCtx){$.each(Object.keys(callOpt.opt),function(){ajaxCtx_[this]=null;});}});}},cancel:function(){m_curBatch=null;}}
self.useBatchCall=useBatchCall;function useBatchCall(opt,tv)
{if(self.disableBatch)
return;if(m_curBatch!=null)
return;tv=tv||0;var batch=new self.batchCall(opt);setTimeout(function(){batch.commit();},tv);}}
function JdcloudPage()
{var self=this;self.ctx=self.ctx||{};var mCommon=jdModule("jdcloud.common");var m_batchMode=false;mCommon.assert($.fn.combobox,"require jquery-easyui lib.");self.getRow=getRow;function getRow(jtbl)
{var row=jtbl.datagrid('getSelected');if(!row)
{self.app_alert("请先选择一行。","w");return null;}
return row;}
self.reload=reload;function reload(jtbl,url,queryParams)
{if(url!=null||queryParams!=null){var opt=jtbl.datagrid("options");if(url!=null){opt.url=url;}
if(queryParams!=null){opt.queryParams=queryParams;}}
if(jtbl.is(":hidden")){var opage=mCommon.getAncestor(jtbl[0],istab);if(opage&&opage.title)
$(opage).closest(".easyui-tabs").tabs("select",opage.title);}
resetPageNumber(jtbl);jtbl.datagrid('reload');jtbl.datagrid('clearSelections');}
self.reloadTmp=reloadTmp;function reloadTmp(jtbl,url,queryParams)
{var opt=jtbl.datagrid("options");var url_bak=opt.url;var param_bak=opt.queryParams;reload(jtbl,url,queryParams);opt.url=url_bak;opt.queryParams=param_bak;}
function jdListToDgList(data)
{var ret=data;if($.isArray(data)){ret={total:data.length,rows:data};}
else if($.isArray(data.list)){ret={total:data.total||data.list.length,rows:data.list};}
else if(data.h!==undefined)
{var arr=mCommon.rs2Array(data);ret={total:data.total||arr.length,rows:arr};}
return ret;}
function jdListToArray(data)
{var ret=data;if($.isArray(data)){ret=data;}
else if($.isArray(data.list)){ret=data.list;}
else if(data.h!==undefined)
{ret=mCommon.rs2Array(data);}
return ret;}
self.reloadRow=reloadRow;function reloadRow(jtbl,rowData)
{if(rowData==null){rowData=jtbl.datagrid('getSelected');if(rowData==null)
return;}
jtbl.datagrid("loading");var opt=jtbl.datagrid("options");self.callSvr(opt.url,api_queryOne,{cond:"id="+rowData.id});function api_queryOne(data)
{jtbl.datagrid("loaded");var idx=jtbl.datagrid("getRowIndex",rowData);var objArr=jdListToArray(data);if(idx!=-1&&objArr.length==1){for(var k in rowData)
delete rowData[k];$.extend(rowData,objArr[0]);jtbl.datagrid("refreshRow",idx);}}}
function appendRow(jtbl,id)
{jtbl.datagrid("loading");var opt=jtbl.datagrid("options");self.callSvr(opt.url,api_queryOne,{cond:"id="+id});function api_queryOne(data)
{jtbl.datagrid("loaded");var objArr=jdListToArray(data);if(objArr.length!=1)
return;var row=objArr[0];if(opt.sortOrder=="desc")
jtbl.datagrid("insertRow",{index:0,row:row});else
jtbl.datagrid("appendRow",row);}}
function tabid(title)
{return"pg_"+title.replace(/[ ()\[\]]/g,"_");}
function istab(o)
{var id=o.getAttribute("id");return id&&id.substr(0,3)=="pg_";}
function callInitfn(jo,paramArr)
{if(jo.jdata().init)
return;var attr=jo.attr("my-initfn");if(attr==null)
return;try{initfn=eval(attr);}
catch(e){self.app_alert("bad initfn: "+attr,"e");}
if(initfn)
{console.log("### initfn: "+attr);initfn.apply(jo,paramArr||[]);}
jo.jdata().init=true;}
function getModulePath(file)
{return self.options.pageFolder+"/"+file;}
self.showPage=showPage;function showPage(pageName,title,paramArr)
{var showPageArgs_=arguments;var sel="#my-pages > div."+pageName;var jpage=$(sel);if(jpage.length>0){initPage();}
else{sel="#tpl_"+pageName;var html=$(sel).html();if(html){loadPage(html,pageName,null);return;}
var pageFile=getModulePath(pageName+".html");$.ajax(pageFile).then(function(html){loadPage(html,pageName,pageFile);}).fail(function(){});}
function initPage()
{if(title==null)
title=jpage.attr("title")||"无标题";var tt=self.tabMain;if(tt.tabs('exists',title)){tt.tabs('select',title);return;}
var id=tabid(title);var content="<div id='"+id+"' title='"+title+"' />";var closable=(pageName!=self.options.pageHome);tt.tabs('add',{title:title,closable:closable,fit:true,content:content});var jtab=$("#"+id);var jpageNew=jpage.clone().appendTo(jtab);jpageNew.addClass('wui-page');jpageNew.attr("wui-pageName",pageName);jpageNew.attr("title",title);$.parser.parse(jpageNew);self.enhanceWithin(jpageNew);callInitfn(jpageNew,paramArr);jpageNew.data("showPageArgs_",showPageArgs_);jpageNew.trigger('pagecreate');jpageNew.trigger('pageshow');}
function loadPage(html,pageClass,pageFile)
{var jcontainer=$("#my-pages");jpage=$(html).filter("div");if(jpage.size()>1||jpage.size()==0){console.log("!!! Warning: bad format for page '"+pageClass+"'. Element count = "+jpage.size());jpage=jpage.filter(":first");}
jpage.find("style").each(function(){$(this).html(self.ctx.fixPageCss($(this).html(),"."+pageClass));});jpage.find("style").attr("wui-origin",pageClass).appendTo(document.head);jpage.attr("wui-pageFile",pageFile);jpage.addClass(pageClass).appendTo(jcontainer);var val=jpage.attr("wui-script");if(val!=null){var path=getModulePath(val);var dfd=mCommon.loadScript(path,initPage);dfd.fail(function(){self.app_alert("加载失败: "+val);self.leaveWaiting();});}
else{initPage();}}}
self.closeDlg=closeDlg;function closeDlg(jdlg)
{jdlg.dialog("close");}
function openDlg(jdlg)
{jdlg.dialog("open");}
function focusDlg(jdlg)
{var jo;jdlg.find(":input[type!=hidden]").each(function(i,o){var jo1=$(o);if(!jo1.prop("disabled")&&!jo1.prop("readonly")){jo=jo1;return false;}});if(jo==null)
jo=jdlg.find("a button");if(jo)
setTimeout(function(){jo.focus()},50);}
$.fn.okCancel=function(fnOk,fnCancel){this.unbind("keydown").keydown(function(e){if(e.keyCode==13&&e.target.tagName!="TEXTAREA"&&fnOk){fnOk();return false;}
else if(e.keyCode==27&&fnCancel){fnCancel();return false;}
else if(e.ctrlKey&&e.which==70)
{showObjDlg($(this),FormMode.forFind,null);return false;}});}
self.showDlg=showDlg;function showDlg(jdlg,opt)
{if(jdlg.constructor!=jQuery)
jdlg=$(jdlg);if(loadDialog(jdlg,onLoad))
return;function onLoad(){showDlg(jdlg,opt);}
opt=$.extend({okLabel:"确定",cancelLabel:"取消",noCancel:false,modal:true,reset:true,validate:true},opt);jdlg.addClass('wui-dialog');callInitfn(jdlg);var jfrm=jdlg.is("form")?jdlg:jdlg.find("form:first");var formMode=jdlg.jdata().mode;jfrm.trigger("beforeshow",[formMode,opt]);var btns=[{text:opt.okLabel,iconCls:'icon-ok',handler:fnOk}];if(!opt.noCancel)
btns.push({text:opt.cancelLabel,iconCls:'icon-cancel',handler:fnCancel})
if($.isArray(opt.buttons))
btns.push.apply(btns,opt.buttons);var dlgOpt={maximizable:true,collapsible:true,resizable:true,left:null,top:null,closable:!opt.noCancel,modal:opt.modal,buttons:btns,title:opt.title};if(jdlg.is(":visible")){dlgOpt0=jdlg.dialog("options");$.extend(dlgOpt,{left:dlgOpt0.left,top:dlgOpt0.top});}
jdlg.dialog(dlgOpt);jdlg.okCancel(fnOk,opt.noCancel?undefined:fnCancel);if(opt.reset)
{mCommon.setFormData(jdlg);jdlg.find("[type=hidden]:not([noReset])").val("");jdlg.find(".my-reset").empty();}
if(opt.data)
{jfrm.trigger("initdata",[opt.data,formMode]);var setOrigin=(formMode==FormMode.forSet);mCommon.setFormData(jdlg,opt.data,{setOrigin:setOrigin});jfrm.trigger("loaddata",[opt.data,formMode]);}
focusDlg(jdlg);jfrm.trigger("show",[formMode,opt.data]);function fnCancel(){closeDlg(jdlg)}
function fnOk()
{if(jdlg.hasClass("wui-readonly")&&formMode!=FormMode.forFind){closeDlg(jdlg);return;}
var ret=opt.validate?jfrm.form("validate"):true;if(!ret)
return false;var newData={};var ev=$.Event("validate");jfrm.trigger(ev,[formMode,opt.data,newData]);if(ev.isDefaultPrevented())
return false;var ev=$.Event("savedata");jfrm.trigger(ev,[formMode,opt.data]);if(ev.isDefaultPrevented())
return false;var data=mCommon.getFormData(jdlg);$.extend(data,newData);if(opt.url){if(opt.onSubmit&&opt.onSubmit(data)===false)
return false;if(m_batchMode&&formMode==FormMode.forSet&&opt.url.action&&/.set$/.test(opt.url.action)){var jtbl=jdlg.jdata().jtbl;var obj=opt.url.action.replace(".set","");batchOp(obj,"setIf",jtbl,data,function(){closeDlg(jdlg);});return;}
self.callSvr(opt.url,success,data);}
else{success(data);}
function success(data)
{if(data!=null&&opt.onOk){jfrm.trigger('retdata',[data,formMode]);opt.onOk.call(jdlg,data);}}}}
$(document).keydown(function(e){if(e.ctrlKey&&!m_batchMode){m_batchMode=true;setTimeout(function(){m_batchMode=false;},200);}});function batchOp(obj,ac,jtbl,data,fn)
{if(obj==null||jtbl==null)
return;var acName;if(ac=="setIf"){acName="批量更新";}
else if(ac=="delIf"){acName="批量删除";}
else{return;}
var cond=getQueryParamFromTable(jtbl).cond;if(!cond){cond="id>0";}
self.callSvr(obj+".query",{cond:cond,res:"count(*) cnt"},function(data1){console.log(obj+"."+ac+": "+cond);app_confirm(acName+data1.d[0][0]+"条记录？",function(b){if(!b)
return;self.callSvr(obj+"."+ac,{cond:cond},function(cnt){fn&&fn();reload(jtbl);app_alert(acName+cnt+"条记录");},data);});});return;}
self.getTopDialog=getTopDialog;function getTopDialog()
{var val=0;var jo=$();$(".window:visible").each(function(i,e){var z=parseInt(this.style.zIndex);if(z>val){val=z;jo=$(this).find(".wui-dialog");}});return jo;}
self.unloadPage=unloadPage;function unloadPage(pageName)
{if(pageName==null){pageName=self.getActivePage().attr("wui-pageName");if(pageName==null)
return;self.tabClose();}
var jo=$("."+pageName);if(jo.attr("wui-pageFile")==null)
return;jo.remove();$("style[wui-origin="+pageName+"]").remove();}
self.reloadPage=reloadPage;function reloadPage()
{var showPageArgs=self.getActivePage().data("showPageArgs_");self.unloadPage();self.showPage.apply(this,showPageArgs);}
self.unloadDialog=unloadDialog;self.reloadDialog=unloadDialog;function unloadDialog(all)
{var jdlg=all?$(".wui-dialog[wui-pageFile]"):getTopDialog();if(jdlg.size()==0)
return;try{closeDlg(jdlg);}catch(ex){console.log(ex);}
if(jdlg.attr("wui-pageFile")==null)
return;var dlgId=jdlg.attr("id");try{jdlg.dialog("destroy");}catch(ex){console.log(ex);}
jdlg.remove();$("style[wui-origin="+dlgId+"]").remove();return jdlg;}
var BTN_TEXT=["添加","保存","保存","查找","删除"];function getFindData(jfrm)
{var kvList={};var kvList2={};jfrm.find(":input[name]").each(function(i,e){if($(e).hasClass("notForFind"))
return;var v=$(e).val();if(v==null||v==="")
return;if($(e).hasClass("wui-notCond"))
kvList2[e.name]=v;else
kvList[e.name]=v;})
var param=self.getQueryParam(kvList);if(kvList2)
$.extend(param,kvList2);return param;}
function loadDialog(jdlg,onLoad)
{if(jdlg.size()>0&&jdlg[0].parentElement!=null&&jdlg[0].parentElement.parentElement!=null)
return;var jo=$(jdlg.selector);if(jo.size()>0){fixJdlg(jo);return;}
function fixJdlg(jo)
{jdlg.splice(0,jdlg.size(),jo[0]);}
var dlgId=jdlg.selector.substr(1);var sel="#tpl_"+dlgId;var html=$(sel).html();if(html){loadDialogTpl(html,dlgId,pageFile);return;}
var pageFile=getModulePath(dlgId+".html");$.ajax(pageFile).then(function(html){loadDialogTpl(html,dlgId,pageFile);}).fail(function(){});function loadDialogTpl(html,dlgId,pageFile)
{var jcontainer=$("#my-pages");var jo=$(html).filter("div,form");if(jo.size()>1||jo.size()==0){console.log("!!! Warning: bad format for dialog '"+dlgId+"'. Element count = "+jo.size());jo=jo.filter(":first");}
fixJdlg(jo);jdlg.find("style").each(function(){$(this).html(self.ctx.fixPageCss($(this).html(),jdlg.selector));});jdlg.find("style").attr("wui-origin",dlgId).appendTo(document.head);jdlg.attr("id",dlgId).appendTo(jcontainer);jdlg.attr("wui-pageFile",pageFile);$.parser.parse(jdlg);jdlg.find(">table:first, form>table:first").addClass("wui-form-table");self.enhanceWithin(jdlg);var val=jdlg.attr("wui-script");if(val!=null){var path=getModulePath(val);var dfd=mCommon.loadScript(path,onLoad);dfd.fail(function(){self.app_alert("加载失败: "+val);});}
else{onLoad();}}
return true;}
self.showObjDlg=showObjDlg;function showObjDlg(jdlg,mode,opt)
{opt=$.extend({mode:mode},jdlg.objParam,opt);if(jdlg.constructor!=jQuery)
jdlg=$(jdlg);if(loadDialog(jdlg,onLoad))
return;function onLoad(){showObjDlg(jdlg,mode,opt);}
callInitfn(jdlg);if(opt.jtbl){jdlg.jdata().jtbl=opt.jtbl;}
var id=opt.id;var obj=opt.obj||jdlg.attr("my-obj");mCommon.assert(obj);var jd=jdlg.jdata();var jd2=jd.jtbl&&jd.jtbl.jdata();var rowData;if(id==null){if(mode==FormMode.forSet||mode==FormMode.forDel)
{mCommon.assert(jd.jtbl);if(mode==FormMode.forDel&&m_batchMode){batchOp(obj,"delIf",jd.jtbl);return;}
rowData=getRow(jd.jtbl);if(rowData==null)
return;id=rowData.id;}}
var url;if(mode==FormMode.forAdd){if(!opt.offline)
url=self.makeUrl([obj,"add"],jd.url_param);if(jd.jtbl)
jd.jtbl.datagrid("clearSelections");}
else if(mode==FormMode.forSet){if(!opt.offline)
url=self.makeUrl([obj,"set"],{id:id});}
else if(mode==FormMode.forDel){if(opt.offline){if(jd.jtbl){var rowIndex=jd.jtbl.datagrid("getRowIndex",rowData);jd.jtbl.datagrid("deleteRow",rowIndex);opt.onCrud&&opt.onCrud();}
return;}
self.app_confirm("确定要删除一条记录?",function(b){if(!b)
return;var ac=obj+".del";self.callSvr(ac,{id:id},function(data){if(jd.jtbl)
reload(jd.jtbl);self.app_show('删除成功!');opt.onCrud&&opt.onCrud();});});return;}
var jfrm=jdlg.is("form")?jdlg:jdlg.find("form:first");var doReset=!(jd.mode==FormMode.forFind&&mode==FormMode.forFind)
if(mode==FormMode.forFind&&jd.mode!=FormMode.forFind){jfrm.find(":input[name]").each(function(i,e){var je=$(e);var bak=je.jdata().bak={disabled:je.prop("disabled"),title:je.prop("title"),type:null}
if(je.hasClass("notForFind")||je.attr("notForFind")!=null){je.prop("disabled",true);je.css("backgroundColor","");}
else{je.prop("disabled",false);je.addClass("wui-find-field");je.prop("title",self.queryHint);var type=je.attr("type");if(type&&["number","date","time","datetime"].indexOf(type)>=0){bak.type=type;je.attr("type","text");}}});jfrm.find(".easyui-validatebox").validatebox("disableValidation");}
else if(jd.mode==FormMode.forFind&&mode!=FormMode.forFind){jfrm.find(":input[name]").each(function(i,e){var je=$(e);var bak=je.jdata().bak;je.prop("disabled",bak.disabled);je.removeClass("wui-find-field");je.prop("title",bak.title);if(bak.type){je.attr("type",bak.type);}})
jfrm.find(".easyui-validatebox").validatebox("enableValidation");}
jd.mode=mode;var load_data;if(mode==FormMode.forAdd){var init_data=jd.init_data||(jd2&&jd2.init_data);load_data=$.extend({},init_data);}
else if(mode==FormMode.forSet){if(rowData){load_data=$.extend({},rowData);}
else{var load_url=self.makeUrl([obj,'get'],{id:id});var data=self.callSvrSync(load_url);if(data==null)
return;load_data=data;}}
opt.reloadRow=function(){if(mode==FormMode.forSet&&opt.jtbl&&rowData)
self.reloadRow(opt.jtbl,rowData);};showDlg(jdlg,{url:url,title:opt.title,okLabel:BTN_TEXT[mode],validate:mode!=FormMode.forFind,modal:false,reset:doReset,data:load_data,onSubmit:onSubmit,onOk:onOk,objParam:opt});if(mode==FormMode.forSet)
jfrm.form("validate");function onSubmit(data){if(mode==FormMode.forSet){if($.isEmptyObject(data)){closeDlg(jdlg);return false;}}}
function onOk(retData){var jtbl=jd.jtbl;if(mode==FormMode.forFind){var param=getFindData(jfrm);mCommon.assert(jtbl);var dgOpt=jtbl.datagrid("options");if(param.cond&&dgOpt&&dgOpt.url&&dgOpt.url.params&&dgOpt.url.params.cond){param.cond=dgOpt.url.params.cond+" AND ("+param.cond+")";}
reload(jtbl,undefined,param);opt.onCrud&&opt.onCrud();return;}
if(jtbl){if(opt.offline){if(mode==FormMode.forSet&&rowData){var idx=jtbl.datagrid("getRowIndex",rowData);$.extend(rowData,retData);jtbl.datagrid("refreshRow",idx);}
else if(mode==FormMode.forAdd){jtbl.datagrid("appendRow",retData);}}
else{if(mode==FormMode.forSet&&rowData)
reloadRow(jtbl,rowData);else if(mode==FormMode.forAdd){appendRow(jtbl,retData);}
else
reload(jtbl);}}
if(mode==FormMode.forAdd)
{showObjDlg(jdlg,mode);}
else
{closeDlg(jdlg);}
if(!opt.offline)
self.app_show('操作成功!');opt.onCrud&&opt.onCrud();}}
self.dg_toolbar=dg_toolbar;function dg_toolbar(jtbl,jdlg)
{var toolbar=jtbl.jdata().toolbar||"rfasd";var btns=[];var tb={r:{text:'刷新',iconCls:'icon-reload',handler:function(){reload(jtbl);}},f:{text:'查询',iconCls:'icon-search',handler:function(){showObjDlg(jdlg,FormMode.forFind,{jtbl:jtbl});}},a:{text:'新增',iconCls:'icon-add',handler:function(){showObjDlg(jdlg,FormMode.forAdd,{jtbl:jtbl});}},s:{text:'修改',iconCls:'icon-edit',handler:function(){showObjDlg(jdlg,FormMode.forSet,{jtbl:jtbl});}},d:{text:'删除',iconCls:'icon-remove',handler:function(){showObjDlg(jdlg,FormMode.forDel,{jtbl:jtbl});}},'export':{text:'导出',iconCls:'icon-save',handler:getExportHandler(jtbl)}};$.each(toolbar.split(""),function(i,e){if(tb[e]){btns.push(tb[e]);btns.push("-");}});for(var i=2;i<arguments.length;++i){var btn=arguments[i];if(!btn)
continue;if(btn!=='-'&&typeof(btn)=="string"){btn=tb[btn];mCommon.assert(btn,"toolbar button name does not support");}
btns.push(btn);}
return btns;}
self.dg_dblclick=function(jtbl,jdlg)
{return function(idx,data){jtbl.datagrid("selectRow",idx);showObjDlg(jdlg,FormMode.forSet,{jtbl:jtbl});}}
self.m_enhanceFn["a[href^=#]"]=enhanceAnchor;function enhanceAnchor(jo)
{if(jo.attr("onclick"))
return;jo.click(function(ev){var href=$(this).attr("href");if(href.search(/^#(page\w+)$/)>=0){var pageName=RegExp.$1;WUI.showPage.call(this,pageName);return false;}
else if(href.search(/^\?(\w+)$/)>=0){var fn=RegExp.$1;fn=eval(fn);if(fn)
fn.call(this);return false;}});}
self.getExportHandler=getExportHandler;function getExportHandler(jtbl,ac,param)
{if(param==null)
param={};if(param.fmt===undefined)
param.fmt="excel";if(param.pagesz===undefined)
param.pagesz=-1;if(ac==null){setTimeout(function(){ac=jtbl.datagrid("options").url;});}
return function(){var url=WUI.makeUrl(ac,getQueryParamFromTable(jtbl,param));console.log("export: "+url);console.log("(HINT: debug via window.open=$.get)");window.open(url);}}
self.getQueryParamFromTable=self.getParamFromTable=getQueryParamFromTable;function getQueryParamFromTable(jtbl,param)
{var opt=jtbl.datagrid("options");param=$.extend({},opt.queryParams,param);if(param.orderby===undefined&&opt.sortName){param.orderby=opt.sortName;if(opt.sortOrder&&opt.sortOrder.toLowerCase()!="asc")
param.orderby+=" "+opt.sortOrder;}
if(param.res===undefined){var res='';$.each(opt.columns[0],function(i,e){if(!e.field||e.field.substr(-1)=="_")
return;if(res.length>0)
res+=',';res+=e.field+" \""+e.title+"\"";if(e.jdEnumMap){res+='='+mCommon.kvList2Str(e.jdEnumMap,';',':');}});param.res=res;}
if(param.fname===undefined){param.fname=jtbl.prop("title")||jtbl.closest(".wui-page").prop("title");}
return param;}
var Formatter={dt:function(value,row){var dt=WUI.parseDate(value);if(dt==null)
return value;return dt.format("L");},number:function(value,row){return parseFloat(value);},pics:function(value,row){if(value==null)
return"(无图)";return'<a target="_black" href="'+WUI.makeUrl("pic",{id:value})+'">'+value+'</a>';},flag:function(yes,no){if(yes==null)
yes="是";if(no==null)
no="否";return function(value,row){if(value==null)
return;return value?yes:no;}},enum:function(enumMap,sep){sep=sep||',';return function(value,row){if(value==null)
return;var v=enumMap[value];if(v!=null)
return v;if(value.indexOf(sep)>0){var v1=$.map(value.split(sep),function(e){return enumMap[e]||e;});v=v1.join(sep);}
else{v=value;}
return v;}},linkTo:function(field,dlgRef){return function(value,row){if(value==null)
return;return self.makeLinkTo(dlgRef,row[field],value);}}};self.formatter=Formatter;$.extend($.fn.combobox.defaults,{valueField:'val',textField:'text'});function dgLoader(param,success,error)
{var jo=$(this);var opts=jo.datagrid("options");if(opts.data){return defaultDgLoader.apply(this,arguments);}
if(opts.url==null)
return false;var param1={};for(var k in param){if(k==="sort"){param1.orderby=param.sort+" "+param.order;}
else if(k==="order"){}
else{param1[k]=param[k];}}
self.callSvr(opts.url,param1,success);}
function dgLoadFilter(data)
{var ret=jdListToDgList(data);var isOnePage=(ret.total==ret.rows.length);$(this).datagrid("getPager").toggle(!(isOnePage&&ret.total<=5));$(this).datagrid("options").remoteSort=(!isOnePage);return ret;}
function resetPageNumber(jtbl)
{var opt=jtbl.datagrid('options');if(opt.pagination&&opt.pageNumber)
{opt.pageNumber=1;var jpager=jtbl.datagrid("getPager");jpager.pagination("refresh",{pageNumber:opt.pageNumber});}}
var defaultDgLoader=$.fn.datagrid.defaults.loader;$.extend($.fn.datagrid.defaults,{rownumbers:true,singleSelect:true,pagination:true,pageSize:20,pageList:[20,30,50],loadFilter:dgLoadFilter,loader:dgLoader,onLoadError:self.ctx.defAjaxErrProc,onBeforeSortColumn:function(sort,order){var jtbl=$(this);resetPageNumber(jtbl);},onLoadSuccess:function(data){$(this).datagrid("fitColumns");}});var DefaultValidateRules={number:{validator:function(v){return v.length==0||/^[0-9.-]+$/.test(v);},message:'必须为数字!'},uname:{validator:function(v){return v.length==0||(v.length>=4&&v.length<=16&&/^[a-z]\w+$/i.test(v));},message:"4-16位英文字母或数字，以字母开头，不能出现符号."},pwd:{validator:function(v){return v.length==0||(v.length>=4&&v.length<=16)||v.length==32;},message:"4-16位字母、数字或符号."},equalTo:{validator:function(v,param){return v.length==0||v==$(param[0]).val();},message:"两次输入不一致."},cellphone:{validator:function(v){return v.length==0||(v.length==11&&!/\D/.test(v));},message:"手机号为11位数字"},datetime:{validator:function(v){return v.length==0||/\d{4}-\d{1,2}-\d{1,2}( \d{1,2}:\d{1,2}(:\d{1,2})?)?/.test(v);},message:"格式为\"年-月-日 时:分:秒\"，时间部分可忽略"},usercode:{validator:function(v){return v.length==0||/^[a-zA-Z]/.test(v)||(v.length==11&&!/\D/.test(v));},message:"11位手机号或客户代码"}};$.extend($.fn.validatebox.defaults.rules,DefaultValidateRules);self.m_enhanceFn[".my-combobox"]=function(jo){jo.mycombobox();};self.m_enhanceFn[".wui-form-table"]=enhanceTableLayout;function enhanceTableLayout(jo){var tbl=jo[0];if(tbl.rows.length==0)
return;var tr=tbl.rows[0];var colCnt=tr.cells.length;var doAddTr=false;for(var j=0;j<tr.cells.length;++j){var td=tr.cells[j];if(td.getAttribute("colspan")!=null){colCnt+=parseInt(td.getAttribute("colspan"))-1;doAddTr=true;}}
var rates={2:["10%","90%"],4:["10%","40%","10%","40%"],6:["5%","25%","5%","25%","5%","25%"]};if(!rates[colCnt])
return;if(doAddTr){var td=dup("<td></td>",colCnt);$('<tr class="wui-form-table-tr-width" style="visibility:hidden">'+td+'</tr>').prependTo(jo);tr=tbl.rows[0];}
for(var i=0;i<colCnt;++i){var je=$(tr.cells[i]);if(je.attr("width")==null)
je.attr("width",rates[colCnt][i]);}
function dup(s,n){var ret='';for(var i=0;i<n;++i){ret+=s;}
return ret;}};function main()
{self.title=document.title;self.container=$(".wui-container");if(self.container.size()==0)
self.container=$(document.body);self.enhanceWithin(self.container);self.container.trigger("wuiInit");}
$(main);}
jdModule("jdcloud.wui",JdcloudWui);function JdcloudWui()
{var self=this;var mCommon=jdModule("jdcloud.common");JdcloudApp.call(self);JdcloudCall.call(self);JdcloudPage.call(self);self.isBusy=false;window.g_args={};window.g_data={};window.BASE_URL="../";window.FormMode={forAdd:'A',forSet:'S',forLink:'S',forFind:'F',forDel:'D'};self.options={title:"客户端",appName:"user",onShowLogin:function(){throw"NotImplemented";},pageHome:"pageHome",pageFolder:"page",serverUrl:"./",logAction:false,PAGE_SZ:20,manualSplash:false,mockDelay:50};function parseArgs()
{if(location.search){g_args=mCommon.parseQuery(location.search.substr(1));if(g_args.test||g_args._test){g_args._test=1;alert("测试模式!");}}}
parseArgs();self.app_alert=app_alert;function app_alert(msg)
{var type="i";var fn=undefined;var alertOpt={};var jmsg;for(var i=1;i<arguments.length;++i){var arg=arguments[i];if($.isFunction(arg)){fn=arg;}
else if($.isPlainObject(arg)){alertOpt=arg;}
else if(typeof(arg)==="string"){type=arg;}}
if(type=="q"){app_confirm(msg,function(isOk){if(isOk){fn&&fn();}
else if(alertOpt.onCancel){alertOpt.onCancel();}});return;}
else if(type=="p"){jmsg=$.messager.prompt(self.options.title,msg,function(text){if(text&&fn){fn(text);}});setTimeout(function(){var ji=jmsg.find(".messager-input");ji.focus();if(alertOpt.defValue){ji.val(alertOpt.defValue);}});return;}
var icon={i:"info",w:"warning",e:"error"}[type];var s={i:"提示",w:"警告",e:"出错"}[type]||"";var s1="<b>["+s+"]</b>";jmsg=$.messager.alert(self.options.title+" - "+s,s1+" "+msg,icon,fn);setTimeout(function(){var jbtn=jmsg.find(".l-btn");jbtn.focus();if(alertOpt.timeoutInterval){setTimeout(function(){jbtn.click();},alertOpt.timeoutInterval);}});}
self.app_confirm=app_confirm;function app_confirm(msg,fn)
{var s="<div style='font-size:10pt'>"+msg.replace(/\n/g,"<br/>")+"</div>";$.messager.confirm(self.options.title+" - "+"确认",s,fn);}
self.app_show=app_show;function app_show(msg)
{$.messager.show({title:self.options.title,msg:msg});}
self.makeLinkTo=makeLinkTo;function makeLinkTo(dlg,id,text,obj)
{if(text==null)
text=id;var optStr=obj==null?"{id:"+id+"}":"{id:"+id+",obj:\""+obj+"\"}";return"<a href=\""+dlg+"\" onclick='WUI.showObjDlg(\""+dlg+"\",FormMode.forSet,"+optStr+");return false'>"+text+"</a>";}
function tokenName()
{var name="token";if(self.options.appName)
name+="_"+self.options.appName;if(g_args._test)
name+="_test";return name;}
function saveLoginToken(data)
{if(data._token)
{mCommon.setStorage(tokenName(),data._token);}}
function loadLoginToken()
{return mCommon.getStorage(tokenName());}
function deleteLoginToken()
{mCommon.delStorage(tokenName());}
self.tryAutoLogin=tryAutoLogin;function tryAutoLogin(onHandleLogin,reuseCmd)
{var ok=false;var ajaxOpt={async:false,noex:true};function handleAutoLogin(data)
{if(data===false)
return;if(onHandleLogin)
onHandleLogin.call(this,data);ok=true;}
if(reuseCmd!=null){self.callSvr(reuseCmd,handleAutoLogin,null,ajaxOpt);}
if(ok)
return ok;var token=loadLoginToken();if(token!=null)
{var postData={token:token};self.callSvr("login",handleAutoLogin,postData,ajaxOpt);}
if(ok)
return ok;self.options.onShowLogin();return ok;}
self.handleLogin=handleLogin;function handleLogin(data)
{g_data.userInfo=data;if(g_args.autoLogin||/android|ipad|iphone/i.test(navigator.userAgent))
saveLoginToken(data);self.showPage(self.options.pageHome);}
self.initClient=initClient;var plugins_={};function initClient()
{self.callSvrSync('initClient',function(data){plugins_=data.plugins||{};$.each(plugins_,function(k,e){if(e.js){var js=BASE_URL+'plugin/'+k+'/'+e.js;mCommon.loadScript(js,null,true);}});});}
window.Plugins={exists:function(pname){return plugins_[pname]!==undefined;},list:function(){return plugins_;}};self.setApp=setApp;function setApp(app)
{$.extend(self.options,app);}
self.logout=logout;function logout(dontReload)
{deleteLoginToken();g_data.userInfo=null;self.callSvr("logout",function(data){if(!dontReload)
mCommon.reloadSite();});}
self.tabClose=tabClose;function tabClose(idx)
{if(idx==null){var jtab=self.tabMain.tabs("getSelected");idx=self.tabMain.tabs("getTabIndex",jtab);}
self.tabMain.tabs("close",idx);}
self.getActivePage=getActivePage;function getActivePage()
{var pp=self.tabMain.tabs('getSelected');if(pp==null)
return $();var jpage=pp.find(".wui-page");return jpage;}
self.showLoading=showLoading;function showLoading()
{$('#block').css({width:$(document).width(),height:$(document).height(),'z-index':999999}).show();}
self.hideLoading=hideLoading;function hideLoading()
{$('#block').hide();}
function mainInit()
{self.tabMain=$('#my-tabMain');mCommon.assert(self.tabMain.size()==1,"require #my-tabMain as container");var opt=self.tabMain.tabs('options');$.extend(opt,{onSelect:function(title){var jpage=getActivePage();if(jpage.size()==0)
return;jpage.trigger('pageshow');},onBeforeClose:function(title){var jpage=getActivePage();if(jpage.size()==0)
return;jpage.trigger('pagedestroy');}});self.doSpecial(self.tabMain.find(".tabs-header"),".tabs-selected",function(){self.reloadPage();self.reloadDialog(true);});var tmr;$(window).on("resize",function(){if(tmr)
clearTimeout(tmr);tmr=setTimeout(function(){tmr=null;console.log("panel resize");var jpage=getActivePage();jpage.closest(".panel-body").panel("doLayout",true);},200);});function onResizePanel(){$(this).closest(".panel-body").panel("doLayout",true);}
$.fn.dialog.defaults.onResize=onResizePanel;}
$(mainInit);}
jdModule("jdcloud.wui.name",JdcloudWuiName);function JdcloudWuiName()
{var self=this;var mCommon=jdModule("jdcloud.common");window.WUI=jdModule("jdcloud.wui");$.extend(WUI,mCommon);$.each(["intSort","numberSort","callSvr","callSvrSync","app_alert","app_confirm","app_show",],function(){window[this]=WUI[this];});}
var m_dataCache={};$.fn.mycombobox=mycombobox;function mycombobox(force)
{var mCommon=jdModule("jdcloud.common");this.each(initCombobox);function initCombobox(i,o)
{var jo=$(o);var opts=jo.prop("opts_");if(!force&&opts&&!opts.dirty)
return;var optStr=jo.data("options");try{if(opts==null){if(optStr!=null){if(optStr.indexOf(":")>0){opts=eval("({"+optStr+"})");}
else{opts=eval("("+optStr+")");}}
else{opts={};}
jo.prop("opts_",opts);}}catch(e){alert("bad options for mycombobox: "+optStr);}
if(opts.jdEnumMap||opts.jdEnumList){loadOptions();}
else if(opts.url){loadOptions();if(!jo.attr("ondblclick"))
{jo.off("dblclick").dblclick(function(){if(!confirm("刷新数据?"))
return false;refresh();});}
jo.on("refresh",refresh);jo.on("markRefresh",markRefresh);jo.on("loadOptions",function(ev,param){loadOptions(param);});}
function loadOptions(param)
{jo.prop("value_",jo.val());jo.empty();$("<option value=''></option>").appendTo(jo);if(opts.jdEnumList){opts.jdEnumMap=mCommon.parseKvList(opts.jdEnumList,';',':');}
if(opts.jdEnumMap){$.each(opts.jdEnumMap,function(k,v){var jopt=$("<option></option>").attr("value",k).text(v).appendTo(jo);});}
if(opts.url==null)
return;var url=opts.url;if(url instanceof Function){if(url.length==0){url=url();}
else if(param!=null){url=url(param);}
else if(opts.url_){url=opts.url_;}
else{return;}
opts.url_=url;}
if(opts.dirty||m_dataCache[url]===undefined){self.callSvr(url,onLoadOptions);}
else{onLoadOptions(m_dataCache[url]);}
function onLoadOptions(data){m_dataCache[url]=data;applyData(data);jo.val(jo.prop("value_"));}}
function applyData(data)
{opts.dirty=false;function getText(row)
{if(opts.formatter){return opts.formatter(row);}
else if(opts.textField){return row[opts.textField];}
return row.id;}
if(opts.loadFilter){data=opts.loadFilter.call(this,data);}
var arr=$.isArray(data.d)?mCommon.rs2Array(data):$.isArray(data)?data:data.list;mCommon.assert($.isArray(arr),"bad data format for combobox");if(arr.length==0)
return;var names=Object.getOwnPropertyNames(arr[0]);if(opts.valueField==null){opts.valueField=names[0];}
if(opts.formatter==null&&opts.textField==null){opts.textField=names[1]||names[0];}
$.each(arr,function(i,row){var jopt=$("<option></option>").attr("value",row[opts.valueField]).text(getText(row)).appendTo(jo);});}
function refresh()
{markRefresh();loadOptions();}
function markRefresh()
{opts.dirty=true;}}}
function mycombobox_fixAsyncSetValue()
{var hook=$.valHooks["select"];$.valHooks["select"]={set:function(elem,value){elem.value_=value;return hook.set.apply(this,arguments);},get:function(elem){return hook.get.apply(this,arguments)||elem.value_;}}}
mycombobox_fixAsyncSetValue();